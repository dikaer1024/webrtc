# 视频转码工具使用文档

## 简介

`convert_to_mp4.py` 是一个功能强大的视频转码工具，可以将各种格式的视频文件转换为标准的 MP4 格式。该工具基于 FFmpeg，支持单文件转换和批量转换，并提供丰富的参数配置选项。

## 系统要求

### 必需依赖

- **Python 3.6+**
- **FFmpeg** - 视频处理核心工具

### 安装 FFmpeg

#### Ubuntu/Debian
```bash
sudo apt-get update
sudo apt-get install ffmpeg
```

#### macOS
```bash
brew install ffmpeg
```

#### Windows
从 [FFmpeg官网](https://ffmpeg.org/download.html) 下载并安装，或使用包管理器：
```powershell
choco install ffmpeg
# 或
scoop install ffmpeg
```

### 验证安装

```bash
ffmpeg -version
```

## 快速开始

### 基本用法

#### 1. 转换单个文件（自动生成输出文件名）

```bash
python3 convert_to_mp4.py input.avi
```

输出文件将自动命名为 `input.mp4`，保存在与输入文件相同的目录。

#### 2. 指定输出文件路径

```bash
python3 convert_to_mp4.py input.avi -o output.mp4
```

#### 3. 批量转换目录中的所有视频

```bash
python3 convert_to_mp4.py -d ./videos
```

脚本会自动扫描目录中的所有视频文件（排除已经是 MP4 的文件），并逐个转换。

## 支持的视频格式

脚本支持以下视频格式的转换：

- `.mp4` (已为MP4格式，批量模式会跳过)
- `.avi`
- `.mov`
- `.mkv`
- `.flv`
- `.wmv`
- `.webm`
- `.m4v`
- `.3gp`
- `.ts`
- `.mts`

## 参数说明

### 基本参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `input` | 输入视频文件路径（单文件模式） | `video.avi` |
| `-d, --directory` | 批量转换目录路径 | `-d ./videos` |
| `-o, --output` | 输出文件路径（仅单文件模式） | `-o output.mp4` |

### 质量与编码参数

| 参数 | 说明 | 可选值/格式 | 默认值 |
|------|------|------------|--------|
| `-q, --quality` | 质量预设 | `low`, `medium`, `high`, `veryhigh` | `medium` |
| `-r, --resolution` | 目标分辨率 | `1920x1080`, `1280x720` 等 | 保持原始 |
| `-b, --bitrate` | 视频码率 | `2000k`, `5M` 等 | 根据质量预设 |
| `--fps` | 目标帧率 | 整数，如 `30`, `60` | 保持原始 |

### 其他选项

| 参数 | 说明 |
|------|------|
| `--no-audio` | 不保留音频轨道 |
| `--overwrite` | 自动覆盖已存在的输出文件（不提示） |
| `--no-progress` | 不显示转换进度信息 |

## 质量预设说明

| 预设 | 编码速度 | 默认码率 | 适用场景 |
|------|---------|---------|---------|
| `low` | veryfast | 1000k | 快速转换，文件小，质量一般 |
| `medium` | medium | 2000k | 平衡质量和速度（推荐） |
| `high` | slow | 5000k | 高质量，文件较大 |
| `veryhigh` | veryslow | 10000k | 最高质量，文件很大，转换慢 |

## 使用示例

### 示例 1: 基本转换

```bash
# 将 webm 文件转换为 mp4
python3 convert_to_mp4.py video/det/det_video1.webm
```

### 示例 2: 高质量转换，指定分辨率

```bash
# 转换为 1080p 高质量视频
python3 convert_to_mp4.py input.avi -q high -r 1920x1080
```

### 示例 3: 自定义码率和帧率

```bash
# 设置码率为 5Mbps，帧率为 30fps
python3 convert_to_mp4.py input.avi -b 5000k --fps 30
```

### 示例 4: 转换为低分辨率视频（节省空间）

```bash
# 转换为 720p，低质量
python3 convert_to_mp4.py input.avi -q low -r 1280x720
```

### 示例 5: 移除音频

```bash
# 转换视频但不保留音频
python3 convert_to_mp4.py input.avi --no-audio
```

### 示例 6: 批量转换整个目录

```bash
# 批量转换 videos 目录下的所有视频
python3 convert_to_mp4.py -d ./videos

# 批量转换，高质量，自动覆盖
python3 convert_to_mp4.py -d ./videos -q high --overwrite
```

### 示例 7: 完整参数示例

```bash
# 高质量、指定分辨率、自定义码率、30fps、保留音频
python3 convert_to_mp4.py input.avi \
    -o output.mp4 \
    -q high \
    -r 1920x1080 \
    -b 5000k \
    --fps 30
```

## 输出信息说明

转换过程中，脚本会显示以下信息：

1. **视频信息**：原始视频的分辨率、编码格式、时长
2. **转换参数**：质量、分辨率、码率等设置
3. **实时进度**：转换进度百分比和已用时间
4. **转换结果**：成功/失败、耗时、输出文件大小

### 示例输出

```
🔍 检查 ffmpeg...
✅ ffmpeg 已安装

📹 处理视频: det_video1.webm
   原始信息: 1920x1080, 编码: vp8, 时长: 00:44
📤 输出文件: det_video1.mp4
⚙️  质量: medium, 分辨率: 保持原始, 码率: 2000k
   进度: 100.1% (00:44/00:44)
✅ 转换成功! 耗时: 126.7秒, 文件大小: 11.47MB

==================================================
📊 转换完成: 成功 1 个, 失败 0 个
==================================================
```

## 常见问题

### Q1: 提示 "ffmpeg 未安装"

**解决方案**：按照系统要求部分安装 FFmpeg。

### Q2: 转换速度很慢

**可能原因和解决方案**：
- 使用 `-q low` 或 `-q medium` 预设可以加快转换速度
- 降低分辨率（使用 `-r` 参数）可以减少处理时间
- 降低码率（使用 `-b` 参数）可以加快编码速度

### Q3: 输出文件太大

**解决方案**：
- 使用 `-q low` 或 `-q medium` 预设
- 降低分辨率：`-r 1280x720` 或 `-r 854x480`
- 降低码率：`-b 1000k` 或更低

### Q4: 转换后的视频质量不好

**解决方案**：
- 使用 `-q high` 或 `-q veryhigh` 预设
- 提高码率：`-b 5000k` 或更高
- 保持原始分辨率（不使用 `-r` 参数）

### Q5: 批量转换时如何跳过某些文件？

批量转换会自动跳过：
- 已经是 MP4 格式的文件
- 如果输出文件已存在且未使用 `--overwrite` 参数，会提示是否覆盖

### Q6: 如何只转换特定格式的文件？

目前脚本会转换目录中所有支持的视频格式。如果需要只转换特定格式，可以：
1. 将其他格式文件移到其他目录
2. 或者修改脚本中的 `find_video_files` 函数

## 技术细节

### 编码参数

- **视频编码器**：H.264 (libx264)
- **音频编码器**：AAC (128kbps)
- **像素格式**：yuv420p（兼容性最好）
- **编码预设**：根据质量参数选择（veryfast/medium/slow/veryslow）

### 性能优化建议

1. **快速转换**：使用 `-q low` 和较低分辨率
2. **平衡模式**：使用 `-q medium`（推荐）
3. **高质量**：使用 `-q high` 或 `-q veryhigh`，但转换时间会显著增加

## 注意事项

1. **文件覆盖**：默认情况下，如果输出文件已存在，脚本会提示是否覆盖。使用 `--overwrite` 可自动覆盖。

2. **磁盘空间**：确保有足够的磁盘空间，转换后的文件大小取决于质量设置。

3. **转换时间**：转换时间取决于视频长度、分辨率和质量设置。高质量转换可能需要较长时间。

4. **原始文件**：脚本不会删除原始文件，转换后的文件会保存在同一目录或指定位置。

5. **批量转换**：批量转换时，如果某个文件转换失败，脚本会继续处理其他文件，最后显示成功和失败的统计信息。

## 错误处理

如果转换失败，脚本会：
1. 显示错误信息
2. 在批量模式下继续处理其他文件
3. 最后显示成功和失败的统计

常见错误：
- **文件不存在**：检查输入文件路径是否正确
- **权限不足**：确保对输入和输出目录有读写权限
- **FFmpeg 错误**：检查 FFmpeg 是否正确安装，输入文件是否损坏

## 许可证

本工具为项目内部使用工具，基于 FFmpeg 进行开发。

## 更新日志

### v1.0.0
- 初始版本
- 支持单文件和批量转换
- 支持质量预设和自定义参数
- 实时进度显示

## 联系与支持

如有问题或建议，请联系项目维护团队。

