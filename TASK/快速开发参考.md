# TASK模块快速开发参考

**⚡ 快速索引** | 最后更新：2025-10-23

---

## 🎯 核心待办事项（按优先级）

### 🔴 P0 - 必须完成（阻塞交付）

```
[ ] 1. RTMP视频推流 (2-3天)
    └─ 让前端能看到AI检测后的实时视频
    └─ 文件: RTMPEncoder.cpp/h
    └─ 配置: [rtmp] enable=true, rtmp_url=...
    
[ ] 2. 区域检测（ROI） (1-2天)
    └─ 支持多边形区域过滤
    └─ 文件: Detech.cpp (添加AlarmRegion)
    └─ 配置: [alarm_region_1] polygon=...
    
[ ] 3. TaskManager进程管理 (2-3天)
    └─ 提供HTTP API让前端控制启停
    └─ 文件: TaskManager.cpp
    └─ API: POST /task/start, /task/stop, GET /task/status
```

### 🟡 P1 - 重要功能（提升用户体验）

```
[ ] 4. 多模型动态加载 (1-2天)
    └─ 运行时切换模型，无需重启
    
[ ] 5. 类别文件加载 (0.5天)
    └─ 支持中文类别名称显示
    
[ ] 6. HTTP API完善 (1天)
    └─ 模型管理、配置管理接口
```

### 🟢 P2 - 优化功能（锦上添花）

```
[ ] 7. 配置文件生成器 (1天)
    └─ JSON → INI自动生成
    
[ ] 8. 资源释放完善 (0.5天)
    └─ 防止内存泄漏
```

---

## 📝 配置文件模板

```ini
# config/task123.ini

[video]
source=rtsp://admin:Admin123@192.168.1.100:554/stream1
enable=true

[model]
model_path=models/SafeHat.onnx
class_file=models/SafeHat_cn.txt
confidence_threshold=0.5

[rtmp]
enable=true
rtmp_url=rtmp://localhost:1935/live/task123

[alarm]
enable=true
hook_url=http://localhost:8080/api/alarm/callback/123
confidence_threshold=0.6
cooldown_time=10

[alarm_region_1]
enable=true
region_id=entrance
polygon=100,100;500,100;500,400;100,400
target_classes=0
```

---

## 🔌 关键API接口

### TASK → DEVICE（告警回调）

```bash
# TASK发送告警到后端
POST http://localhost:8080/api/alarm/callback/123
Content-Type: application/json

{
  "task_id": 123,
  "detections": [
    {
      "class_id": 0,
      "class_name": "person",
      "confidence": 0.85,
      "bbox": {"x": 100, "y": 200, "w": 50, "h": 100}
    }
  ],
  "region_id": "entrance",
  "timestamp": "2025-10-23 14:30:00"
}
```

### WEB → TASK（任务控制）

```bash
# 前端启动TASK
POST http://localhost:8090/task/start
{"task_id": 123, "config_path": "config/task123.ini"}

# 前端停止TASK
POST http://localhost:8090/task/stop
{"task_id": 123}

# 前端查询状态
GET http://localhost:8090/task/status?task_id=123
```

---

## 🚀 快速启动流程

### 1. 启动流媒体服务器
```bash
docker run -d -p 1935:1935 -p 8080:8080 ossrs/srs:5
```

### 2. 启动告警接收服务（测试用）
```bash
cd TASK
python test_alarm_receiver.py
# 监听在 http://localhost:5000
```

### 3. 编译TASK
```bash
cd TASK
cmake --build build --config Release
```

### 4. 运行TASK
```bash
.\build\Release\TASK.exe config\test.ini
```

### 5. 验证推流（实现RTMP后）
```bash
ffplay rtmp://localhost:1935/live/task123
```

---

## 🐛 常见问题速查

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| RTSP连接失败 | 摄像头地址错误 | 检查 `config.ini` 中 `source=` |
| 推流失败 | SRS未启动 | `docker ps \| grep srs` |
| 告警未触发 | `enable_alarm=false` | 检查 `[features]` 和 `[alarm]` 两处配置 |
| 中文乱码 | 文件编码非UTF-8 | `iconv -f GBK -t UTF-8` 转换 |
| 内存泄漏 | FFmpeg资源未释放 | 调用 `avformat_close_input()` |

---

## 📊 系统架构速览

```
摄像头 RTSP → VIDEO FFmpeg → RTMP → 流媒体 → WEB前端
              ↓ 抽帧                          ↓
            TASK AI推理                   实时画框
              ↓ 检测结果
            DEVICE规则引擎
              ↓ 告警分发
         企业微信/钉钉/邮件
```

---

## 🔧 核心代码片段

### RTMP推流初始化
```cpp
RTMPEncoder* encoder = new RTMPEncoder();
encoder->init("rtmp://localhost:1935/live/task123", 1920, 1080, 25);

// 在视频循环中
encoder->encodeAndPush(frame);
```

### 区域检测判断
```cpp
bool isInRegion(const DetectObject& obj, const AlarmRegion& region) {
    cv::Point center(obj.box.x + obj.box.width/2, 
                     obj.box.y + obj.box.height/2);
    return cv::pointPolygonTest(region.polygon, center, false) >= 0;
}
```

### 异步告警发送
```cpp
std::thread([callback, detections, timestamp]() {
    callback->sendAlarm(123, detections, "region_main", timestamp);
}).detach();
```

---

## 📈 进度跟踪

- [ ] 第1周：RTMP推流 + 区域检测
- [ ] 第2周：TaskManager + 多模型支持
- [ ] 第3周：系统集成测试 + 文档完善

---

## 📞 紧急联系

- **GPU加速问题**: 暂时搁置，CPU模式已满足需求
- **编码问题**: 所有源文件使用 UTF-8（无BOM）
- **依赖问题**: 使用 vcpkg 安装所有C++库

---

**💡 提示**: 详细内容请参考《TASK模块开发指引.md》


**⚡ 快速索引** | 最后更新：2025-10-23

---

## 🎯 核心待办事项（按优先级）

### 🔴 P0 - 必须完成（阻塞交付）

```
[ ] 1. RTMP视频推流 (2-3天)
    └─ 让前端能看到AI检测后的实时视频
    └─ 文件: RTMPEncoder.cpp/h
    └─ 配置: [rtmp] enable=true, rtmp_url=...
    
[ ] 2. 区域检测（ROI） (1-2天)
    └─ 支持多边形区域过滤
    └─ 文件: Detech.cpp (添加AlarmRegion)
    └─ 配置: [alarm_region_1] polygon=...
    
[ ] 3. TaskManager进程管理 (2-3天)
    └─ 提供HTTP API让前端控制启停
    └─ 文件: TaskManager.cpp
    └─ API: POST /task/start, /task/stop, GET /task/status
```

### 🟡 P1 - 重要功能（提升用户体验）

```
[ ] 4. 多模型动态加载 (1-2天)
    └─ 运行时切换模型，无需重启
    
[ ] 5. 类别文件加载 (0.5天)
    └─ 支持中文类别名称显示
    
[ ] 6. HTTP API完善 (1天)
    └─ 模型管理、配置管理接口
```

### 🟢 P2 - 优化功能（锦上添花）

```
[ ] 7. 配置文件生成器 (1天)
    └─ JSON → INI自动生成
    
[ ] 8. 资源释放完善 (0.5天)
    └─ 防止内存泄漏
```

---

## 📝 配置文件模板

```ini
# config/task123.ini

[video]
source=rtsp://admin:Admin123@192.168.1.100:554/stream1
enable=true

[model]
model_path=models/SafeHat.onnx
class_file=models/SafeHat_cn.txt
confidence_threshold=0.5

[rtmp]
enable=true
rtmp_url=rtmp://localhost:1935/live/task123

[alarm]
enable=true
hook_url=http://localhost:8080/api/alarm/callback/123
confidence_threshold=0.6
cooldown_time=10

[alarm_region_1]
enable=true
region_id=entrance
polygon=100,100;500,100;500,400;100,400
target_classes=0
```

---

## 🔌 关键API接口

### TASK → DEVICE（告警回调）

```bash
# TASK发送告警到后端
POST http://localhost:8080/api/alarm/callback/123
Content-Type: application/json

{
  "task_id": 123,
  "detections": [
    {
      "class_id": 0,
      "class_name": "person",
      "confidence": 0.85,
      "bbox": {"x": 100, "y": 200, "w": 50, "h": 100}
    }
  ],
  "region_id": "entrance",
  "timestamp": "2025-10-23 14:30:00"
}
```

### WEB → TASK（任务控制）

```bash
# 前端启动TASK
POST http://localhost:8090/task/start
{"task_id": 123, "config_path": "config/task123.ini"}

# 前端停止TASK
POST http://localhost:8090/task/stop
{"task_id": 123}

# 前端查询状态
GET http://localhost:8090/task/status?task_id=123
```

---

## 🚀 快速启动流程

### 1. 启动流媒体服务器
```bash
docker run -d -p 1935:1935 -p 8080:8080 ossrs/srs:5
```

### 2. 启动告警接收服务（测试用）
```bash
cd TASK
python test_alarm_receiver.py
# 监听在 http://localhost:5000
```

### 3. 编译TASK
```bash
cd TASK
cmake --build build --config Release
```

### 4. 运行TASK
```bash
.\build\Release\TASK.exe config\test.ini
```

### 5. 验证推流（实现RTMP后）
```bash
ffplay rtmp://localhost:1935/live/task123
```

---

## 🐛 常见问题速查

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| RTSP连接失败 | 摄像头地址错误 | 检查 `config.ini` 中 `source=` |
| 推流失败 | SRS未启动 | `docker ps \| grep srs` |
| 告警未触发 | `enable_alarm=false` | 检查 `[features]` 和 `[alarm]` 两处配置 |
| 中文乱码 | 文件编码非UTF-8 | `iconv -f GBK -t UTF-8` 转换 |
| 内存泄漏 | FFmpeg资源未释放 | 调用 `avformat_close_input()` |

---

## 📊 系统架构速览

```
摄像头 RTSP → VIDEO FFmpeg → RTMP → 流媒体 → WEB前端
              ↓ 抽帧                          ↓
            TASK AI推理                   实时画框
              ↓ 检测结果
            DEVICE规则引擎
              ↓ 告警分发
         企业微信/钉钉/邮件
```

---

## 🔧 核心代码片段

### RTMP推流初始化
```cpp
RTMPEncoder* encoder = new RTMPEncoder();
encoder->init("rtmp://localhost:1935/live/task123", 1920, 1080, 25);

// 在视频循环中
encoder->encodeAndPush(frame);
```

### 区域检测判断
```cpp
bool isInRegion(const DetectObject& obj, const AlarmRegion& region) {
    cv::Point center(obj.box.x + obj.box.width/2, 
                     obj.box.y + obj.box.height/2);
    return cv::pointPolygonTest(region.polygon, center, false) >= 0;
}
```

### 异步告警发送
```cpp
std::thread([callback, detections, timestamp]() {
    callback->sendAlarm(123, detections, "region_main", timestamp);
}).detach();
```

---

## 📈 进度跟踪

- [ ] 第1周：RTMP推流 + 区域检测
- [ ] 第2周：TaskManager + 多模型支持
- [ ] 第3周：系统集成测试 + 文档完善

---

## 📞 紧急联系

- **GPU加速问题**: 暂时搁置，CPU模式已满足需求
- **编码问题**: 所有源文件使用 UTF-8（无BOM）
- **依赖问题**: 使用 vcpkg 安装所有C++库

---

**💡 提示**: 详细内容请参考《TASK模块开发指引.md》

 

**⚡ 快速索引** | 最后更新：2025-10-23

---

## 🎯 核心待办事项（按优先级）

### 🔴 P0 - 必须完成（阻塞交付）

```
[ ] 1. RTMP视频推流 (2-3天)
    └─ 让前端能看到AI检测后的实时视频
    └─ 文件: RTMPEncoder.cpp/h
    └─ 配置: [rtmp] enable=true, rtmp_url=...
    
[ ] 2. 区域检测（ROI） (1-2天)
    └─ 支持多边形区域过滤
    └─ 文件: Detech.cpp (添加AlarmRegion)
    └─ 配置: [alarm_region_1] polygon=...
    
[ ] 3. TaskManager进程管理 (2-3天)
    └─ 提供HTTP API让前端控制启停
    └─ 文件: TaskManager.cpp
    └─ API: POST /task/start, /task/stop, GET /task/status
```

### 🟡 P1 - 重要功能（提升用户体验）

```
[ ] 4. 多模型动态加载 (1-2天)
    └─ 运行时切换模型，无需重启
    
[ ] 5. 类别文件加载 (0.5天)
    └─ 支持中文类别名称显示
    
[ ] 6. HTTP API完善 (1天)
    └─ 模型管理、配置管理接口
```

### 🟢 P2 - 优化功能（锦上添花）

```
[ ] 7. 配置文件生成器 (1天)
    └─ JSON → INI自动生成
    
[ ] 8. 资源释放完善 (0.5天)
    └─ 防止内存泄漏
```

---

## 📝 配置文件模板

```ini
# config/task123.ini

[video]
source=rtsp://admin:Admin123@192.168.1.100:554/stream1
enable=true

[model]
model_path=models/SafeHat.onnx
class_file=models/SafeHat_cn.txt
confidence_threshold=0.5

[rtmp]
enable=true
rtmp_url=rtmp://localhost:1935/live/task123

[alarm]
enable=true
hook_url=http://localhost:8080/api/alarm/callback/123
confidence_threshold=0.6
cooldown_time=10

[alarm_region_1]
enable=true
region_id=entrance
polygon=100,100;500,100;500,400;100,400
target_classes=0
```

---

## 🔌 关键API接口

### TASK → DEVICE（告警回调）

```bash
# TASK发送告警到后端
POST http://localhost:8080/api/alarm/callback/123
Content-Type: application/json

{
  "task_id": 123,
  "detections": [
    {
      "class_id": 0,
      "class_name": "person",
      "confidence": 0.85,
      "bbox": {"x": 100, "y": 200, "w": 50, "h": 100}
    }
  ],
  "region_id": "entrance",
  "timestamp": "2025-10-23 14:30:00"
}
```

### WEB → TASK（任务控制）

```bash
# 前端启动TASK
POST http://localhost:8090/task/start
{"task_id": 123, "config_path": "config/task123.ini"}

# 前端停止TASK
POST http://localhost:8090/task/stop
{"task_id": 123}

# 前端查询状态
GET http://localhost:8090/task/status?task_id=123
```

---

## 🚀 快速启动流程

### 1. 启动流媒体服务器
```bash
docker run -d -p 1935:1935 -p 8080:8080 ossrs/srs:5
```

### 2. 启动告警接收服务（测试用）
```bash
cd TASK
python test_alarm_receiver.py
# 监听在 http://localhost:5000
```

### 3. 编译TASK
```bash
cd TASK
cmake --build build --config Release
```

### 4. 运行TASK
```bash
.\build\Release\TASK.exe config\test.ini
```

### 5. 验证推流（实现RTMP后）
```bash
ffplay rtmp://localhost:1935/live/task123
```

---

## 🐛 常见问题速查

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| RTSP连接失败 | 摄像头地址错误 | 检查 `config.ini` 中 `source=` |
| 推流失败 | SRS未启动 | `docker ps \| grep srs` |
| 告警未触发 | `enable_alarm=false` | 检查 `[features]` 和 `[alarm]` 两处配置 |
| 中文乱码 | 文件编码非UTF-8 | `iconv -f GBK -t UTF-8` 转换 |
| 内存泄漏 | FFmpeg资源未释放 | 调用 `avformat_close_input()` |

---

## 📊 系统架构速览

```
摄像头 RTSP → VIDEO FFmpeg → RTMP → 流媒体 → WEB前端
              ↓ 抽帧                          ↓
            TASK AI推理                   实时画框
              ↓ 检测结果
            DEVICE规则引擎
              ↓ 告警分发
         企业微信/钉钉/邮件
```

---

## 🔧 核心代码片段

### RTMP推流初始化
```cpp
RTMPEncoder* encoder = new RTMPEncoder();
encoder->init("rtmp://localhost:1935/live/task123", 1920, 1080, 25);

// 在视频循环中
encoder->encodeAndPush(frame);
```

### 区域检测判断
```cpp
bool isInRegion(const DetectObject& obj, const AlarmRegion& region) {
    cv::Point center(obj.box.x + obj.box.width/2, 
                     obj.box.y + obj.box.height/2);
    return cv::pointPolygonTest(region.polygon, center, false) >= 0;
}
```

### 异步告警发送
```cpp
std::thread([callback, detections, timestamp]() {
    callback->sendAlarm(123, detections, "region_main", timestamp);
}).detach();
```

---

## 📈 进度跟踪

- [ ] 第1周：RTMP推流 + 区域检测
- [ ] 第2周：TaskManager + 多模型支持
- [ ] 第3周：系统集成测试 + 文档完善

---

## 📞 紧急联系

- **GPU加速问题**: 暂时搁置，CPU模式已满足需求
- **编码问题**: 所有源文件使用 UTF-8（无BOM）
- **依赖问题**: 使用 vcpkg 安装所有C++库

---

**💡 提示**: 详细内容请参考《TASK模块开发指引.md》


**⚡ 快速索引** | 最后更新：2025-10-23

---

## 🎯 核心待办事项（按优先级）

### 🔴 P0 - 必须完成（阻塞交付）

```
[ ] 1. RTMP视频推流 (2-3天)
    └─ 让前端能看到AI检测后的实时视频
    └─ 文件: RTMPEncoder.cpp/h
    └─ 配置: [rtmp] enable=true, rtmp_url=...
    
[ ] 2. 区域检测（ROI） (1-2天)
    └─ 支持多边形区域过滤
    └─ 文件: Detech.cpp (添加AlarmRegion)
    └─ 配置: [alarm_region_1] polygon=...
    
[ ] 3. TaskManager进程管理 (2-3天)
    └─ 提供HTTP API让前端控制启停
    └─ 文件: TaskManager.cpp
    └─ API: POST /task/start, /task/stop, GET /task/status
```

### 🟡 P1 - 重要功能（提升用户体验）

```
[ ] 4. 多模型动态加载 (1-2天)
    └─ 运行时切换模型，无需重启
    
[ ] 5. 类别文件加载 (0.5天)
    └─ 支持中文类别名称显示
    
[ ] 6. HTTP API完善 (1天)
    └─ 模型管理、配置管理接口
```

### 🟢 P2 - 优化功能（锦上添花）

```
[ ] 7. 配置文件生成器 (1天)
    └─ JSON → INI自动生成
    
[ ] 8. 资源释放完善 (0.5天)
    └─ 防止内存泄漏
```

---

## 📝 配置文件模板

```ini
# config/task123.ini

[video]
source=rtsp://admin:Admin123@192.168.1.100:554/stream1
enable=true

[model]
model_path=models/SafeHat.onnx
class_file=models/SafeHat_cn.txt
confidence_threshold=0.5

[rtmp]
enable=true
rtmp_url=rtmp://localhost:1935/live/task123

[alarm]
enable=true
hook_url=http://localhost:8080/api/alarm/callback/123
confidence_threshold=0.6
cooldown_time=10

[alarm_region_1]
enable=true
region_id=entrance
polygon=100,100;500,100;500,400;100,400
target_classes=0
```

---

## 🔌 关键API接口

### TASK → DEVICE（告警回调）

```bash
# TASK发送告警到后端
POST http://localhost:8080/api/alarm/callback/123
Content-Type: application/json

{
  "task_id": 123,
  "detections": [
    {
      "class_id": 0,
      "class_name": "person",
      "confidence": 0.85,
      "bbox": {"x": 100, "y": 200, "w": 50, "h": 100}
    }
  ],
  "region_id": "entrance",
  "timestamp": "2025-10-23 14:30:00"
}
```

### WEB → TASK（任务控制）

```bash
# 前端启动TASK
POST http://localhost:8090/task/start
{"task_id": 123, "config_path": "config/task123.ini"}

# 前端停止TASK
POST http://localhost:8090/task/stop
{"task_id": 123}

# 前端查询状态
GET http://localhost:8090/task/status?task_id=123
```

---

## 🚀 快速启动流程

### 1. 启动流媒体服务器
```bash
docker run -d -p 1935:1935 -p 8080:8080 ossrs/srs:5
```

### 2. 启动告警接收服务（测试用）
```bash
cd TASK
python test_alarm_receiver.py
# 监听在 http://localhost:5000
```

### 3. 编译TASK
```bash
cd TASK
cmake --build build --config Release
```

### 4. 运行TASK
```bash
.\build\Release\TASK.exe config\test.ini
```

### 5. 验证推流（实现RTMP后）
```bash
ffplay rtmp://localhost:1935/live/task123
```

---

## 🐛 常见问题速查

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| RTSP连接失败 | 摄像头地址错误 | 检查 `config.ini` 中 `source=` |
| 推流失败 | SRS未启动 | `docker ps \| grep srs` |
| 告警未触发 | `enable_alarm=false` | 检查 `[features]` 和 `[alarm]` 两处配置 |
| 中文乱码 | 文件编码非UTF-8 | `iconv -f GBK -t UTF-8` 转换 |
| 内存泄漏 | FFmpeg资源未释放 | 调用 `avformat_close_input()` |

---

## 📊 系统架构速览

```
摄像头 RTSP → VIDEO FFmpeg → RTMP → 流媒体 → WEB前端
              ↓ 抽帧                          ↓
            TASK AI推理                   实时画框
              ↓ 检测结果
            DEVICE规则引擎
              ↓ 告警分发
         企业微信/钉钉/邮件
```

---

## 🔧 核心代码片段

### RTMP推流初始化
```cpp
RTMPEncoder* encoder = new RTMPEncoder();
encoder->init("rtmp://localhost:1935/live/task123", 1920, 1080, 25);

// 在视频循环中
encoder->encodeAndPush(frame);
```

### 区域检测判断
```cpp
bool isInRegion(const DetectObject& obj, const AlarmRegion& region) {
    cv::Point center(obj.box.x + obj.box.width/2, 
                     obj.box.y + obj.box.height/2);
    return cv::pointPolygonTest(region.polygon, center, false) >= 0;
}
```

### 异步告警发送
```cpp
std::thread([callback, detections, timestamp]() {
    callback->sendAlarm(123, detections, "region_main", timestamp);
}).detach();
```

---

## 📈 进度跟踪

- [ ] 第1周：RTMP推流 + 区域检测
- [ ] 第2周：TaskManager + 多模型支持
- [ ] 第3周：系统集成测试 + 文档完善

---

## 📞 紧急联系

- **GPU加速问题**: 暂时搁置，CPU模式已满足需求
- **编码问题**: 所有源文件使用 UTF-8（无BOM）
- **依赖问题**: 使用 vcpkg 安装所有C++库

---

**💡 提示**: 详细内容请参考《TASK模块开发指引.md》

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 