<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TASKæ¨¡å— - ä½å»¶è¿ŸAIç›‘æ§æ’­æ”¾å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/flv.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .player-wrapper {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #videoContainer {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        video {
            width: 100%;
            height: auto;
            display: block;
        }
        .info-panel {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .info-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        .info-card p {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }
        .status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        .status.playing {
            background: #4CAF50;
            color: white;
            animation: pulse 2s infinite;
        }
        .status.error {
            background: #f44336;
            color: white;
        }
        .status.loading {
            background: #ff9800;
            color: white;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        .stat-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ TASKæ¨¡å— - è¶…ä½å»¶è¿ŸAIå®æ—¶ç›‘æ§</h1>
        
        <div class="player-wrapper">
            <div id="videoContainer">
                <video id="videoElement" controls autoplay muted></video>
            </div>
            
            <div class="info-panel">
                <div class="info-card">
                    <h3>æ’­æ”¾çŠ¶æ€</h3>
                    <p><span id="status" class="status loading">æ­£åœ¨è¿æ¥...</span></p>
                </div>
                <div class="info-card">
                    <h3>æµåœ°å€</h3>
                    <p style="font-size: 13px;">http://localhost/live/stream_test.live.flv</p>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="latency">--</div>
                    <div class="stat-label">å»¶è¿Ÿ (ms)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="fps">--</div>
                    <div class="stat-label">å¸§ç‡ (FPS)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="resolution">--</div>
                    <div class="stat-label">åˆ†è¾¨ç‡</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        if (flvjs.isSupported()) {
            var videoElement = document.getElementById('videoElement');
            var statusElement = document.getElementById('status');
            var latencyElement = document.getElementById('latency');
            var fpsElement = document.getElementById('fps');
            var resolutionElement = document.getElementById('resolution');
            
            // è¶…ä½å»¶è¿Ÿé…ç½®
            var flvPlayer = flvjs.createPlayer({
                type: 'flv',
                url: 'http://localhost/live/stream_test.live.flv',
                isLive: true,
                hasAudio: false,
                cors: true
            }, {
                enableWorker: false,              // ç¦ç”¨Workerä»¥å‡å°‘å»¶è¿Ÿ
                enableStashBuffer: false,         // ç¦ç”¨ç¼“å†²
                stashInitialSize: 64,             // æœ€å°åˆå§‹ç¼“å†² (é™ä½åˆ°64)
                lazyLoad: false,                  // ç¦ç”¨æ‡’åŠ è½½
                lazyLoadMaxDuration: 0,           // æœ€å°æ‡’åŠ è½½æ—¶é—´
                autoCleanupSourceBuffer: true,    // è‡ªåŠ¨æ¸…ç†ç¼“å†²
                fixAudioTimestampGap: false       // ä¸ä¿®å¤éŸ³é¢‘æ—¶é—´æˆ³
            });
            
            flvPlayer.attachMediaElement(videoElement);
            flvPlayer.load();
            
            // åª’ä½“ä¿¡æ¯äº‹ä»¶
            flvPlayer.on(flvjs.Events.MEDIA_INFO, function(info) {
                console.log('åª’ä½“ä¿¡æ¯:', info);
                if (info.width && info.height) {
                    resolutionElement.textContent = info.width + 'x' + info.height;
                }
            });
            
            // é”™è¯¯å¤„ç†
            flvPlayer.on(flvjs.Events.ERROR, function(errorType, errorDetail, errorInfo) {
                console.error('æ’­æ”¾é”™è¯¯:', errorType, errorDetail, errorInfo);
                statusElement.textContent = 'æ’­æ”¾å¤±è´¥: ' + errorDetail;
                statusElement.className = 'status error';
            });
            
            // æ’­æ”¾å¼€å§‹
            videoElement.addEventListener('playing', function() {
                statusElement.textContent = 'æ­£åœ¨æ’­æ”¾';
                statusElement.className = 'status playing';
                console.log('å¼€å§‹æ’­æ”¾');
            });
            
            // å°è¯•æ’­æ”¾
            flvPlayer.play().catch(function(e) {
                console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®:', e);
                statusElement.textContent = 'ç‚¹å‡»æ’­æ”¾';
                statusElement.className = 'status loading';
            });
            
            // å®æ—¶ç›‘æ§å»¶è¿Ÿå’Œå¸§ç‡
            let lastTime = Date.now();
            let frameCount = 0;
            
            videoElement.addEventListener('timeupdate', function() {
                // è®¡ç®—ç¼“å†²å»¶è¿Ÿ
                if (videoElement.buffered.length > 0) {
                    const bufferedEnd = videoElement.buffered.end(0);
                    const currentTime = videoElement.currentTime;
                    const latency = Math.round((bufferedEnd - currentTime) * 1000);
                    latencyElement.textContent = latency;
                    
                    // ğŸš€ æ¿€è¿›çš„å»¶è¿Ÿæ§åˆ¶ - ä¿æŒåœ¨500msä»¥å†…
                    if (latency > 500) {  // å»¶è¿Ÿè¶…è¿‡500msç«‹å³è·³è½¬
                        videoElement.currentTime = bufferedEnd - 0.2;  // ä¿æŒ200msç¼“å†²
                        console.log('å»¶è¿Ÿè¿‡é«˜ï¼Œè·³è½¬åˆ°æœ€æ–°å¸§:', latency + 'ms');
                    }
                }
                
                // è®¡ç®—å¸§ç‡
                frameCount++;
                const now = Date.now();
                if (now - lastTime >= 1000) {
                    fpsElement.textContent = frameCount;
                    frameCount = 0;
                    lastTime = now;
                }
            });
            
            // ğŸ¯ å®šæœŸæ¸…ç†ç¼“å†²åŒºï¼ˆæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
            setInterval(function() {
                if (videoElement.buffered.length > 0) {
                    const bufferedEnd = videoElement.buffered.end(0);
                    const currentTime = videoElement.currentTime;
                    const latency = (bufferedEnd - currentTime) * 1000;
                    
                    // å¦‚æœå»¶è¿Ÿè¶…è¿‡400msï¼Œå¼ºåˆ¶è·³è½¬
                    if (latency > 400) {
                        videoElement.currentTime = bufferedEnd - 0.15;
                        console.log('å®šæœŸæ¸…ç†: è·³è½¬åˆ°æœ€æ–°å¸§');
                    }
                }
            }, 2000);
            
        } else {
            alert('æµè§ˆå™¨ä¸æ”¯æŒFLV.jsæ’­æ”¾\nè¯·ä½¿ç”¨Chromeã€Edgeæˆ–Firefoxæµè§ˆå™¨');
        }
    </script>
</body>
</html>
