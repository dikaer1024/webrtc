# EasyAIoT 50è·¯æ‘„åƒå¤´AIæ£€æµ‹ç³»ç»Ÿ - å®Œæ•´å¼€å‘è·¯çº¿å›¾

**ç›®æ ‡**: å®ç°50è·¯æ‘„åƒå¤´çš„å‰ç«¯é…ç½®ã€AIæ£€æµ‹ã€å®æ—¶æ’­æ”¾å’Œå‘Šè­¦ç®¡ç†

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-24

---

## ğŸ¯ ç³»ç»Ÿæ¶æ„å¯¹æ¯”

### å½“å‰æ¶æ„ï¼ˆVIDEOæ¨¡å—ï¼‰

```
æ‘„åƒå¤´(RTSP) â†’ VIDEO(Python) â†’ FFmpegè½¬ç  â†’ RTMPæ¨æµ â†’ ZLMediaKit â†’ HTTP-FLV â†’ å‰ç«¯æ’­æ”¾
                     â†“
                åªæ˜¯è½¬å‘è§†é¢‘
                æ²¡æœ‰AIå¤„ç†
```

**å‰ç«¯é¡µé¢**ï¼š`WEB/src/views/camera/index.vue`
- âœ… æ‘„åƒå¤´åˆ—è¡¨å±•ç¤º
- âœ… å¯åŠ¨/åœæ­¢RTSPè½¬å‘
- âœ… è§†é¢‘æ’­æ”¾ï¼ˆDialogPlayerï¼‰
- âœ… æµçŠ¶æ€ç›‘æ§
- âš ï¸ **æ²¡æœ‰AIæ£€æµ‹åŠŸèƒ½**

---

### ç›®æ ‡æ¶æ„ï¼ˆTASKæ¨¡å—ï¼‰

```
50è·¯æ‘„åƒå¤´(RTSP) â†’ TaskManager(C++) â†’ 50ä¸ªTASKå®ä¾‹(C++)
                         â†“                    â†“
                    HTTP APIç®¡ç†          YOLOæ¨ç†+ç”»æ¡†
                    (ç«¯å£7000)                 â†“
                         â†“              RTMPæ¨æµ(å¸¦æ£€æµ‹æ¡†)
                         â†“                    â†“
                    å‰ç«¯é…ç½®ç®¡ç†          ZLMediaKit(80)
                         â†“                    â†“
                    å¯åŠ¨/åœæ­¢/æŸ¥è¯¢        HTTP-FLVæ’­æ”¾
                         â†“                    â†“
                    å‘Šè­¦è§„åˆ™é…ç½®          å‰ç«¯è§†é¢‘å¢™å±•ç¤º
```

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… **AIå®æ—¶æ£€æµ‹**ï¼ˆYOLOv11ï¼‰
- âœ… **æ£€æµ‹æ¡†æ ‡æ³¨**ï¼ˆOpenCVï¼‰
- âœ… **åŒºåŸŸå‘Šè­¦**ï¼ˆå¤šè¾¹å½¢ROIï¼‰
- âœ… **å‰ç«¯ç®¡ç†**ï¼ˆTaskManager APIï¼‰
- âœ… **50è·¯å¹¶å‘**ï¼ˆå¤šTASKå®ä¾‹ï¼‰

---

## ğŸ“Š ä½ çš„å‰ç«¯é¡µé¢é•¿è¿™æ ·ï¼ˆç°çŠ¶åˆ†æï¼‰

### 1. æ‘„åƒå¤´ç®¡ç†é¡µé¢ (`camera/index.vue`)

**è¡¨æ ¼åˆ—**ï¼š
| åˆ—å | æ•°æ® | è¯´æ˜ |
|------|------|------|
| è®¾å¤‡ID | `id` | å”¯ä¸€æ ‡è¯† |
| è®¾å¤‡åç§° | `name` | ç”¨æˆ·è‡ªå®šä¹‰ |
| åœ¨çº¿çŠ¶æ€ | `online` | ç»¿è‰²/çº¢è‰²æ ‡ç­¾ |
| æ‹‰æµåœ°å€ | `source` | RTSP URL |
| æ¨æµåœ°å€ | `rtmp_stream` | RTMP URLï¼ˆVIDEOæ¨¡å—æ¨é€ï¼‰ |
| **æ’­æ”¾åœ°å€** | `http_stream` | **HTTP-FLVï¼ˆå‰ç«¯æ’­æ”¾ï¼‰** |
| æµçŠ¶æ€ | `stream_status` | running/stopped/error |

**æ“ä½œæŒ‰é’®**ï¼š
- ğŸ¬ æ’­æ”¾RTMPæµ
- â–¶ï¸ å¯åŠ¨RTSPè½¬å‘ â†’ è°ƒç”¨ `startStreamForwarding(device_id)`
- â¸ï¸ åœæ­¢RTSPè½¬å‘ â†’ è°ƒç”¨ `stopStreamForwarding(device_id)`
- âœï¸ ç¼–è¾‘ / ğŸ—‘ï¸ åˆ é™¤

**åç«¯API**ï¼š
```typescript
// WEB/src/api/device/camera.ts
startStreamForwarding(device_id)  // POST /video/camera/device/{id}/stream/start
stopStreamForwarding(device_id)   // POST /video/camera/device/{id}/stream/stop
getStreamStatus(device_id)        // GET  /video/camera/device/{id}/stream/status
```

---

### 2. è§†é¢‘æ’­æ”¾å™¨ (`DialogPlayer.vue`)

**æ’­æ”¾å™¨**ï¼šJessibucaï¼ˆæ”¯æŒHTTP-FLVï¼‰

**æ˜¾ç¤ºå†…å®¹**ï¼š
- è§†é¢‘ç”»é¢ï¼ˆå®æ—¶æµï¼‰
- æ’­æ”¾åœ°å€ï¼ˆå¯å¤åˆ¶ï¼‰
- PTZäº‘å°æ§åˆ¶ï¼ˆä¸Šä¸‹å·¦å³ã€å˜ç„¦ï¼‰

---

## ğŸš€ å®Œæ•´å¼€å‘è·¯çº¿

### âœ… é˜¶æ®µ0ï¼šå½“å‰çŠ¶æ€ï¼ˆå·²æœ‰åŸºç¡€ï¼‰

ä½ å·²ç»æœ‰ï¼š
- âœ… å®Œæ•´çš„å‰ç«¯æ‘„åƒå¤´ç®¡ç†é¡µé¢
- âœ… VIDEOæ¨¡å—ï¼ˆPythonï¼‰çš„RTSPâ†’RTMPè½¬å‘
- âœ… ZLMediaKitæµåª’ä½“æœåŠ¡å™¨
- âœ… HTTP-FLVæ’­æ”¾å™¨ï¼ˆJessibucaï¼‰
- âœ… TASKæ¨¡å—ï¼ˆC++ï¼‰åŸºç¡€AIæ¨ç†

---

### ğŸ”¨ é˜¶æ®µ1ï¼šTASKæ¨¡å—è¡¥å…¨æ ¸å¿ƒåŠŸèƒ½ï¼ˆ3-4å¤©ï¼‰

**ç›®æ ‡**ï¼šè®©å•ä¸ªTASKå®ä¾‹èƒ½æ­£å¸¸å·¥ä½œ

#### Day 1-2: RTMPæ¨æµåŠŸèƒ½

**ä»»åŠ¡**ï¼š
```cpp
// å®ç° TASK/src/RTMPEncoder.cpp
class RTMPEncoder {
    bool init(rtmpUrl, width, height, fps);
    bool encodeAndPush(cv::Mat frame);  // æ¨é€å¸¦æ£€æµ‹æ¡†çš„å¸§
    void release();
};
```

**é›†æˆåˆ°Detech.cpp**ï¼š
```cpp
// åœ¨AIæ¨ç†+ç”»æ¡†ä¹‹å
if (_config.enableRtmp && _rtmpEncoder) {
    _rtmpEncoder->encodeAndPush(frameWithBoxes);
}
```

**é…ç½®æ–‡ä»¶** (`config/task1.ini`)ï¼š
```ini
[rtmp]
enable=true
rtmp_url=rtmp://localhost:1935/live/camera_1
```

**éªŒè¯**ï¼š
```bash
# å¯åŠ¨TASK
.\TASK.exe ..\..\config\task1.ini

# æ’­æ”¾éªŒè¯ï¼ˆåº”è¯¥çœ‹åˆ°å¸¦æ£€æµ‹æ¡†çš„è§†é¢‘ï¼‰
ffplay rtmp://localhost:1935/live/camera_1

# æˆ–åœ¨å‰ç«¯æ’­æ”¾
http://localhost/live/camera_1.flv
```

---

#### Day 3: åŒºåŸŸæ£€æµ‹ï¼ˆROIï¼‰

**ä»»åŠ¡**ï¼š
```cpp
// å®ç° TASK/src/AlarmRegion.cpp
struct AlarmRegion {
    std::string regionId;
    std::vector<cv::Point> polygon;
    std::vector<int> targetClasses;
    float confidenceThreshold;
};

bool isInAlarmRegion(const DetectObject& obj, const AlarmRegion& region) {
    cv::Point center(obj.box.x + obj.box.width/2, 
                     obj.box.y + obj.box.height/2);
    return cv::pointPolygonTest(region.polygon, center, false) >= 0;
}
```

**é…ç½®æ–‡ä»¶**ï¼š
```ini
[alarm_region_1]
enable=true
region_id=entrance
polygon=100,100;500,100;500,400;100,400
target_classes=0  # personç±»åˆ«
confidence_threshold=0.7
```

**éªŒè¯**ï¼š
- åŒºåŸŸå†…æ£€æµ‹ â†’ è§¦å‘å‘Šè­¦ âœ…
- åŒºåŸŸå¤–æ£€æµ‹ â†’ ä¸è§¦å‘å‘Šè­¦ âœ…

---

#### Day 4: èµ„æºé‡Šæ”¾å®Œå–„

**ä»»åŠ¡**ï¼š
```cpp
void Detech::releaseResources() {
    // é‡Šæ”¾FFmpegã€YOLOã€RTMPç¼–ç å™¨ç­‰èµ„æº
    if (_rtmpEncoder) {
        _rtmpEncoder->release();
        delete _rtmpEncoder;
    }
    // ...
}
```

**éªŒè¯**ï¼š
```bash
# é•¿æ—¶é—´è¿è¡Œæµ‹è¯•ï¼ˆ24å°æ—¶ï¼‰
# ç›‘æ§å†…å­˜å ç”¨æ˜¯å¦ç¨³å®š
```

---

### ğŸ”§ é˜¶æ®µ2ï¼šTaskManagerè¿›ç¨‹ç®¡ç†å™¨ï¼ˆ2-3å¤©ï¼‰

**ç›®æ ‡**ï¼šå®ç°HTTP APIç®¡ç†50ä¸ªTASKå®ä¾‹

#### Day 5-6: TaskManageræ ¸å¿ƒåŠŸèƒ½

**æ–°å»ºæ–‡ä»¶**ï¼š`TASK/src/TaskManager.cpp`

```cpp
class TaskManager {
private:
    std::map<int, std::unique_ptr<Detech>> tasks;  // task_id â†’ TASKå®ä¾‹
    httplib::Server server;                        // HTTPæœåŠ¡å™¨
    
public:
    TaskManager(int port = 7000);
    
    // APIæ¥å£
    void startTask(int taskId, const std::string& configPath);
    void stopTask(int taskId);
    json getTaskStatus(int taskId);
    json getAllTasks();
    
    void run();  // å¯åŠ¨HTTPæœåŠ¡å™¨
};
```

**HTTP APIè®¾è®¡**ï¼š

| æ¥å£ | æ–¹æ³• | è¯´æ˜ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| `/task/start` | POST | å¯åŠ¨TASK | `{"task_id": 1, "config_path": "config/task1.ini"}` | `{"code": 0, "msg": "å¯åŠ¨æˆåŠŸ"}` |
| `/task/stop` | POST | åœæ­¢TASK | `{"task_id": 1}` | `{"code": 0, "msg": "åœæ­¢æˆåŠŸ"}` |
| `/task/status` | GET | æŸ¥è¯¢çŠ¶æ€ | `?task_id=1` | `{"code": 0, "data": {"status": "running", "fps": 25}}` |
| `/task/list` | GET | ä»»åŠ¡åˆ—è¡¨ | æ—  | `{"code": 0, "data": [{...}, {...}]}` |
| `/config/generate` | POST | ç”Ÿæˆé…ç½® | JSONé…ç½® | `{"code": 0, "config_path": "config/task1.ini"}` |

**å®ç°ç¤ºä¾‹**ï¼š
```cpp
void TaskManager::setupRoutes() {
    // POST /task/start
    server.Post("/task/start", [this](const httplib::Request& req, httplib::Response& res) {
        auto json = nlohmann::json::parse(req.body);
        int taskId = json["task_id"];
        std::string configPath = json["config_path"];
        
        try {
            startTask(taskId, configPath);
            res.set_content(R"({"code": 0, "msg": "Task started"})", "application/json");
        } catch (const std::exception& e) {
            res.set_content(R"({"code": -1, "msg": ")" + std::string(e.what()) + R"("})", "application/json");
        }
    });
    
    // GET /task/status
    server.Get("/task/status", [this](const httplib::Request& req, httplib::Response& res) {
        int taskId = std::stoi(req.get_param_value("task_id"));
        auto status = getTaskStatus(taskId);
        res.set_content(status.dump(), "application/json");
    });
    
    // æ›´å¤šè·¯ç”±...
}

void TaskManager::startTask(int taskId, const std::string& configPath) {
    if (tasks.find(taskId) != tasks.end()) {
        throw std::runtime_error("Task already running");
    }
    
    // åˆ›å»ºæ–°çš„TASKå®ä¾‹
    auto task = std::make_unique<Detech>(configPath);
    task->init();
    task->runAsync();  // å¼‚æ­¥è¿è¡Œ
    
    tasks[taskId] = std::move(task);
    LOG(INFO) << "[TaskManager] Task " << taskId << " started";
}
```

**ç¼–è¯‘é…ç½®** (`CMakeLists.txt`)ï¼š
```cmake
# æ·»åŠ TaskManagerå¯æ‰§è¡Œæ–‡ä»¶
add_executable(TaskManager
    src/TaskManager.cpp
    src/Detech.cpp
    src/Yolov11Engine.cpp
    # ...
)

target_link_libraries(TaskManager
    cpp-httplib
    nlohmann_json
    # å…¶ä»–åº“...
)
```

**éªŒè¯**ï¼š
```bash
# å¯åŠ¨TaskManager
.\TaskManager.exe

# æµ‹è¯•API
curl -X POST http://localhost:7000/task/start \
  -H "Content-Type: application/json" \
  -d '{"task_id": 1, "config_path": "config/task1.ini"}'

# æŸ¥è¯¢çŠ¶æ€
curl http://localhost:7000/task/status?task_id=1

# ä»»åŠ¡åˆ—è¡¨
curl http://localhost:7000/task/list
```

---

#### Day 7: é…ç½®æ–‡ä»¶ç”Ÿæˆå™¨

**ä»»åŠ¡**ï¼šå®ç°JSONâ†’INIé…ç½®ç”Ÿæˆ

```cpp
// POST /config/generate
server.Post("/config/generate", [](const httplib::Request& req, httplib::Response& res) {
    auto json = nlohmann::json::parse(req.body);
    
    int taskId = json["task_id"];
    std::string configPath = "config/task" + std::to_string(taskId) + ".ini";
    
    // ç”ŸæˆINIæ–‡ä»¶
    std::ofstream file(configPath);
    file << "[task]\n";
    file << "task_id=" << taskId << "\n\n";
    
    file << "[video]\n";
    file << "source=" << json["video"]["source"].get<std::string>() << "\n";
    file << "width=" << json["video"]["width"] << "\n";
    file << "height=" << json["video"]["height"] << "\n\n";
    
    file << "[model]\n";
    file << "model_path=" << json["model"]["model_path"].get<std::string>() << "\n";
    file << "confidence_threshold=" << json["model"]["confidence_threshold"] << "\n\n";
    
    file << "[rtmp]\n";
    file << "enable=true\n";
    file << "rtmp_url=" << json["rtmp"]["rtmp_url"].get<std::string>() << "\n\n";
    
    file << "[alarm]\n";
    file << "enable=" << (json["alarm"]["enable"].get<bool>() ? "true" : "false") << "\n";
    file << "hook_url=" << json["alarm"]["hook_url"].get<std::string>() << "\n";
    file << "confidence_threshold=" << json["alarm"]["confidence_threshold"] << "\n";
    file << "cooldown_time=" << json["alarm"]["cooldown_time"] << "\n\n";
    
    // åŒºåŸŸé…ç½®
    if (json.contains("regions")) {
        int regionIdx = 1;
        for (auto& region : json["regions"]) {
            file << "[alarm_region_" << regionIdx++ << "]\n";
            file << "enable=true\n";
            file << "region_id=" << region["region_id"].get<std::string>() << "\n";
            
            // polygon: [[x1,y1], [x2,y2], ...]  â†’  x1,y1;x2,y2;...
            std::string polygonStr;
            for (auto& point : region["polygon"]) {
                if (!polygonStr.empty()) polygonStr += ";";
                polygonStr += std::to_string(point[0].get<int>()) + "," + 
                              std::to_string(point[1].get<int>());
            }
            file << "polygon=" << polygonStr << "\n";
            
            // target_classes
            std::string classesStr;
            for (auto& cls : region["target_classes"]) {
                if (!classesStr.empty()) classesStr += ",";
                classesStr += std::to_string(cls.get<int>());
            }
            file << "target_classes=" << classesStr << "\n";
            file << "confidence_threshold=" << region["confidence_threshold"] << "\n\n";
        }
    }
    
    file.close();
    
    nlohmann::json response = {
        {"code", 0},
        {"msg", "Config file generated"},
        {"config_path", configPath}
    };
    res.set_content(response.dump(), "application/json");
});
```

**æµ‹è¯•è¯·æ±‚**ï¼š
```json
POST http://localhost:7000/config/generate
Content-Type: application/json

{
  "task_id": 1,
  "video": {
    "source": "rtsp://admin:Admin123@192.168.1.100:554/stream1",
    "width": 1920,
    "height": 1080
  },
  "model": {
    "model_path": "models/SafeHat.onnx",
    "confidence_threshold": 0.5
  },
  "rtmp": {
    "rtmp_url": "rtmp://localhost:1935/live/camera_1"
  },
  "alarm": {
    "enable": true,
    "hook_url": "http://localhost:48080/admin-api/alarm/callback/1",
    "confidence_threshold": 0.6,
    "cooldown_time": 10
  },
  "regions": [
    {
      "region_id": "entrance",
      "polygon": [[100,100], [500,100], [500,400], [100,400]],
      "target_classes": [0],
      "confidence_threshold": 0.7
    }
  ]
}
```

---

### ğŸ¨ é˜¶æ®µ3ï¼šå‰ç«¯é›†æˆTaskManagerï¼ˆ2-3å¤©ï¼‰

**ç›®æ ‡**ï¼šå‰ç«¯èƒ½é€šè¿‡Webç•Œé¢ç®¡ç†50è·¯TASK

#### Day 8-9: å‰ç«¯APIå¯¹æ¥

**æ–°å»ºAPIæ–‡ä»¶**ï¼š`WEB/src/api/task/index.ts`

```typescript
import {defHttp} from '@/utils/http/axios';

// TaskManager APIåŸºç¡€è·¯å¾„ï¼ˆé€šè¿‡ä»£ç†ï¼‰
const TASK_API_BASE = '/dev-api/task';

// ====================== TASKç®¡ç†æ¥å£ ======================

export interface TaskConfig {
  task_id: number;
  video: {
    source: string;
    width: number;
    height: number;
  };
  model: {
    model_path: string;
    confidence_threshold: number;
  };
  rtmp: {
    rtmp_url: string;
  };
  alarm: {
    enable: boolean;
    hook_url: string;
    confidence_threshold: number;
    cooldown_time: number;
  };
  regions?: Array<{
    region_id: string;
    polygon: number[][];
    target_classes: number[];
    confidence_threshold: number;
  }>;
}

export interface TaskStatus {
  task_id: number;
  status: 'running' | 'stopped' | 'error';
  fps: number;
  frame_count: number;
  uptime: number;
  rtmp_url: string;
}

// å¯åŠ¨TASK
export const startTask = (taskId: number, configPath: string) => {
  return defHttp.post({
    url: `${TASK_API_BASE}/task/start`,
    data: { task_id: taskId, config_path: configPath }
  });
};

// åœæ­¢TASK
export const stopTask = (taskId: number) => {
  return defHttp.post({
    url: `${TASK_API_BASE}/task/stop`,
    data: { task_id: taskId }
  });
};

// æŸ¥è¯¢TASKçŠ¶æ€
export const getTaskStatus = (taskId: number) => {
  return defHttp.get<TaskStatus>({
    url: `${TASK_API_BASE}/task/status`,
    params: { task_id: taskId }
  });
};

// è·å–æ‰€æœ‰TASKåˆ—è¡¨
export const getTaskList = () => {
  return defHttp.get<TaskStatus[]>({
    url: `${TASK_API_BASE}/task/list`
  });
};

// ç”Ÿæˆé…ç½®æ–‡ä»¶
export const generateConfig = (config: TaskConfig) => {
  return defHttp.post({
    url: `${TASK_API_BASE}/config/generate`,
    data: config
  });
};
```

**é…ç½®å‰ç«¯ä»£ç†**ï¼š`WEB/.env.development`

```javascript
VITE_PROXY = [
  ["/api/v1/buckets", "http://localhost:9000/api/v1/buckets"],
  ["/dev-api/nodeRed", "http://127.0.0.1:1880"],
  ["/dev-api/task", "http://127.0.0.1:7000"],        // æ–°å¢TaskManagerä»£ç†
  ["/dev-api", "http://127.0.0.1:48080/admin-api"]
]
```

---

#### Day 10: å‰ç«¯é¡µé¢æ‰©å±•

**æ–¹æ¡ˆ1ï¼šæ‰©å±•ç°æœ‰æ‘„åƒå¤´é¡µé¢**

åœ¨ `WEB/src/views/camera/index.vue` ä¸­æ·»åŠ "AIä»»åŠ¡"åŠŸèƒ½ï¼š

```vue
<template>
  <div class="camera-container">
    <!-- åŸæœ‰æ‘„åƒå¤´åˆ—è¡¨ -->
    <BasicTable @register="registerTable">
      <!-- ... -->
      <template #bodyCell="{ column, record }">
        <!-- æ–°å¢æ“ä½œæŒ‰é’® -->
        <template v-if="column.dataIndex === 'action'">
          <TableAction :actions="getTableActions(record)" />
        </template>
      </template>
    </BasicTable>
  </div>
</template>

<script lang="ts" setup>
import { startTask, stopTask, getTaskStatus } from '@/api/task';

// æ‰©å±•æ“ä½œæŒ‰é’®
const getTableActions = (record) => {
  const actions = [
    {
      icon: 'octicon:play-16',
      tooltip: 'æ’­æ”¾è§†é¢‘',
      onClick: () => handlePlay(record)
    },
    {
      icon: 'ant-design:robot-outlined',
      tooltip: 'å¯åŠ¨AIæ£€æµ‹',
      onClick: () => handleStartAI(record)  // æ–°å¢ï¼šå¯åŠ¨AIä»»åŠ¡
    },
    {
      icon: 'ant-design:stop-outlined',
      tooltip: 'åœæ­¢AIæ£€æµ‹',
      onClick: () => handleStopAI(record)   // æ–°å¢ï¼šåœæ­¢AIä»»åŠ¡
    },
    // ... å…¶ä»–æŒ‰é’®
  ];
  return actions;
};

// å¯åŠ¨AIæ£€æµ‹ä»»åŠ¡
const handleStartAI = async (record) => {
  try {
    createMessage.loading({ content: 'æ­£åœ¨å¯åŠ¨AIæ£€æµ‹...', key: 'ai' });
    
    // 1. ç”Ÿæˆé…ç½®æ–‡ä»¶
    const config = {
      task_id: parseInt(record.id),
      video: {
        source: record.source,  // RTSPåœ°å€
        width: 1920,
        height: 1080
      },
      model: {
        model_path: 'models/SafeHat.onnx',
        confidence_threshold: 0.5
      },
      rtmp: {
        rtmp_url: `rtmp://localhost:1935/live/ai_camera_${record.id}`
      },
      alarm: {
        enable: true,
        hook_url: `http://localhost:48080/admin-api/alarm/callback/${record.id}`,
        confidence_threshold: 0.6,
        cooldown_time: 10
      }
    };
    
    const configRes = await generateConfig(config);
    
    // 2. å¯åŠ¨TASK
    await startTask(parseInt(record.id), configRes.data.config_path);
    
    createMessage.success({ content: 'AIæ£€æµ‹å·²å¯åŠ¨', key: 'ai' });
    
    // 3. æ›´æ–°æ’­æ”¾åœ°å€ä¸ºAIæ¨æµåœ°å€
    record.http_stream = `http://localhost/live/ai_camera_${record.id}.flv`;
    reload();
    
  } catch (error) {
    console.error('å¯åŠ¨AIæ£€æµ‹å¤±è´¥', error);
    createMessage.error({ content: 'å¯åŠ¨AIæ£€æµ‹å¤±è´¥', key: 'ai' });
  }
};

// åœæ­¢AIæ£€æµ‹ä»»åŠ¡
const handleStopAI = async (record) => {
  try {
    createMessage.loading({ content: 'æ­£åœ¨åœæ­¢AIæ£€æµ‹...', key: 'ai' });
    await stopTask(parseInt(record.id));
    createMessage.success({ content: 'AIæ£€æµ‹å·²åœæ­¢', key: 'ai' });
    reload();
  } catch (error) {
    console.error('åœæ­¢AIæ£€æµ‹å¤±è´¥', error);
    createMessage.error({ content: 'åœæ­¢AIæ£€æµ‹å¤±è´¥', key: 'ai' });
  }
};
</script>
```

**æ•ˆæœ**ï¼š
- æ¯ä¸ªæ‘„åƒå¤´éƒ½æœ‰"å¯åŠ¨AIæ£€æµ‹"å’Œ"åœæ­¢AIæ£€æµ‹"æŒ‰é’®
- ç‚¹å‡»"å¯åŠ¨AIæ£€æµ‹" â†’ è‡ªåŠ¨ç”Ÿæˆé…ç½® â†’ å¯åŠ¨TASKå®ä¾‹ â†’ æ’­æ”¾åœ°å€åˆ‡æ¢ä¸ºAIæµ
- ç‚¹å‡»"æ’­æ”¾" â†’ çœ‹åˆ°å¸¦æ£€æµ‹æ¡†çš„å®æ—¶ç”»é¢

---

**æ–¹æ¡ˆ2ï¼šæ–°å»ºAIä»»åŠ¡ç®¡ç†é¡µé¢**ï¼ˆæ¨èï¼‰

æ–°å»ºæ–‡ä»¶ï¼š`WEB/src/views/ai-task/index.vue`

```vue
<template>
  <div class="ai-task-container">
    <BasicTable @register="registerTable">
      <template #toolbar>
        <a-button type="primary" @click="openConfigModal">
          <template #icon>
            <RobotOutlined/>
          </template>
          æ–°å»ºAIæ£€æµ‹ä»»åŠ¡
        </a-button>
        <a-button @click="reloadAllStatus">
          <template #icon>
            <SyncOutlined/>
          </template>
          åˆ·æ–°çŠ¶æ€
        </a-button>
      </template>

      <template #bodyCell="{ column, record }">
        <!-- AIä»»åŠ¡çŠ¶æ€ -->
        <template v-if="column.dataIndex === 'status'">
          <a-tag :color="getStatusColor(record.status)">
            {{ getStatusText(record.status) }}
          </a-tag>
        </template>

        <!-- FPSæ˜¾ç¤º -->
        <template v-else-if="column.dataIndex === 'fps'">
          <span>{{ record.fps }} fps</span>
        </template>

        <!-- æ“ä½œ -->
        <template v-else-if="column.dataIndex === 'action'">
          <TableAction :actions="getTableActions(record)" />
        </template>
      </template>
    </BasicTable>

    <!-- AIä»»åŠ¡é…ç½®å¼¹çª— -->
    <AITaskConfigModal @register="registerConfigModal" @success="handleConfigSuccess"/>
  </div>
</template>

<script lang="ts" setup>
import {onMounted, ref} from 'vue';
import {BasicTable, TableAction, useTable} from '@/components/Table';
import {useMessage} from '@/hooks/web/useMessage';
import {useModal} from "@/components/Modal";
import {
  startTask,
  stopTask,
  getTaskList,
  getTaskStatus,
  generateConfig
} from '@/api/task';
import {RobotOutlined, SyncOutlined} from '@ant-design/icons-vue';
import AITaskConfigModal from './components/AITaskConfigModal.vue';

const {createMessage} = useMessage();
const [registerConfigModal, {openModal: openConfigModal}] = useModal();

// è¡¨æ ¼åˆ—å®šä¹‰
const columns = [
  { title: 'ä»»åŠ¡ID', dataIndex: 'task_id', width: 80 },
  { title: 'æ‘„åƒå¤´åç§°', dataIndex: 'camera_name', width: 150 },
  { title: 'çŠ¶æ€', dataIndex: 'status', width: 100 },
  { title: 'FPS', dataIndex: 'fps', width: 80 },
  { title: 'å¤„ç†å¸§æ•°', dataIndex: 'frame_count', width: 100 },
  { title: 'è¿è¡Œæ—¶é•¿', dataIndex: 'uptime', width: 100 },
  { title: 'RTMPæ¨æµåœ°å€', dataIndex: 'rtmp_url', width: 200 },
  { title: 'æ“ä½œ', dataIndex: 'action', width: 200 },
];

const [registerTable, {reload}] = useTable({
  title: 'AIæ£€æµ‹ä»»åŠ¡åˆ—è¡¨',
  api: getTaskList,
  columns: columns,
  pagination: true,
  rowKey: 'task_id',
});

// è·å–æ“ä½œæŒ‰é’®
const getTableActions = (record) => {
  const actions = [];
  
  if (record.status === 'running') {
    actions.push({
      icon: 'ant-design:pause-circle-outlined',
      tooltip: 'åœæ­¢ä»»åŠ¡',
      onClick: () => handleStop(record.task_id)
    });
  } else {
    actions.push({
      icon: 'ant-design:play-circle-outlined',
      tooltip: 'å¯åŠ¨ä»»åŠ¡',
      onClick: () => handleStart(record.task_id)
    });
  }
  
  actions.push(
    {
      icon: 'octicon:play-16',
      tooltip: 'æ’­æ”¾è§†é¢‘',
      onClick: () => handlePlay(record)
    },
    {
      icon: 'ant-design:setting-outlined',
      tooltip: 'é…ç½®',
      onClick: () => openConfigModal(record)
    },
    {
      icon: 'material-symbols:delete-outline-rounded',
      tooltip: 'åˆ é™¤',
      popConfirm: {
        title: 'ç¡®å®šåˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ',
        confirm: () => handleDelete(record.task_id)
      }
    }
  );
  
  return actions;
};

// å¯åŠ¨ä»»åŠ¡
const handleStart = async (taskId: number) => {
  try {
    await startTask(taskId, `config/task${taskId}.ini`);
    createMessage.success('ä»»åŠ¡å¯åŠ¨æˆåŠŸ');
    reload();
  } catch (error) {
    createMessage.error('ä»»åŠ¡å¯åŠ¨å¤±è´¥');
  }
};

// åœæ­¢ä»»åŠ¡
const handleStop = async (taskId: number) => {
  try {
    await stopTask(taskId);
    createMessage.success('ä»»åŠ¡åœæ­¢æˆåŠŸ');
    reload();
  } catch (error) {
    createMessage.error('ä»»åŠ¡åœæ­¢å¤±è´¥');
  }
};

// çŠ¶æ€æ–‡æœ¬å’Œé¢œè‰²
const getStatusText = (status: string) => {
  const map = {
    'running': 'è¿è¡Œä¸­',
    'stopped': 'å·²åœæ­¢',
    'error': 'é”™è¯¯'
  };
  return map[status] || status;
};

const getStatusColor = (status: string) => {
  const map = {
    'running': 'green',
    'stopped': 'red',
    'error': 'orange'
  };
  return map[status] || 'default';
};
</script>
```

**æ–°å»ºé…ç½®å¼¹çª—**ï¼š`WEB/src/views/ai-task/components/AITaskConfigModal.vue`

```vue
<template>
  <BasicModal
    @register="register"
    title="é…ç½®AIæ£€æµ‹ä»»åŠ¡"
    width="800px"
    @ok="handleSubmit"
  >
    <BasicForm @register="registerForm" />
  </BasicModal>
</template>

<script lang="ts" setup>
import {BasicModal, useModalInner} from '@/components/Modal';
import {BasicForm, useForm} from '@/components/Form';
import {generateConfig, startTask} from '@/api/task';
import {useMessage} from '@/hooks/web/useMessage';

const {createMessage} = useMessage();
const emit = defineEmits(['success', 'register']);

const [registerForm, {validate, setFieldsValue, resetFields}] = useForm({
  labelWidth: 120,
  schemas: [
    {
      field: 'task_id',
      label: 'ä»»åŠ¡ID',
      component: 'InputNumber',
      required: true,
    },
    {
      field: 'camera_id',
      label: 'é€‰æ‹©æ‘„åƒå¤´',
      component: 'Select',
      componentProps: {
        options: [],  // ä»æ‘„åƒå¤´åˆ—è¡¨è·å–
        showSearch: true,
      },
      required: true,
    },
    {
      field: 'model_path',
      label: 'æ£€æµ‹æ¨¡å‹',
      component: 'Select',
      componentProps: {
        options: [
          { label: 'å®‰å…¨å¸½æ£€æµ‹', value: 'models/SafeHat.onnx' },
          { label: 'è·Œå€’æ£€æµ‹', value: 'models/FallDetect.onnx' },
          { label: 'é€šç”¨ç›®æ ‡æ£€æµ‹', value: 'models/yolov11n.onnx' },
        ],
      },
      required: true,
      defaultValue: 'models/SafeHat.onnx',
    },
    {
      field: 'confidence_threshold',
      label: 'æ£€æµ‹é˜ˆå€¼',
      component: 'Slider',
      componentProps: {
        min: 0,
        max: 1,
        step: 0.05,
        marks: {
          0.5: '0.5',
          0.7: '0.7',
        },
      },
      defaultValue: 0.6,
    },
    {
      field: 'enable_alarm',
      label: 'å¯ç”¨å‘Šè­¦',
      component: 'Switch',
      defaultValue: true,
    },
    {
      field: 'alarm_confidence',
      label: 'å‘Šè­¦é˜ˆå€¼',
      component: 'Slider',
      componentProps: {
        min: 0,
        max: 1,
        step: 0.05,
      },
      defaultValue: 0.7,
      ifShow: ({values}) => values.enable_alarm,
    },
    {
      field: 'cooldown_time',
      label: 'å‘Šè­¦å†·å´æ—¶é—´(ç§’)',
      component: 'InputNumber',
      componentProps: {
        min: 1,
        max: 60,
      },
      defaultValue: 10,
      ifShow: ({values}) => values.enable_alarm,
    },
  ],
  showActionButtonGroup: false,
});

const [register, {closeModal}] = useModalInner((data) => {
  resetFields();
  if (data) {
    setFieldsValue(data);
  }
});

const handleSubmit = async () => {
  try {
    const values = await validate();
    
    // æ„å»ºé…ç½®
    const config = {
      task_id: values.task_id,
      video: {
        source: values.camera_source,  // ä»æ‘„åƒå¤´ä¿¡æ¯è·å–
        width: 1920,
        height: 1080,
      },
      model: {
        model_path: values.model_path,
        confidence_threshold: values.confidence_threshold,
      },
      rtmp: {
        rtmp_url: `rtmp://localhost:1935/live/ai_task_${values.task_id}`,
      },
      alarm: {
        enable: values.enable_alarm,
        hook_url: `http://localhost:48080/admin-api/alarm/callback/${values.task_id}`,
        confidence_threshold: values.alarm_confidence,
        cooldown_time: values.cooldown_time,
      },
    };
    
    // 1. ç”Ÿæˆé…ç½®æ–‡ä»¶
    const configRes = await generateConfig(config);
    
    // 2. å¯åŠ¨ä»»åŠ¡
    await startTask(values.task_id, configRes.data.config_path);
    
    createMessage.success('AIä»»åŠ¡å¯åŠ¨æˆåŠŸ');
    emit('success');
    closeModal();
    
  } catch (error) {
    createMessage.error('é…ç½®å¤±è´¥');
  }
};
</script>
```

---

### ğŸ¬ é˜¶æ®µ4ï¼šè§†é¢‘å¢™å±•ç¤ºï¼ˆ1-2å¤©ï¼‰

**ç›®æ ‡**ï¼šåŒæ—¶å±•ç¤ºå¤šè·¯AIæ£€æµ‹è§†é¢‘

æ–°å»ºé¡µé¢ï¼š`WEB/src/views/ai-task/video-wall.vue`

```vue
<template>
  <div class="video-wall-container">
    <div class="video-wall-header">
      <h2>AIæ£€æµ‹è§†é¢‘å¢™ï¼ˆ{{ runningTasks.length }}/50è·¯ï¼‰</h2>
      <a-radio-group v-model:value="gridLayout" button-style="solid">
        <a-radio-button value="2x2">2x2</a-radio-button>
        <a-radio-button value="3x3">3x3</a-radio-button>
        <a-radio-button value="4x4">4x4</a-radio-button>
        <a-radio-button value="5x5">5x5</a-radio-button>
      </a-radio-group>
    </div>
    
    <div :class="`video-wall-grid grid-${gridLayout}`">
      <div 
        v-for="task in runningTasks" 
        :key="task.task_id"
        class="video-wall-item"
      >
        <!-- è§†é¢‘æ’­æ”¾å™¨ -->
        <Jessibuca 
          :playUrl="task.http_flv_url" 
          :hasAudio="false"
          class="video-player"
        />
        
        <!-- ä¿¡æ¯è¦†ç›–å±‚ -->
        <div class="video-info-overlay">
          <div class="video-title">{{ task.camera_name }}</div>
          <div class="video-stats">
            <span class="fps">{{ task.fps }} FPS</span>
            <span class="status" :class="task.status">{{ task.status }}</span>
          </div>
        </div>
        
        <!-- å‘Šè­¦æ ‡è¯† -->
        <div v-if="task.has_alarm" class="alarm-indicator">
          <WarningOutlined /> å‘Šè­¦ä¸­
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts" setup>
import {ref, onMounted, onUnmounted} from 'vue';
import {getTaskList} from '@/api/task';
import Jessibuca from '@/components/Player/module/jessibuca.vue';
import {WarningOutlined} from '@ant-design/icons-vue';

const gridLayout = ref('3x3');
const runningTasks = ref([]);
const updateTimer = ref(null);

// è·å–è¿è¡Œä¸­çš„ä»»åŠ¡
const fetchRunningTasks = async () => {
  try {
    const response = await getTaskList();
    runningTasks.value = response.data
      .filter(task => task.status === 'running')
      .map(task => ({
        ...task,
        http_flv_url: `http://localhost/live/ai_task_${task.task_id}.flv`,
      }));
  } catch (error) {
    console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥', error);
  }
};

onMounted(() => {
  fetchRunningTasks();
  // æ¯5ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
  updateTimer.value = setInterval(fetchRunningTasks, 5000);
});

onUnmounted(() => {
  if (updateTimer.value) {
    clearInterval(updateTimer.value);
  }
});
</script>

<style scoped lang="less">
.video-wall-container {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #000;
}

.video-wall-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: #1a1a1a;
  color: #fff;
}

.video-wall-grid {
  flex: 1;
  display: grid;
  gap: 8px;
  padding: 8px;
  
  &.grid-2x2 { grid-template-columns: repeat(2, 1fr); }
  &.grid-3x3 { grid-template-columns: repeat(3, 1fr); }
  &.grid-4x4 { grid-template-columns: repeat(4, 1fr); }
  &.grid-5x5 { grid-template-columns: repeat(5, 1fr); }
}

.video-wall-item {
  position: relative;
  background: #222;
  border-radius: 4px;
  overflow: hidden;
  
  &:hover .video-info-overlay {
    opacity: 1;
  }
}

.video-player {
  width: 100%;
  height: 100%;
}

.video-info-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
  padding: 8px;
  opacity: 0.7;
  transition: opacity 0.3s;
  
  .video-title {
    color: #fff;
    font-size: 14px;
    font-weight: bold;
  }
  
  .video-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 4px;
    
    .fps {
      color: #4caf50;
      font-size: 12px;
    }
    
    .status {
      font-size: 12px;
      &.running { color: #4caf50; }
      &.error { color: #f44336; }
    }
  }
}

.alarm-indicator {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #f44336;
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 49% { opacity: 1; }
  50%, 100% { opacity: 0.3; }
}
</style>
```

---

## ğŸ“‹ æœ€ç»ˆæ•ˆæœ

### 1. æ‘„åƒå¤´ç®¡ç†é¡µé¢ (`/camera`)
- âœ… ç®¡ç†æ‰€æœ‰æ‘„åƒå¤´è®¾å¤‡ï¼ˆONVIFæ‰«æã€æ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤ï¼‰
- âœ… å¯åŠ¨/åœæ­¢RTSPè½¬å‘ï¼ˆVIDEOæ¨¡å—ï¼‰
- âœ… **æ–°å¢ï¼šå¯åŠ¨/åœæ­¢AIæ£€æµ‹ï¼ˆTASKæ¨¡å—ï¼‰**

### 2. AIä»»åŠ¡ç®¡ç†é¡µé¢ (`/ai-task`)
- âœ… AIä»»åŠ¡åˆ—è¡¨ï¼ˆ50è·¯ï¼‰
- âœ… æ–°å»ºAIä»»åŠ¡ï¼ˆé…ç½®æ£€æµ‹æ¨¡å‹ã€é˜ˆå€¼ã€å‘Šè­¦è§„åˆ™ã€ROIåŒºåŸŸï¼‰
- âœ… å¯åŠ¨/åœæ­¢/åˆ é™¤ä»»åŠ¡
- âœ… å®æ—¶çŠ¶æ€ç›‘æ§ï¼ˆFPSã€å¸§æ•°ã€è¿è¡Œæ—¶é•¿ï¼‰

### 3. è§†é¢‘å¢™é¡µé¢ (`/ai-task/video-wall`)
- âœ… åŒæ—¶å±•ç¤ºå¤šè·¯AIæ£€æµ‹è§†é¢‘ï¼ˆ2x2 / 3x3 / 4x4 / 5x5å¸ƒå±€ï¼‰
- âœ… æ¯è·¯è§†é¢‘æ˜¾ç¤ºï¼šæ‘„åƒå¤´åç§°ã€FPSã€è¿è¡ŒçŠ¶æ€
- âœ… å‘Šè­¦é«˜äº®æ˜¾ç¤º

### 4. å®Œæ•´æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œå‰ç«¯ â†’ TaskManager(7000) â†’ TASKå®ä¾‹(C++) â†’ YOLOæ¨ç†+ç”»æ¡†
                    â†“                       â†“
              ç”Ÿæˆé…ç½®æ–‡ä»¶            RTMPæ¨æµ(å¸¦æ£€æµ‹æ¡†)
                                           â†“
                                    ZLMediaKit(80)
                                           â†“
                                    HTTP-FLVæ’­æ”¾
                                           â†“
                                    å‰ç«¯è§†é¢‘å¢™å±•ç¤º
```

---

## ğŸ¯ 50è·¯æ‘„åƒå¤´éƒ¨ç½²æ–¹æ¡ˆ

### ç¡¬ä»¶è¦æ±‚

| ç»„ä»¶ | é…ç½® | è¯´æ˜ |
|------|------|------|
| **CPU** | Intel i7-12700 æˆ–æ›´é«˜ | 50è·¯AIæ¨ç†éœ€è¦å¼ºCPU |
| **å†…å­˜** | 32GB+ | æ¯è·¯TASKçº¦500MBï¼Œ50è·¯éœ€25GB+ |
| **å­˜å‚¨** | 500GB SSD | æ¨¡å‹ã€é…ç½®ã€æ—¥å¿— |
| **ç½‘ç»œ** | åƒå…†ç½‘ç»œ | 50è·¯è§†é¢‘æµå¸¦å®½éœ€æ±‚å¤§ |
| **GPUï¼ˆå¯é€‰ï¼‰** | RTX 4070 æˆ–æ›´é«˜ | åŠ é€ŸAIæ¨ç†ï¼ˆå¯é€‰ï¼ŒCPUä¹Ÿèƒ½è·‘ï¼‰ |

### è½¯ä»¶æ¶æ„

```
è¾¹ç¼˜æœåŠ¡å™¨ï¼ˆä¸€å°ç‰©ç†æœºï¼‰
â”œâ”€â”€ ZLMediaKitï¼ˆæµåª’ä½“æœåŠ¡å™¨ï¼‰- 1ä¸ªå®ä¾‹
â”œâ”€â”€ TaskManagerï¼ˆè¿›ç¨‹ç®¡ç†å™¨ï¼‰- 1ä¸ªå®ä¾‹
â”‚   â”œâ”€â”€ TASKå®ä¾‹ #1ï¼ˆcamera_1ï¼‰
â”‚   â”œâ”€â”€ TASKå®ä¾‹ #2ï¼ˆcamera_2ï¼‰
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ TASKå®ä¾‹ #50ï¼ˆcamera_50ï¼‰
â””â”€â”€ PostgreSQL + MinIO + Node-REDï¼ˆåç«¯æœåŠ¡ï¼‰
```

**æ³¨æ„**ï¼š
- 50ä¸ªTASKå®ä¾‹éƒ½åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œ
- TaskManagerç»Ÿä¸€ç®¡ç†50ä¸ªè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ
- æ¯ä¸ªTASKç‹¬ç«‹é…ç½®æ–‡ä»¶ï¼Œç‹¬ç«‹RTMPæµ

### éƒ¨ç½²æ­¥éª¤

#### Step 1: å¯åŠ¨ZLMediaKit

```bash
cd F:\EASYLOT\zlmediakit
.\MediaServer.exe -c config.ini
```

#### Step 2: å¯åŠ¨TaskManager

```bash
cd F:\EASYLOT\easyaiot-main\TASK\build\Release
.\TaskManager.exe
```

TaskManagerä¼šï¼š
- ç›‘å¬7000ç«¯å£
- ç­‰å¾…å‰ç«¯å‘é€ä»»åŠ¡å¯åŠ¨è¯·æ±‚

#### Step 3: åœ¨å‰ç«¯é…ç½®50è·¯æ‘„åƒå¤´

```typescript
// æ‰¹é‡åˆ›å»ºä»»åŠ¡ç¤ºä¾‹
const cameras = [
  { id: 1, name: 'å¤§é—¨', rtsp: 'rtsp://192.168.1.101:554/stream1' },
  { id: 2, name: 'è½¦åº“', rtsp: 'rtsp://192.168.1.102:554/stream1' },
  // ... 48 more cameras
];

for (let camera of cameras) {
  await generateConfig({
    task_id: camera.id,
    video: { source: camera.rtsp, width: 1920, height: 1080 },
    model: { model_path: 'models/SafeHat.onnx', confidence_threshold: 0.5 },
    rtmp: { rtmp_url: `rtmp://localhost:1935/live/camera_${camera.id}` },
    alarm: {
      enable: true,
      hook_url: `http://localhost:48080/admin-api/alarm/callback/${camera.id}`,
      confidence_threshold: 0.6,
      cooldown_time: 10
    }
  });
  
  await startTask(camera.id, `config/task${camera.id}.ini`);
}
```

#### Step 4: æ‰“å¼€è§†é¢‘å¢™

è®¿é—®ï¼š`http://localhost:8099/ai-task/video-wall`

é€‰æ‹©5x5å¸ƒå±€ â†’ åŒæ—¶çœ‹åˆ°25è·¯è§†é¢‘ï¼ˆå¯æ»šåŠ¨æŸ¥çœ‹å…¨éƒ¨50è·¯ï¼‰

---

## ğŸ“Š æ€§èƒ½è¯„ä¼°

### å•è·¯TASKèµ„æºå ç”¨

| æŒ‡æ ‡ | CPUæ¨¡å¼ | GPUæ¨¡å¼ |
|------|---------|---------|
| **CPUå ç”¨** | ~10% (12æ ¸å¿ƒ) | ~5% |
| **å†…å­˜å ç”¨** | ~500MB | ~500MB |
| **æ˜¾å­˜å ç”¨** | N/A | ~2GB |
| **æ¨ç†é€Ÿåº¦** | 25-30 FPS | 100+ FPS |
| **å»¶è¿Ÿ** | ~1ç§’ | ~0.5ç§’ |

### 50è·¯å¹¶å‘é¢„ä¼°

| èµ„æº | CPUæ¨¡å¼ | GPUæ¨¡å¼ |
|------|---------|---------|
| **CPUå ç”¨** | ~80% (12æ ¸å¿ƒ) | ~40% |
| **å†…å­˜å ç”¨** | ~25GB | ~25GB |
| **æ˜¾å­˜å ç”¨** | N/A | ~8GB (RTX 4070) |
| **ç½‘ç»œå¸¦å®½** | ~200Mbps (å‡ºå£) | ~200Mbps |

**ç»“è®º**ï¼š
- CPUæ¨¡å¼å¯ä»¥è·‘50è·¯ï¼ˆä½†CPUä¼šæ»¡è½½ï¼‰
- GPUæ¨¡å¼æ›´è½»æ¾ï¼ˆæ¨èï¼‰

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] å•ä¸ªTASKå®ä¾‹æ­£å¸¸è¿è¡Œï¼ˆRTSPâ†’AIâ†’RTMPâ†’æ’­æ”¾ï¼‰
- [ ] TaskManageræˆåŠŸç®¡ç†50ä¸ªTASKå®ä¾‹
- [ ] å‰ç«¯èƒ½é€šè¿‡APIå¯åŠ¨/åœæ­¢ä»»æ„TASK
- [ ] å‰ç«¯èƒ½å®æ—¶æŸ¥çœ‹æ‰€æœ‰TASKçŠ¶æ€
- [ ] è§†é¢‘å¢™èƒ½åŒæ—¶æ’­æ”¾å¤šè·¯è§†é¢‘
- [ ] åŒºåŸŸå‘Šè­¦æ­£å¸¸è§¦å‘ï¼ˆåŒºåŸŸå†…æœ‰äººâ†’å‘Šè­¦ï¼ŒåŒºåŸŸå¤–æ— å‘Šè­¦ï¼‰
- [ ] å‘Šè­¦å›è°ƒåˆ°DEVICEæ¨¡å—ï¼Œè§¦å‘Node-REDè§„åˆ™

### æ€§èƒ½éªŒæ”¶

- [ ] å•è·¯TASK FPS â‰¥ 20
- [ ] 50è·¯TASKåŒæ—¶è¿è¡Œï¼Œç³»ç»Ÿç¨³å®š
- [ ] è§†é¢‘å»¶è¿Ÿ â‰¤ 2ç§’
- [ ] å†…å­˜æ— æ³„æ¼ï¼ˆ24å°æ—¶è¿è¡Œå†…å­˜å¢é•¿ < 10%ï¼‰
- [ ] CPUå ç”¨åˆç†ï¼ˆCPUæ¨¡å¼ < 90%ï¼‰

### ç”¨æˆ·ä½“éªŒéªŒæ”¶

- [ ] å‰ç«¯æ“ä½œæµç•…ï¼ˆå¯åŠ¨ä»»åŠ¡ < 3ç§’ï¼‰
- [ ] è§†é¢‘å¢™å¸ƒå±€å¯è°ƒæ•´ï¼ˆ2x2 / 3x3 / 4x4 / 5x5ï¼‰
- [ ] å‘Šè­¦å®æ—¶æ˜¾ç¤ºï¼ˆ< 1ç§’å»¶è¿Ÿï¼‰
- [ ] æ—¥å¿—å¯æŸ¥è¯¢ï¼ˆGlogè¾“å‡ºï¼‰

---

## ğŸ”„ åç»­ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

1. **æ€§èƒ½ç›‘æ§é¢æ¿**
   - å®æ—¶CPU/å†…å­˜/FPSå›¾è¡¨
   - å‘Šè­¦ç»Ÿè®¡ï¼ˆæ¯å°æ—¶/æ¯å¤©ï¼‰
   - ç³»ç»Ÿå¥åº·åº¦è¯„åˆ†

2. **å¤šæ¨¡å‹æ”¯æŒ**
   - è¿è¡Œæ—¶åˆ‡æ¢æ¨¡å‹ï¼ˆå®‰å…¨å¸½â†’è·Œå€’æ£€æµ‹ï¼‰
   - æ¨¡å‹çƒ­åŠ è½½

3. **ç±»åˆ«æ–‡ä»¶åŠ è½½**
   - æ”¯æŒä¸­æ–‡æ ‡ç­¾
   - è‡ªå®šä¹‰æ£€æµ‹ç±»åˆ«

### ä¸­æœŸä¼˜åŒ–ï¼ˆ1ä¸ªæœˆï¼‰

1. **åˆ†å¸ƒå¼éƒ¨ç½²**
   - å¤šå°è¾¹ç¼˜æœåŠ¡å™¨
   - è´Ÿè½½å‡è¡¡

2. **å½•åƒå›æ”¾**
   - ä¿å­˜æ£€æµ‹è§†é¢‘
   - äº‹ä»¶å›æ”¾

3. **é«˜çº§å‘Šè­¦è§„åˆ™**
   - äººæ•°ç»Ÿè®¡å‘Šè­¦
   - åŒºåŸŸå…¥ä¾µæ—¶é•¿å‘Šè­¦
   - è·¨åŒºåŸŸè¿½è¸ªå‘Šè­¦

### é•¿æœŸä¼˜åŒ–ï¼ˆ3ä¸ªæœˆï¼‰

1. **GPUåŠ é€Ÿå®Œå–„**
   - æ”¯æŒCUDA 12.8
   - æˆ–DirectML

2. **äº‘ç«¯é›†æˆ**
   - è¾¹ç¼˜-äº‘ååŒ
   - æ¨¡å‹è¿œç¨‹æ›´æ–°

3. **æ™ºèƒ½åˆ†æ**
   - è¡Œä¸ºåˆ†æï¼ˆå¾˜å¾Šã€å¥”è·‘ï¼‰
   - è½¨è¿¹åˆ†æ
   - çƒ­åŠ›å›¾

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [TASKæ¨¡å—å¼€å‘æŒ‡å¼•.md](./TASKæ¨¡å—å¼€å‘æŒ‡å¼•.md) - è¯¦ç»†æŠ€æœ¯å®ç°
- [æ¶æ„åˆ†æä¸å¼€å‘è·¯çº¿å›¾.md](./æ¶æ„åˆ†æä¸å¼€å‘è·¯çº¿å›¾.md) - ç³»ç»Ÿæ¶æ„åˆ†æ
- [ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æŒ‡å—.md](./ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æŒ‡å—.md) - HTTP-FLVéƒ¨ç½²æŒ‡å—

---

## ğŸ‰ æ€»ç»“

**ä½ çš„C++ TASKæ¨¡å— = VIDEOæ¨¡å— + AIèƒ½åŠ›**

| å¯¹æ¯”é¡¹ | VIDEO (Python) | TASK (C++) |
|--------|---------------|-----------|
| åŠŸèƒ½ | ä»…è½¬å‘è§†é¢‘ | âœ… AIæ£€æµ‹+ç”»æ¡†+å‘Šè­¦ |
| æ€§èƒ½ | ä¸­ç­‰ | âœ… é«˜æ€§èƒ½ï¼ˆC++åŸç”Ÿï¼‰ |
| ç®¡ç† | æ‰‹åŠ¨ | âœ… å‰ç«¯APIæ§åˆ¶ |
| å¹¶å‘ | ~10è·¯ | âœ… 50è·¯+ |
| å‘Šè­¦ | âŒ | âœ… åŒºåŸŸæ£€æµ‹+è§„åˆ™å¼•æ“ |

**å¼€å‘æ—¶é—´ä¼°ç®—**ï¼š
- é˜¶æ®µ1ï¼ˆTASKè¡¥å…¨ï¼‰ï¼š3-4å¤©
- é˜¶æ®µ2ï¼ˆTaskManagerï¼‰ï¼š2-3å¤©
- é˜¶æ®µ3ï¼ˆå‰ç«¯é›†æˆï¼‰ï¼š2-3å¤©
- é˜¶æ®µ4ï¼ˆè§†é¢‘å¢™ï¼‰ï¼š1-2å¤©
- **æ€»è®¡ï¼š8-12å¤©**

**å®Œæˆåï¼Œä½ å°†æ‹¥æœ‰**ï¼š
âœ… å‰ç«¯ä¸€é”®å¯åŠ¨50è·¯AIæ£€æµ‹ä»»åŠ¡  
âœ… å®æ—¶è§†é¢‘å¢™å±•ç¤º  
âœ… åŒºåŸŸå‘Šè­¦+è§„åˆ™å¼•æ“é›†æˆ  
âœ… å®Œæ•´çš„å•†ç”¨çº§AIè§†é¢‘ç›‘æ§ç³»ç»Ÿ  

---

**å‡†å¤‡å¥½å¼€å§‹äº†å—ï¼Ÿ** ğŸš€


**ç›®æ ‡**: å®ç°50è·¯æ‘„åƒå¤´çš„å‰ç«¯é…ç½®ã€AIæ£€æµ‹ã€å®æ—¶æ’­æ”¾å’Œå‘Šè­¦ç®¡ç†

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-24

---

## ğŸ¯ ç³»ç»Ÿæ¶æ„å¯¹æ¯”

### å½“å‰æ¶æ„ï¼ˆVIDEOæ¨¡å—ï¼‰

```
æ‘„åƒå¤´(RTSP) â†’ VIDEO(Python) â†’ FFmpegè½¬ç  â†’ RTMPæ¨æµ â†’ ZLMediaKit â†’ HTTP-FLV â†’ å‰ç«¯æ’­æ”¾
                     â†“
                åªæ˜¯è½¬å‘è§†é¢‘
                æ²¡æœ‰AIå¤„ç†
```

**å‰ç«¯é¡µé¢**ï¼š`WEB/src/views/camera/index.vue`
- âœ… æ‘„åƒå¤´åˆ—è¡¨å±•ç¤º
- âœ… å¯åŠ¨/åœæ­¢RTSPè½¬å‘
- âœ… è§†é¢‘æ’­æ”¾ï¼ˆDialogPlayerï¼‰
- âœ… æµçŠ¶æ€ç›‘æ§
- âš ï¸ **æ²¡æœ‰AIæ£€æµ‹åŠŸèƒ½**

---

### ç›®æ ‡æ¶æ„ï¼ˆTASKæ¨¡å—ï¼‰

```
50è·¯æ‘„åƒå¤´(RTSP) â†’ TaskManager(C++) â†’ 50ä¸ªTASKå®ä¾‹(C++)
                         â†“                    â†“
                    HTTP APIç®¡ç†          YOLOæ¨ç†+ç”»æ¡†
                    (ç«¯å£7000)                 â†“
                         â†“              RTMPæ¨æµ(å¸¦æ£€æµ‹æ¡†)
                         â†“                    â†“
                    å‰ç«¯é…ç½®ç®¡ç†          ZLMediaKit(80)
                         â†“                    â†“
                    å¯åŠ¨/åœæ­¢/æŸ¥è¯¢        HTTP-FLVæ’­æ”¾
                         â†“                    â†“
                    å‘Šè­¦è§„åˆ™é…ç½®          å‰ç«¯è§†é¢‘å¢™å±•ç¤º
```

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… **AIå®æ—¶æ£€æµ‹**ï¼ˆYOLOv11ï¼‰
- âœ… **æ£€æµ‹æ¡†æ ‡æ³¨**ï¼ˆOpenCVï¼‰
- âœ… **åŒºåŸŸå‘Šè­¦**ï¼ˆå¤šè¾¹å½¢ROIï¼‰
- âœ… **å‰ç«¯ç®¡ç†**ï¼ˆTaskManager APIï¼‰
- âœ… **50è·¯å¹¶å‘**ï¼ˆå¤šTASKå®ä¾‹ï¼‰

---

## ğŸ“Š ä½ çš„å‰ç«¯é¡µé¢é•¿è¿™æ ·ï¼ˆç°çŠ¶åˆ†æï¼‰

### 1. æ‘„åƒå¤´ç®¡ç†é¡µé¢ (`camera/index.vue`)

**è¡¨æ ¼åˆ—**ï¼š
| åˆ—å | æ•°æ® | è¯´æ˜ |
|------|------|------|
| è®¾å¤‡ID | `id` | å”¯ä¸€æ ‡è¯† |
| è®¾å¤‡åç§° | `name` | ç”¨æˆ·è‡ªå®šä¹‰ |
| åœ¨çº¿çŠ¶æ€ | `online` | ç»¿è‰²/çº¢è‰²æ ‡ç­¾ |
| æ‹‰æµåœ°å€ | `source` | RTSP URL |
| æ¨æµåœ°å€ | `rtmp_stream` | RTMP URLï¼ˆVIDEOæ¨¡å—æ¨é€ï¼‰ |
| **æ’­æ”¾åœ°å€** | `http_stream` | **HTTP-FLVï¼ˆå‰ç«¯æ’­æ”¾ï¼‰** |
| æµçŠ¶æ€ | `stream_status` | running/stopped/error |

**æ“ä½œæŒ‰é’®**ï¼š
- ğŸ¬ æ’­æ”¾RTMPæµ
- â–¶ï¸ å¯åŠ¨RTSPè½¬å‘ â†’ è°ƒç”¨ `startStreamForwarding(device_id)`
- â¸ï¸ åœæ­¢RTSPè½¬å‘ â†’ è°ƒç”¨ `stopStreamForwarding(device_id)`
- âœï¸ ç¼–è¾‘ / ğŸ—‘ï¸ åˆ é™¤

**åç«¯API**ï¼š
```typescript
// WEB/src/api/device/camera.ts
startStreamForwarding(device_id)  // POST /video/camera/device/{id}/stream/start
stopStreamForwarding(device_id)   // POST /video/camera/device/{id}/stream/stop
getStreamStatus(device_id)        // GET  /video/camera/device/{id}/stream/status
```

---

### 2. è§†é¢‘æ’­æ”¾å™¨ (`DialogPlayer.vue`)

**æ’­æ”¾å™¨**ï¼šJessibucaï¼ˆæ”¯æŒHTTP-FLVï¼‰

**æ˜¾ç¤ºå†…å®¹**ï¼š
- è§†é¢‘ç”»é¢ï¼ˆå®æ—¶æµï¼‰
- æ’­æ”¾åœ°å€ï¼ˆå¯å¤åˆ¶ï¼‰
- PTZäº‘å°æ§åˆ¶ï¼ˆä¸Šä¸‹å·¦å³ã€å˜ç„¦ï¼‰

---

## ğŸš€ å®Œæ•´å¼€å‘è·¯çº¿

### âœ… é˜¶æ®µ0ï¼šå½“å‰çŠ¶æ€ï¼ˆå·²æœ‰åŸºç¡€ï¼‰

ä½ å·²ç»æœ‰ï¼š
- âœ… å®Œæ•´çš„å‰ç«¯æ‘„åƒå¤´ç®¡ç†é¡µé¢
- âœ… VIDEOæ¨¡å—ï¼ˆPythonï¼‰çš„RTSPâ†’RTMPè½¬å‘
- âœ… ZLMediaKitæµåª’ä½“æœåŠ¡å™¨
- âœ… HTTP-FLVæ’­æ”¾å™¨ï¼ˆJessibucaï¼‰
- âœ… TASKæ¨¡å—ï¼ˆC++ï¼‰åŸºç¡€AIæ¨ç†

---

### ğŸ”¨ é˜¶æ®µ1ï¼šTASKæ¨¡å—è¡¥å…¨æ ¸å¿ƒåŠŸèƒ½ï¼ˆ3-4å¤©ï¼‰

**ç›®æ ‡**ï¼šè®©å•ä¸ªTASKå®ä¾‹èƒ½æ­£å¸¸å·¥ä½œ

#### Day 1-2: RTMPæ¨æµåŠŸèƒ½

**ä»»åŠ¡**ï¼š
```cpp
// å®ç° TASK/src/RTMPEncoder.cpp
class RTMPEncoder {
    bool init(rtmpUrl, width, height, fps);
    bool encodeAndPush(cv::Mat frame);  // æ¨é€å¸¦æ£€æµ‹æ¡†çš„å¸§
    void release();
};
```

**é›†æˆåˆ°Detech.cpp**ï¼š
```cpp
// åœ¨AIæ¨ç†+ç”»æ¡†ä¹‹å
if (_config.enableRtmp && _rtmpEncoder) {
    _rtmpEncoder->encodeAndPush(frameWithBoxes);
}
```

**é…ç½®æ–‡ä»¶** (`config/task1.ini`)ï¼š
```ini
[rtmp]
enable=true
rtmp_url=rtmp://localhost:1935/live/camera_1
```

**éªŒè¯**ï¼š
```bash
# å¯åŠ¨TASK
.\TASK.exe ..\..\config\task1.ini

# æ’­æ”¾éªŒè¯ï¼ˆåº”è¯¥çœ‹åˆ°å¸¦æ£€æµ‹æ¡†çš„è§†é¢‘ï¼‰
ffplay rtmp://localhost:1935/live/camera_1

# æˆ–åœ¨å‰ç«¯æ’­æ”¾
http://localhost/live/camera_1.flv
```

---

#### Day 3: åŒºåŸŸæ£€æµ‹ï¼ˆROIï¼‰

**ä»»åŠ¡**ï¼š
```cpp
// å®ç° TASK/src/AlarmRegion.cpp
struct AlarmRegion {
    std::string regionId;
    std::vector<cv::Point> polygon;
    std::vector<int> targetClasses;
    float confidenceThreshold;
};

bool isInAlarmRegion(const DetectObject& obj, const AlarmRegion& region) {
    cv::Point center(obj.box.x + obj.box.width/2, 
                     obj.box.y + obj.box.height/2);
    return cv::pointPolygonTest(region.polygon, center, false) >= 0;
}
```

**é…ç½®æ–‡ä»¶**ï¼š
```ini
[alarm_region_1]
enable=true
region_id=entrance
polygon=100,100;500,100;500,400;100,400
target_classes=0  # personç±»åˆ«
confidence_threshold=0.7
```

**éªŒè¯**ï¼š
- åŒºåŸŸå†…æ£€æµ‹ â†’ è§¦å‘å‘Šè­¦ âœ…
- åŒºåŸŸå¤–æ£€æµ‹ â†’ ä¸è§¦å‘å‘Šè­¦ âœ…

---

#### Day 4: èµ„æºé‡Šæ”¾å®Œå–„

**ä»»åŠ¡**ï¼š
```cpp
void Detech::releaseResources() {
    // é‡Šæ”¾FFmpegã€YOLOã€RTMPç¼–ç å™¨ç­‰èµ„æº
    if (_rtmpEncoder) {
        _rtmpEncoder->release();
        delete _rtmpEncoder;
    }
    // ...
}
```

**éªŒè¯**ï¼š
```bash
# é•¿æ—¶é—´è¿è¡Œæµ‹è¯•ï¼ˆ24å°æ—¶ï¼‰
# ç›‘æ§å†…å­˜å ç”¨æ˜¯å¦ç¨³å®š
```

---

### ğŸ”§ é˜¶æ®µ2ï¼šTaskManagerè¿›ç¨‹ç®¡ç†å™¨ï¼ˆ2-3å¤©ï¼‰

**ç›®æ ‡**ï¼šå®ç°HTTP APIç®¡ç†50ä¸ªTASKå®ä¾‹

#### Day 5-6: TaskManageræ ¸å¿ƒåŠŸèƒ½

**æ–°å»ºæ–‡ä»¶**ï¼š`TASK/src/TaskManager.cpp`

```cpp
class TaskManager {
private:
    std::map<int, std::unique_ptr<Detech>> tasks;  // task_id â†’ TASKå®ä¾‹
    httplib::Server server;                        // HTTPæœåŠ¡å™¨
    
public:
    TaskManager(int port = 7000);
    
    // APIæ¥å£
    void startTask(int taskId, const std::string& configPath);
    void stopTask(int taskId);
    json getTaskStatus(int taskId);
    json getAllTasks();
    
    void run();  // å¯åŠ¨HTTPæœåŠ¡å™¨
};
```

**HTTP APIè®¾è®¡**ï¼š

| æ¥å£ | æ–¹æ³• | è¯´æ˜ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| `/task/start` | POST | å¯åŠ¨TASK | `{"task_id": 1, "config_path": "config/task1.ini"}` | `{"code": 0, "msg": "å¯åŠ¨æˆåŠŸ"}` |
| `/task/stop` | POST | åœæ­¢TASK | `{"task_id": 1}` | `{"code": 0, "msg": "åœæ­¢æˆåŠŸ"}` |
| `/task/status` | GET | æŸ¥è¯¢çŠ¶æ€ | `?task_id=1` | `{"code": 0, "data": {"status": "running", "fps": 25}}` |
| `/task/list` | GET | ä»»åŠ¡åˆ—è¡¨ | æ—  | `{"code": 0, "data": [{...}, {...}]}` |
| `/config/generate` | POST | ç”Ÿæˆé…ç½® | JSONé…ç½® | `{"code": 0, "config_path": "config/task1.ini"}` |

**å®ç°ç¤ºä¾‹**ï¼š
```cpp
void TaskManager::setupRoutes() {
    // POST /task/start
    server.Post("/task/start", [this](const httplib::Request& req, httplib::Response& res) {
        auto json = nlohmann::json::parse(req.body);
        int taskId = json["task_id"];
        std::string configPath = json["config_path"];
        
        try {
            startTask(taskId, configPath);
            res.set_content(R"({"code": 0, "msg": "Task started"})", "application/json");
        } catch (const std::exception& e) {
            res.set_content(R"({"code": -1, "msg": ")" + std::string(e.what()) + R"("})", "application/json");
        }
    });
    
    // GET /task/status
    server.Get("/task/status", [this](const httplib::Request& req, httplib::Response& res) {
        int taskId = std::stoi(req.get_param_value("task_id"));
        auto status = getTaskStatus(taskId);
        res.set_content(status.dump(), "application/json");
    });
    
    // æ›´å¤šè·¯ç”±...
}

void TaskManager::startTask(int taskId, const std::string& configPath) {
    if (tasks.find(taskId) != tasks.end()) {
        throw std::runtime_error("Task already running");
    }
    
    // åˆ›å»ºæ–°çš„TASKå®ä¾‹
    auto task = std::make_unique<Detech>(configPath);
    task->init();
    task->runAsync();  // å¼‚æ­¥è¿è¡Œ
    
    tasks[taskId] = std::move(task);
    LOG(INFO) << "[TaskManager] Task " << taskId << " started";
}
```

**ç¼–è¯‘é…ç½®** (`CMakeLists.txt`)ï¼š
```cmake
# æ·»åŠ TaskManagerå¯æ‰§è¡Œæ–‡ä»¶
add_executable(TaskManager
    src/TaskManager.cpp
    src/Detech.cpp
    src/Yolov11Engine.cpp
    # ...
)

target_link_libraries(TaskManager
    cpp-httplib
    nlohmann_json
    # å…¶ä»–åº“...
)
```

**éªŒè¯**ï¼š
```bash
# å¯åŠ¨TaskManager
.\TaskManager.exe

# æµ‹è¯•API
curl -X POST http://localhost:7000/task/start \
  -H "Content-Type: application/json" \
  -d '{"task_id": 1, "config_path": "config/task1.ini"}'

# æŸ¥è¯¢çŠ¶æ€
curl http://localhost:7000/task/status?task_id=1

# ä»»åŠ¡åˆ—è¡¨
curl http://localhost:7000/task/list
```

---

#### Day 7: é…ç½®æ–‡ä»¶ç”Ÿæˆå™¨

**ä»»åŠ¡**ï¼šå®ç°JSONâ†’INIé…ç½®ç”Ÿæˆ

```cpp
// POST /config/generate
server.Post("/config/generate", [](const httplib::Request& req, httplib::Response& res) {
    auto json = nlohmann::json::parse(req.body);
    
    int taskId = json["task_id"];
    std::string configPath = "config/task" + std::to_string(taskId) + ".ini";
    
    // ç”ŸæˆINIæ–‡ä»¶
    std::ofstream file(configPath);
    file << "[task]\n";
    file << "task_id=" << taskId << "\n\n";
    
    file << "[video]\n";
    file << "source=" << json["video"]["source"].get<std::string>() << "\n";
    file << "width=" << json["video"]["width"] << "\n";
    file << "height=" << json["video"]["height"] << "\n\n";
    
    file << "[model]\n";
    file << "model_path=" << json["model"]["model_path"].get<std::string>() << "\n";
    file << "confidence_threshold=" << json["model"]["confidence_threshold"] << "\n\n";
    
    file << "[rtmp]\n";
    file << "enable=true\n";
    file << "rtmp_url=" << json["rtmp"]["rtmp_url"].get<std::string>() << "\n\n";
    
    file << "[alarm]\n";
    file << "enable=" << (json["alarm"]["enable"].get<bool>() ? "true" : "false") << "\n";
    file << "hook_url=" << json["alarm"]["hook_url"].get<std::string>() << "\n";
    file << "confidence_threshold=" << json["alarm"]["confidence_threshold"] << "\n";
    file << "cooldown_time=" << json["alarm"]["cooldown_time"] << "\n\n";
    
    // åŒºåŸŸé…ç½®
    if (json.contains("regions")) {
        int regionIdx = 1;
        for (auto& region : json["regions"]) {
            file << "[alarm_region_" << regionIdx++ << "]\n";
            file << "enable=true\n";
            file << "region_id=" << region["region_id"].get<std::string>() << "\n";
            
            // polygon: [[x1,y1], [x2,y2], ...]  â†’  x1,y1;x2,y2;...
            std::string polygonStr;
            for (auto& point : region["polygon"]) {
                if (!polygonStr.empty()) polygonStr += ";";
                polygonStr += std::to_string(point[0].get<int>()) + "," + 
                              std::to_string(point[1].get<int>());
            }
            file << "polygon=" << polygonStr << "\n";
            
            // target_classes
            std::string classesStr;
            for (auto& cls : region["target_classes"]) {
                if (!classesStr.empty()) classesStr += ",";
                classesStr += std::to_string(cls.get<int>());
            }
            file << "target_classes=" << classesStr << "\n";
            file << "confidence_threshold=" << region["confidence_threshold"] << "\n\n";
        }
    }
    
    file.close();
    
    nlohmann::json response = {
        {"code", 0},
        {"msg", "Config file generated"},
        {"config_path", configPath}
    };
    res.set_content(response.dump(), "application/json");
});
```

**æµ‹è¯•è¯·æ±‚**ï¼š
```json
POST http://localhost:7000/config/generate
Content-Type: application/json

{
  "task_id": 1,
  "video": {
    "source": "rtsp://admin:Admin123@192.168.1.100:554/stream1",
    "width": 1920,
    "height": 1080
  },
  "model": {
    "model_path": "models/SafeHat.onnx",
    "confidence_threshold": 0.5
  },
  "rtmp": {
    "rtmp_url": "rtmp://localhost:1935/live/camera_1"
  },
  "alarm": {
    "enable": true,
    "hook_url": "http://localhost:48080/admin-api/alarm/callback/1",
    "confidence_threshold": 0.6,
    "cooldown_time": 10
  },
  "regions": [
    {
      "region_id": "entrance",
      "polygon": [[100,100], [500,100], [500,400], [100,400]],
      "target_classes": [0],
      "confidence_threshold": 0.7
    }
  ]
}
```

---

### ğŸ¨ é˜¶æ®µ3ï¼šå‰ç«¯é›†æˆTaskManagerï¼ˆ2-3å¤©ï¼‰

**ç›®æ ‡**ï¼šå‰ç«¯èƒ½é€šè¿‡Webç•Œé¢ç®¡ç†50è·¯TASK

#### Day 8-9: å‰ç«¯APIå¯¹æ¥

**æ–°å»ºAPIæ–‡ä»¶**ï¼š`WEB/src/api/task/index.ts`

```typescript
import {defHttp} from '@/utils/http/axios';

// TaskManager APIåŸºç¡€è·¯å¾„ï¼ˆé€šè¿‡ä»£ç†ï¼‰
const TASK_API_BASE = '/dev-api/task';

// ====================== TASKç®¡ç†æ¥å£ ======================

export interface TaskConfig {
  task_id: number;
  video: {
    source: string;
    width: number;
    height: number;
  };
  model: {
    model_path: string;
    confidence_threshold: number;
  };
  rtmp: {
    rtmp_url: string;
  };
  alarm: {
    enable: boolean;
    hook_url: string;
    confidence_threshold: number;
    cooldown_time: number;
  };
  regions?: Array<{
    region_id: string;
    polygon: number[][];
    target_classes: number[];
    confidence_threshold: number;
  }>;
}

export interface TaskStatus {
  task_id: number;
  status: 'running' | 'stopped' | 'error';
  fps: number;
  frame_count: number;
  uptime: number;
  rtmp_url: string;
}

// å¯åŠ¨TASK
export const startTask = (taskId: number, configPath: string) => {
  return defHttp.post({
    url: `${TASK_API_BASE}/task/start`,
    data: { task_id: taskId, config_path: configPath }
  });
};

// åœæ­¢TASK
export const stopTask = (taskId: number) => {
  return defHttp.post({
    url: `${TASK_API_BASE}/task/stop`,
    data: { task_id: taskId }
  });
};

// æŸ¥è¯¢TASKçŠ¶æ€
export const getTaskStatus = (taskId: number) => {
  return defHttp.get<TaskStatus>({
    url: `${TASK_API_BASE}/task/status`,
    params: { task_id: taskId }
  });
};

// è·å–æ‰€æœ‰TASKåˆ—è¡¨
export const getTaskList = () => {
  return defHttp.get<TaskStatus[]>({
    url: `${TASK_API_BASE}/task/list`
  });
};

// ç”Ÿæˆé…ç½®æ–‡ä»¶
export const generateConfig = (config: TaskConfig) => {
  return defHttp.post({
    url: `${TASK_API_BASE}/config/generate`,
    data: config
  });
};
```

**é…ç½®å‰ç«¯ä»£ç†**ï¼š`WEB/.env.development`

```javascript
VITE_PROXY = [
  ["/api/v1/buckets", "http://localhost:9000/api/v1/buckets"],
  ["/dev-api/nodeRed", "http://127.0.0.1:1880"],
  ["/dev-api/task", "http://127.0.0.1:7000"],        // æ–°å¢TaskManagerä»£ç†
  ["/dev-api", "http://127.0.0.1:48080/admin-api"]
]
```

---

#### Day 10: å‰ç«¯é¡µé¢æ‰©å±•

**æ–¹æ¡ˆ1ï¼šæ‰©å±•ç°æœ‰æ‘„åƒå¤´é¡µé¢**

åœ¨ `WEB/src/views/camera/index.vue` ä¸­æ·»åŠ "AIä»»åŠ¡"åŠŸèƒ½ï¼š

```vue
<template>
  <div class="camera-container">
    <!-- åŸæœ‰æ‘„åƒå¤´åˆ—è¡¨ -->
    <BasicTable @register="registerTable">
      <!-- ... -->
      <template #bodyCell="{ column, record }">
        <!-- æ–°å¢æ“ä½œæŒ‰é’® -->
        <template v-if="column.dataIndex === 'action'">
          <TableAction :actions="getTableActions(record)" />
        </template>
      </template>
    </BasicTable>
  </div>
</template>

<script lang="ts" setup>
import { startTask, stopTask, getTaskStatus } from '@/api/task';

// æ‰©å±•æ“ä½œæŒ‰é’®
const getTableActions = (record) => {
  const actions = [
    {
      icon: 'octicon:play-16',
      tooltip: 'æ’­æ”¾è§†é¢‘',
      onClick: () => handlePlay(record)
    },
    {
      icon: 'ant-design:robot-outlined',
      tooltip: 'å¯åŠ¨AIæ£€æµ‹',
      onClick: () => handleStartAI(record)  // æ–°å¢ï¼šå¯åŠ¨AIä»»åŠ¡
    },
    {
      icon: 'ant-design:stop-outlined',
      tooltip: 'åœæ­¢AIæ£€æµ‹',
      onClick: () => handleStopAI(record)   // æ–°å¢ï¼šåœæ­¢AIä»»åŠ¡
    },
    // ... å…¶ä»–æŒ‰é’®
  ];
  return actions;
};

// å¯åŠ¨AIæ£€æµ‹ä»»åŠ¡
const handleStartAI = async (record) => {
  try {
    createMessage.loading({ content: 'æ­£åœ¨å¯åŠ¨AIæ£€æµ‹...', key: 'ai' });
    
    // 1. ç”Ÿæˆé…ç½®æ–‡ä»¶
    const config = {
      task_id: parseInt(record.id),
      video: {
        source: record.source,  // RTSPåœ°å€
        width: 1920,
        height: 1080
      },
      model: {
        model_path: 'models/SafeHat.onnx',
        confidence_threshold: 0.5
      },
      rtmp: {
        rtmp_url: `rtmp://localhost:1935/live/ai_camera_${record.id}`
      },
      alarm: {
        enable: true,
        hook_url: `http://localhost:48080/admin-api/alarm/callback/${record.id}`,
        confidence_threshold: 0.6,
        cooldown_time: 10
      }
    };
    
    const configRes = await generateConfig(config);
    
    // 2. å¯åŠ¨TASK
    await startTask(parseInt(record.id), configRes.data.config_path);
    
    createMessage.success({ content: 'AIæ£€æµ‹å·²å¯åŠ¨', key: 'ai' });
    
    // 3. æ›´æ–°æ’­æ”¾åœ°å€ä¸ºAIæ¨æµåœ°å€
    record.http_stream = `http://localhost/live/ai_camera_${record.id}.flv`;
    reload();
    
  } catch (error) {
    console.error('å¯åŠ¨AIæ£€æµ‹å¤±è´¥', error);
    createMessage.error({ content: 'å¯åŠ¨AIæ£€æµ‹å¤±è´¥', key: 'ai' });
  }
};

// åœæ­¢AIæ£€æµ‹ä»»åŠ¡
const handleStopAI = async (record) => {
  try {
    createMessage.loading({ content: 'æ­£åœ¨åœæ­¢AIæ£€æµ‹...', key: 'ai' });
    await stopTask(parseInt(record.id));
    createMessage.success({ content: 'AIæ£€æµ‹å·²åœæ­¢', key: 'ai' });
    reload();
  } catch (error) {
    console.error('åœæ­¢AIæ£€æµ‹å¤±è´¥', error);
    createMessage.error({ content: 'åœæ­¢AIæ£€æµ‹å¤±è´¥', key: 'ai' });
  }
};
</script>
```

**æ•ˆæœ**ï¼š
- æ¯ä¸ªæ‘„åƒå¤´éƒ½æœ‰"å¯åŠ¨AIæ£€æµ‹"å’Œ"åœæ­¢AIæ£€æµ‹"æŒ‰é’®
- ç‚¹å‡»"å¯åŠ¨AIæ£€æµ‹" â†’ è‡ªåŠ¨ç”Ÿæˆé…ç½® â†’ å¯åŠ¨TASKå®ä¾‹ â†’ æ’­æ”¾åœ°å€åˆ‡æ¢ä¸ºAIæµ
- ç‚¹å‡»"æ’­æ”¾" â†’ çœ‹åˆ°å¸¦æ£€æµ‹æ¡†çš„å®æ—¶ç”»é¢

---

**æ–¹æ¡ˆ2ï¼šæ–°å»ºAIä»»åŠ¡ç®¡ç†é¡µé¢**ï¼ˆæ¨èï¼‰

æ–°å»ºæ–‡ä»¶ï¼š`WEB/src/views/ai-task/index.vue`

```vue
<template>
  <div class="ai-task-container">
    <BasicTable @register="registerTable">
      <template #toolbar>
        <a-button type="primary" @click="openConfigModal">
          <template #icon>
            <RobotOutlined/>
          </template>
          æ–°å»ºAIæ£€æµ‹ä»»åŠ¡
        </a-button>
        <a-button @click="reloadAllStatus">
          <template #icon>
            <SyncOutlined/>
          </template>
          åˆ·æ–°çŠ¶æ€
        </a-button>
      </template>

      <template #bodyCell="{ column, record }">
        <!-- AIä»»åŠ¡çŠ¶æ€ -->
        <template v-if="column.dataIndex === 'status'">
          <a-tag :color="getStatusColor(record.status)">
            {{ getStatusText(record.status) }}
          </a-tag>
        </template>

        <!-- FPSæ˜¾ç¤º -->
        <template v-else-if="column.dataIndex === 'fps'">
          <span>{{ record.fps }} fps</span>
        </template>

        <!-- æ“ä½œ -->
        <template v-else-if="column.dataIndex === 'action'">
          <TableAction :actions="getTableActions(record)" />
        </template>
      </template>
    </BasicTable>

    <!-- AIä»»åŠ¡é…ç½®å¼¹çª— -->
    <AITaskConfigModal @register="registerConfigModal" @success="handleConfigSuccess"/>
  </div>
</template>

<script lang="ts" setup>
import {onMounted, ref} from 'vue';
import {BasicTable, TableAction, useTable} from '@/components/Table';
import {useMessage} from '@/hooks/web/useMessage';
import {useModal} from "@/components/Modal";
import {
  startTask,
  stopTask,
  getTaskList,
  getTaskStatus,
  generateConfig
} from '@/api/task';
import {RobotOutlined, SyncOutlined} from '@ant-design/icons-vue';
import AITaskConfigModal from './components/AITaskConfigModal.vue';

const {createMessage} = useMessage();
const [registerConfigModal, {openModal: openConfigModal}] = useModal();

// è¡¨æ ¼åˆ—å®šä¹‰
const columns = [
  { title: 'ä»»åŠ¡ID', dataIndex: 'task_id', width: 80 },
  { title: 'æ‘„åƒå¤´åç§°', dataIndex: 'camera_name', width: 150 },
  { title: 'çŠ¶æ€', dataIndex: 'status', width: 100 },
  { title: 'FPS', dataIndex: 'fps', width: 80 },
  { title: 'å¤„ç†å¸§æ•°', dataIndex: 'frame_count', width: 100 },
  { title: 'è¿è¡Œæ—¶é•¿', dataIndex: 'uptime', width: 100 },
  { title: 'RTMPæ¨æµåœ°å€', dataIndex: 'rtmp_url', width: 200 },
  { title: 'æ“ä½œ', dataIndex: 'action', width: 200 },
];

const [registerTable, {reload}] = useTable({
  title: 'AIæ£€æµ‹ä»»åŠ¡åˆ—è¡¨',
  api: getTaskList,
  columns: columns,
  pagination: true,
  rowKey: 'task_id',
});

// è·å–æ“ä½œæŒ‰é’®
const getTableActions = (record) => {
  const actions = [];
  
  if (record.status === 'running') {
    actions.push({
      icon: 'ant-design:pause-circle-outlined',
      tooltip: 'åœæ­¢ä»»åŠ¡',
      onClick: () => handleStop(record.task_id)
    });
  } else {
    actions.push({
      icon: 'ant-design:play-circle-outlined',
      tooltip: 'å¯åŠ¨ä»»åŠ¡',
      onClick: () => handleStart(record.task_id)
    });
  }
  
  actions.push(
    {
      icon: 'octicon:play-16',
      tooltip: 'æ’­æ”¾è§†é¢‘',
      onClick: () => handlePlay(record)
    },
    {
      icon: 'ant-design:setting-outlined',
      tooltip: 'é…ç½®',
      onClick: () => openConfigModal(record)
    },
    {
      icon: 'material-symbols:delete-outline-rounded',
      tooltip: 'åˆ é™¤',
      popConfirm: {
        title: 'ç¡®å®šåˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ',
        confirm: () => handleDelete(record.task_id)
      }
    }
  );
  
  return actions;
};

// å¯åŠ¨ä»»åŠ¡
const handleStart = async (taskId: number) => {
  try {
    await startTask(taskId, `config/task${taskId}.ini`);
    createMessage.success('ä»»åŠ¡å¯åŠ¨æˆåŠŸ');
    reload();
  } catch (error) {
    createMessage.error('ä»»åŠ¡å¯åŠ¨å¤±è´¥');
  }
};

// åœæ­¢ä»»åŠ¡
const handleStop = async (taskId: number) => {
  try {
    await stopTask(taskId);
    createMessage.success('ä»»åŠ¡åœæ­¢æˆåŠŸ');
    reload();
  } catch (error) {
    createMessage.error('ä»»åŠ¡åœæ­¢å¤±è´¥');
  }
};

// çŠ¶æ€æ–‡æœ¬å’Œé¢œè‰²
const getStatusText = (status: string) => {
  const map = {
    'running': 'è¿è¡Œä¸­',
    'stopped': 'å·²åœæ­¢',
    'error': 'é”™è¯¯'
  };
  return map[status] || status;
};

const getStatusColor = (status: string) => {
  const map = {
    'running': 'green',
    'stopped': 'red',
    'error': 'orange'
  };
  return map[status] || 'default';
};
</script>
```

**æ–°å»ºé…ç½®å¼¹çª—**ï¼š`WEB/src/views/ai-task/components/AITaskConfigModal.vue`

```vue
<template>
  <BasicModal
    @register="register"
    title="é…ç½®AIæ£€æµ‹ä»»åŠ¡"
    width="800px"
    @ok="handleSubmit"
  >
    <BasicForm @register="registerForm" />
  </BasicModal>
</template>

<script lang="ts" setup>
import {BasicModal, useModalInner} from '@/components/Modal';
import {BasicForm, useForm} from '@/components/Form';
import {generateConfig, startTask} from '@/api/task';
import {useMessage} from '@/hooks/web/useMessage';

const {createMessage} = useMessage();
const emit = defineEmits(['success', 'register']);

const [registerForm, {validate, setFieldsValue, resetFields}] = useForm({
  labelWidth: 120,
  schemas: [
    {
      field: 'task_id',
      label: 'ä»»åŠ¡ID',
      component: 'InputNumber',
      required: true,
    },
    {
      field: 'camera_id',
      label: 'é€‰æ‹©æ‘„åƒå¤´',
      component: 'Select',
      componentProps: {
        options: [],  // ä»æ‘„åƒå¤´åˆ—è¡¨è·å–
        showSearch: true,
      },
      required: true,
    },
    {
      field: 'model_path',
      label: 'æ£€æµ‹æ¨¡å‹',
      component: 'Select',
      componentProps: {
        options: [
          { label: 'å®‰å…¨å¸½æ£€æµ‹', value: 'models/SafeHat.onnx' },
          { label: 'è·Œå€’æ£€æµ‹', value: 'models/FallDetect.onnx' },
          { label: 'é€šç”¨ç›®æ ‡æ£€æµ‹', value: 'models/yolov11n.onnx' },
        ],
      },
      required: true,
      defaultValue: 'models/SafeHat.onnx',
    },
    {
      field: 'confidence_threshold',
      label: 'æ£€æµ‹é˜ˆå€¼',
      component: 'Slider',
      componentProps: {
        min: 0,
        max: 1,
        step: 0.05,
        marks: {
          0.5: '0.5',
          0.7: '0.7',
        },
      },
      defaultValue: 0.6,
    },
    {
      field: 'enable_alarm',
      label: 'å¯ç”¨å‘Šè­¦',
      component: 'Switch',
      defaultValue: true,
    },
    {
      field: 'alarm_confidence',
      label: 'å‘Šè­¦é˜ˆå€¼',
      component: 'Slider',
      componentProps: {
        min: 0,
        max: 1,
        step: 0.05,
      },
      defaultValue: 0.7,
      ifShow: ({values}) => values.enable_alarm,
    },
    {
      field: 'cooldown_time',
      label: 'å‘Šè­¦å†·å´æ—¶é—´(ç§’)',
      component: 'InputNumber',
      componentProps: {
        min: 1,
        max: 60,
      },
      defaultValue: 10,
      ifShow: ({values}) => values.enable_alarm,
    },
  ],
  showActionButtonGroup: false,
});

const [register, {closeModal}] = useModalInner((data) => {
  resetFields();
  if (data) {
    setFieldsValue(data);
  }
});

const handleSubmit = async () => {
  try {
    const values = await validate();
    
    // æ„å»ºé…ç½®
    const config = {
      task_id: values.task_id,
      video: {
        source: values.camera_source,  // ä»æ‘„åƒå¤´ä¿¡æ¯è·å–
        width: 1920,
        height: 1080,
      },
      model: {
        model_path: values.model_path,
        confidence_threshold: values.confidence_threshold,
      },
      rtmp: {
        rtmp_url: `rtmp://localhost:1935/live/ai_task_${values.task_id}`,
      },
      alarm: {
        enable: values.enable_alarm,
        hook_url: `http://localhost:48080/admin-api/alarm/callback/${values.task_id}`,
        confidence_threshold: values.alarm_confidence,
        cooldown_time: values.cooldown_time,
      },
    };
    
    // 1. ç”Ÿæˆé…ç½®æ–‡ä»¶
    const configRes = await generateConfig(config);
    
    // 2. å¯åŠ¨ä»»åŠ¡
    await startTask(values.task_id, configRes.data.config_path);
    
    createMessage.success('AIä»»åŠ¡å¯åŠ¨æˆåŠŸ');
    emit('success');
    closeModal();
    
  } catch (error) {
    createMessage.error('é…ç½®å¤±è´¥');
  }
};
</script>
```

---

### ğŸ¬ é˜¶æ®µ4ï¼šè§†é¢‘å¢™å±•ç¤ºï¼ˆ1-2å¤©ï¼‰

**ç›®æ ‡**ï¼šåŒæ—¶å±•ç¤ºå¤šè·¯AIæ£€æµ‹è§†é¢‘

æ–°å»ºé¡µé¢ï¼š`WEB/src/views/ai-task/video-wall.vue`

```vue
<template>
  <div class="video-wall-container">
    <div class="video-wall-header">
      <h2>AIæ£€æµ‹è§†é¢‘å¢™ï¼ˆ{{ runningTasks.length }}/50è·¯ï¼‰</h2>
      <a-radio-group v-model:value="gridLayout" button-style="solid">
        <a-radio-button value="2x2">2x2</a-radio-button>
        <a-radio-button value="3x3">3x3</a-radio-button>
        <a-radio-button value="4x4">4x4</a-radio-button>
        <a-radio-button value="5x5">5x5</a-radio-button>
      </a-radio-group>
    </div>
    
    <div :class="`video-wall-grid grid-${gridLayout}`">
      <div 
        v-for="task in runningTasks" 
        :key="task.task_id"
        class="video-wall-item"
      >
        <!-- è§†é¢‘æ’­æ”¾å™¨ -->
        <Jessibuca 
          :playUrl="task.http_flv_url" 
          :hasAudio="false"
          class="video-player"
        />
        
        <!-- ä¿¡æ¯è¦†ç›–å±‚ -->
        <div class="video-info-overlay">
          <div class="video-title">{{ task.camera_name }}</div>
          <div class="video-stats">
            <span class="fps">{{ task.fps }} FPS</span>
            <span class="status" :class="task.status">{{ task.status }}</span>
          </div>
        </div>
        
        <!-- å‘Šè­¦æ ‡è¯† -->
        <div v-if="task.has_alarm" class="alarm-indicator">
          <WarningOutlined /> å‘Šè­¦ä¸­
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts" setup>
import {ref, onMounted, onUnmounted} from 'vue';
import {getTaskList} from '@/api/task';
import Jessibuca from '@/components/Player/module/jessibuca.vue';
import {WarningOutlined} from '@ant-design/icons-vue';

const gridLayout = ref('3x3');
const runningTasks = ref([]);
const updateTimer = ref(null);

// è·å–è¿è¡Œä¸­çš„ä»»åŠ¡
const fetchRunningTasks = async () => {
  try {
    const response = await getTaskList();
    runningTasks.value = response.data
      .filter(task => task.status === 'running')
      .map(task => ({
        ...task,
        http_flv_url: `http://localhost/live/ai_task_${task.task_id}.flv`,
      }));
  } catch (error) {
    console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥', error);
  }
};

onMounted(() => {
  fetchRunningTasks();
  // æ¯5ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
  updateTimer.value = setInterval(fetchRunningTasks, 5000);
});

onUnmounted(() => {
  if (updateTimer.value) {
    clearInterval(updateTimer.value);
  }
});
</script>

<style scoped lang="less">
.video-wall-container {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #000;
}

.video-wall-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: #1a1a1a;
  color: #fff;
}

.video-wall-grid {
  flex: 1;
  display: grid;
  gap: 8px;
  padding: 8px;
  
  &.grid-2x2 { grid-template-columns: repeat(2, 1fr); }
  &.grid-3x3 { grid-template-columns: repeat(3, 1fr); }
  &.grid-4x4 { grid-template-columns: repeat(4, 1fr); }
  &.grid-5x5 { grid-template-columns: repeat(5, 1fr); }
}

.video-wall-item {
  position: relative;
  background: #222;
  border-radius: 4px;
  overflow: hidden;
  
  &:hover .video-info-overlay {
    opacity: 1;
  }
}

.video-player {
  width: 100%;
  height: 100%;
}

.video-info-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
  padding: 8px;
  opacity: 0.7;
  transition: opacity 0.3s;
  
  .video-title {
    color: #fff;
    font-size: 14px;
    font-weight: bold;
  }
  
  .video-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 4px;
    
    .fps {
      color: #4caf50;
      font-size: 12px;
    }
    
    .status {
      font-size: 12px;
      &.running { color: #4caf50; }
      &.error { color: #f44336; }
    }
  }
}

.alarm-indicator {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #f44336;
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 49% { opacity: 1; }
  50%, 100% { opacity: 0.3; }
}
</style>
```

---

## ğŸ“‹ æœ€ç»ˆæ•ˆæœ

### 1. æ‘„åƒå¤´ç®¡ç†é¡µé¢ (`/camera`)
- âœ… ç®¡ç†æ‰€æœ‰æ‘„åƒå¤´è®¾å¤‡ï¼ˆONVIFæ‰«æã€æ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤ï¼‰
- âœ… å¯åŠ¨/åœæ­¢RTSPè½¬å‘ï¼ˆVIDEOæ¨¡å—ï¼‰
- âœ… **æ–°å¢ï¼šå¯åŠ¨/åœæ­¢AIæ£€æµ‹ï¼ˆTASKæ¨¡å—ï¼‰**

### 2. AIä»»åŠ¡ç®¡ç†é¡µé¢ (`/ai-task`)
- âœ… AIä»»åŠ¡åˆ—è¡¨ï¼ˆ50è·¯ï¼‰
- âœ… æ–°å»ºAIä»»åŠ¡ï¼ˆé…ç½®æ£€æµ‹æ¨¡å‹ã€é˜ˆå€¼ã€å‘Šè­¦è§„åˆ™ã€ROIåŒºåŸŸï¼‰
- âœ… å¯åŠ¨/åœæ­¢/åˆ é™¤ä»»åŠ¡
- âœ… å®æ—¶çŠ¶æ€ç›‘æ§ï¼ˆFPSã€å¸§æ•°ã€è¿è¡Œæ—¶é•¿ï¼‰

### 3. è§†é¢‘å¢™é¡µé¢ (`/ai-task/video-wall`)
- âœ… åŒæ—¶å±•ç¤ºå¤šè·¯AIæ£€æµ‹è§†é¢‘ï¼ˆ2x2 / 3x3 / 4x4 / 5x5å¸ƒå±€ï¼‰
- âœ… æ¯è·¯è§†é¢‘æ˜¾ç¤ºï¼šæ‘„åƒå¤´åç§°ã€FPSã€è¿è¡ŒçŠ¶æ€
- âœ… å‘Šè­¦é«˜äº®æ˜¾ç¤º

### 4. å®Œæ•´æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œå‰ç«¯ â†’ TaskManager(7000) â†’ TASKå®ä¾‹(C++) â†’ YOLOæ¨ç†+ç”»æ¡†
                    â†“                       â†“
              ç”Ÿæˆé…ç½®æ–‡ä»¶            RTMPæ¨æµ(å¸¦æ£€æµ‹æ¡†)
                                           â†“
                                    ZLMediaKit(80)
                                           â†“
                                    HTTP-FLVæ’­æ”¾
                                           â†“
                                    å‰ç«¯è§†é¢‘å¢™å±•ç¤º
```

---

## ğŸ¯ 50è·¯æ‘„åƒå¤´éƒ¨ç½²æ–¹æ¡ˆ

### ç¡¬ä»¶è¦æ±‚

| ç»„ä»¶ | é…ç½® | è¯´æ˜ |
|------|------|------|
| **CPU** | Intel i7-12700 æˆ–æ›´é«˜ | 50è·¯AIæ¨ç†éœ€è¦å¼ºCPU |
| **å†…å­˜** | 32GB+ | æ¯è·¯TASKçº¦500MBï¼Œ50è·¯éœ€25GB+ |
| **å­˜å‚¨** | 500GB SSD | æ¨¡å‹ã€é…ç½®ã€æ—¥å¿— |
| **ç½‘ç»œ** | åƒå…†ç½‘ç»œ | 50è·¯è§†é¢‘æµå¸¦å®½éœ€æ±‚å¤§ |
| **GPUï¼ˆå¯é€‰ï¼‰** | RTX 4070 æˆ–æ›´é«˜ | åŠ é€ŸAIæ¨ç†ï¼ˆå¯é€‰ï¼ŒCPUä¹Ÿèƒ½è·‘ï¼‰ |

### è½¯ä»¶æ¶æ„

```
è¾¹ç¼˜æœåŠ¡å™¨ï¼ˆä¸€å°ç‰©ç†æœºï¼‰
â”œâ”€â”€ ZLMediaKitï¼ˆæµåª’ä½“æœåŠ¡å™¨ï¼‰- 1ä¸ªå®ä¾‹
â”œâ”€â”€ TaskManagerï¼ˆè¿›ç¨‹ç®¡ç†å™¨ï¼‰- 1ä¸ªå®ä¾‹
â”‚   â”œâ”€â”€ TASKå®ä¾‹ #1ï¼ˆcamera_1ï¼‰
â”‚   â”œâ”€â”€ TASKå®ä¾‹ #2ï¼ˆcamera_2ï¼‰
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ TASKå®ä¾‹ #50ï¼ˆcamera_50ï¼‰
â””â”€â”€ PostgreSQL + MinIO + Node-REDï¼ˆåç«¯æœåŠ¡ï¼‰
```

**æ³¨æ„**ï¼š
- 50ä¸ªTASKå®ä¾‹éƒ½åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œ
- TaskManagerç»Ÿä¸€ç®¡ç†50ä¸ªè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ
- æ¯ä¸ªTASKç‹¬ç«‹é…ç½®æ–‡ä»¶ï¼Œç‹¬ç«‹RTMPæµ

### éƒ¨ç½²æ­¥éª¤

#### Step 1: å¯åŠ¨ZLMediaKit

```bash
cd F:\EASYLOT\zlmediakit
.\MediaServer.exe -c config.ini
```

#### Step 2: å¯åŠ¨TaskManager

```bash
cd F:\EASYLOT\easyaiot-main\TASK\build\Release
.\TaskManager.exe
```

TaskManagerä¼šï¼š
- ç›‘å¬7000ç«¯å£
- ç­‰å¾…å‰ç«¯å‘é€ä»»åŠ¡å¯åŠ¨è¯·æ±‚

#### Step 3: åœ¨å‰ç«¯é…ç½®50è·¯æ‘„åƒå¤´

```typescript
// æ‰¹é‡åˆ›å»ºä»»åŠ¡ç¤ºä¾‹
const cameras = [
  { id: 1, name: 'å¤§é—¨', rtsp: 'rtsp://192.168.1.101:554/stream1' },
  { id: 2, name: 'è½¦åº“', rtsp: 'rtsp://192.168.1.102:554/stream1' },
  // ... 48 more cameras
];

for (let camera of cameras) {
  await generateConfig({
    task_id: camera.id,
    video: { source: camera.rtsp, width: 1920, height: 1080 },
    model: { model_path: 'models/SafeHat.onnx', confidence_threshold: 0.5 },
    rtmp: { rtmp_url: `rtmp://localhost:1935/live/camera_${camera.id}` },
    alarm: {
      enable: true,
      hook_url: `http://localhost:48080/admin-api/alarm/callback/${camera.id}`,
      confidence_threshold: 0.6,
      cooldown_time: 10
    }
  });
  
  await startTask(camera.id, `config/task${camera.id}.ini`);
}
```

#### Step 4: æ‰“å¼€è§†é¢‘å¢™

è®¿é—®ï¼š`http://localhost:8099/ai-task/video-wall`

é€‰æ‹©5x5å¸ƒå±€ â†’ åŒæ—¶çœ‹åˆ°25è·¯è§†é¢‘ï¼ˆå¯æ»šåŠ¨æŸ¥çœ‹å…¨éƒ¨50è·¯ï¼‰

---

## ğŸ“Š æ€§èƒ½è¯„ä¼°

### å•è·¯TASKèµ„æºå ç”¨

| æŒ‡æ ‡ | CPUæ¨¡å¼ | GPUæ¨¡å¼ |
|------|---------|---------|
| **CPUå ç”¨** | ~10% (12æ ¸å¿ƒ) | ~5% |
| **å†…å­˜å ç”¨** | ~500MB | ~500MB |
| **æ˜¾å­˜å ç”¨** | N/A | ~2GB |
| **æ¨ç†é€Ÿåº¦** | 25-30 FPS | 100+ FPS |
| **å»¶è¿Ÿ** | ~1ç§’ | ~0.5ç§’ |

### 50è·¯å¹¶å‘é¢„ä¼°

| èµ„æº | CPUæ¨¡å¼ | GPUæ¨¡å¼ |
|------|---------|---------|
| **CPUå ç”¨** | ~80% (12æ ¸å¿ƒ) | ~40% |
| **å†…å­˜å ç”¨** | ~25GB | ~25GB |
| **æ˜¾å­˜å ç”¨** | N/A | ~8GB (RTX 4070) |
| **ç½‘ç»œå¸¦å®½** | ~200Mbps (å‡ºå£) | ~200Mbps |

**ç»“è®º**ï¼š
- CPUæ¨¡å¼å¯ä»¥è·‘50è·¯ï¼ˆä½†CPUä¼šæ»¡è½½ï¼‰
- GPUæ¨¡å¼æ›´è½»æ¾ï¼ˆæ¨èï¼‰

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] å•ä¸ªTASKå®ä¾‹æ­£å¸¸è¿è¡Œï¼ˆRTSPâ†’AIâ†’RTMPâ†’æ’­æ”¾ï¼‰
- [ ] TaskManageræˆåŠŸç®¡ç†50ä¸ªTASKå®ä¾‹
- [ ] å‰ç«¯èƒ½é€šè¿‡APIå¯åŠ¨/åœæ­¢ä»»æ„TASK
- [ ] å‰ç«¯èƒ½å®æ—¶æŸ¥çœ‹æ‰€æœ‰TASKçŠ¶æ€
- [ ] è§†é¢‘å¢™èƒ½åŒæ—¶æ’­æ”¾å¤šè·¯è§†é¢‘
- [ ] åŒºåŸŸå‘Šè­¦æ­£å¸¸è§¦å‘ï¼ˆåŒºåŸŸå†…æœ‰äººâ†’å‘Šè­¦ï¼ŒåŒºåŸŸå¤–æ— å‘Šè­¦ï¼‰
- [ ] å‘Šè­¦å›è°ƒåˆ°DEVICEæ¨¡å—ï¼Œè§¦å‘Node-REDè§„åˆ™

### æ€§èƒ½éªŒæ”¶

- [ ] å•è·¯TASK FPS â‰¥ 20
- [ ] 50è·¯TASKåŒæ—¶è¿è¡Œï¼Œç³»ç»Ÿç¨³å®š
- [ ] è§†é¢‘å»¶è¿Ÿ â‰¤ 2ç§’
- [ ] å†…å­˜æ— æ³„æ¼ï¼ˆ24å°æ—¶è¿è¡Œå†…å­˜å¢é•¿ < 10%ï¼‰
- [ ] CPUå ç”¨åˆç†ï¼ˆCPUæ¨¡å¼ < 90%ï¼‰

### ç”¨æˆ·ä½“éªŒéªŒæ”¶

- [ ] å‰ç«¯æ“ä½œæµç•…ï¼ˆå¯åŠ¨ä»»åŠ¡ < 3ç§’ï¼‰
- [ ] è§†é¢‘å¢™å¸ƒå±€å¯è°ƒæ•´ï¼ˆ2x2 / 3x3 / 4x4 / 5x5ï¼‰
- [ ] å‘Šè­¦å®æ—¶æ˜¾ç¤ºï¼ˆ< 1ç§’å»¶è¿Ÿï¼‰
- [ ] æ—¥å¿—å¯æŸ¥è¯¢ï¼ˆGlogè¾“å‡ºï¼‰

---

## ğŸ”„ åç»­ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

1. **æ€§èƒ½ç›‘æ§é¢æ¿**
   - å®æ—¶CPU/å†…å­˜/FPSå›¾è¡¨
   - å‘Šè­¦ç»Ÿè®¡ï¼ˆæ¯å°æ—¶/æ¯å¤©ï¼‰
   - ç³»ç»Ÿå¥åº·åº¦è¯„åˆ†

2. **å¤šæ¨¡å‹æ”¯æŒ**
   - è¿è¡Œæ—¶åˆ‡æ¢æ¨¡å‹ï¼ˆå®‰å…¨å¸½â†’è·Œå€’æ£€æµ‹ï¼‰
   - æ¨¡å‹çƒ­åŠ è½½

3. **ç±»åˆ«æ–‡ä»¶åŠ è½½**
   - æ”¯æŒä¸­æ–‡æ ‡ç­¾
   - è‡ªå®šä¹‰æ£€æµ‹ç±»åˆ«

### ä¸­æœŸä¼˜åŒ–ï¼ˆ1ä¸ªæœˆï¼‰

1. **åˆ†å¸ƒå¼éƒ¨ç½²**
   - å¤šå°è¾¹ç¼˜æœåŠ¡å™¨
   - è´Ÿè½½å‡è¡¡

2. **å½•åƒå›æ”¾**
   - ä¿å­˜æ£€æµ‹è§†é¢‘
   - äº‹ä»¶å›æ”¾

3. **é«˜çº§å‘Šè­¦è§„åˆ™**
   - äººæ•°ç»Ÿè®¡å‘Šè­¦
   - åŒºåŸŸå…¥ä¾µæ—¶é•¿å‘Šè­¦
   - è·¨åŒºåŸŸè¿½è¸ªå‘Šè­¦

### é•¿æœŸä¼˜åŒ–ï¼ˆ3ä¸ªæœˆï¼‰

1. **GPUåŠ é€Ÿå®Œå–„**
   - æ”¯æŒCUDA 12.8
   - æˆ–DirectML

2. **äº‘ç«¯é›†æˆ**
   - è¾¹ç¼˜-äº‘ååŒ
   - æ¨¡å‹è¿œç¨‹æ›´æ–°

3. **æ™ºèƒ½åˆ†æ**
   - è¡Œä¸ºåˆ†æï¼ˆå¾˜å¾Šã€å¥”è·‘ï¼‰
   - è½¨è¿¹åˆ†æ
   - çƒ­åŠ›å›¾

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [TASKæ¨¡å—å¼€å‘æŒ‡å¼•.md](./TASKæ¨¡å—å¼€å‘æŒ‡å¼•.md) - è¯¦ç»†æŠ€æœ¯å®ç°
- [æ¶æ„åˆ†æä¸å¼€å‘è·¯çº¿å›¾.md](./æ¶æ„åˆ†æä¸å¼€å‘è·¯çº¿å›¾.md) - ç³»ç»Ÿæ¶æ„åˆ†æ
- [ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æŒ‡å—.md](./ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æŒ‡å—.md) - HTTP-FLVéƒ¨ç½²æŒ‡å—

---

## ğŸ‰ æ€»ç»“

**ä½ çš„C++ TASKæ¨¡å— = VIDEOæ¨¡å— + AIèƒ½åŠ›**

| å¯¹æ¯”é¡¹ | VIDEO (Python) | TASK (C++) |
|--------|---------------|-----------|
| åŠŸèƒ½ | ä»…è½¬å‘è§†é¢‘ | âœ… AIæ£€æµ‹+ç”»æ¡†+å‘Šè­¦ |
| æ€§èƒ½ | ä¸­ç­‰ | âœ… é«˜æ€§èƒ½ï¼ˆC++åŸç”Ÿï¼‰ |
| ç®¡ç† | æ‰‹åŠ¨ | âœ… å‰ç«¯APIæ§åˆ¶ |
| å¹¶å‘ | ~10è·¯ | âœ… 50è·¯+ |
| å‘Šè­¦ | âŒ | âœ… åŒºåŸŸæ£€æµ‹+è§„åˆ™å¼•æ“ |

**å¼€å‘æ—¶é—´ä¼°ç®—**ï¼š
- é˜¶æ®µ1ï¼ˆTASKè¡¥å…¨ï¼‰ï¼š3-4å¤©
- é˜¶æ®µ2ï¼ˆTaskManagerï¼‰ï¼š2-3å¤©
- é˜¶æ®µ3ï¼ˆå‰ç«¯é›†æˆï¼‰ï¼š2-3å¤©
- é˜¶æ®µ4ï¼ˆè§†é¢‘å¢™ï¼‰ï¼š1-2å¤©
- **æ€»è®¡ï¼š8-12å¤©**

**å®Œæˆåï¼Œä½ å°†æ‹¥æœ‰**ï¼š
âœ… å‰ç«¯ä¸€é”®å¯åŠ¨50è·¯AIæ£€æµ‹ä»»åŠ¡  
âœ… å®æ—¶è§†é¢‘å¢™å±•ç¤º  
âœ… åŒºåŸŸå‘Šè­¦+è§„åˆ™å¼•æ“é›†æˆ  
âœ… å®Œæ•´çš„å•†ç”¨çº§AIè§†é¢‘ç›‘æ§ç³»ç»Ÿ  

---

**å‡†å¤‡å¥½å¼€å§‹äº†å—ï¼Ÿ** ğŸš€

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 