# EasyAIoT 50è·¯æ‘„åƒå¤´AIæ£€æµ‹ç³»ç»Ÿ - é¡¹ç›®è®¾è®¡æ€»æ–¹é’ˆå¼€å‘æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-24  
**ç›®æ ‡**: å®ç°50è·¯æ‘„åƒå¤´çš„è¾¹ç¼˜AIå®æ—¶æ£€æµ‹ã€å‰ç«¯ç®¡ç†å’Œå‘Šè­¦å¤„ç†

---

## ğŸ“Š ç¬¬ä¸€éƒ¨åˆ†ï¼šç³»ç»Ÿæ¶æ„ä¸ç«¯å£é…ç½®

### 1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EasyAIoT äº‘è¾¹ç«¯ä¸€ä½“åŒ–å¹³å°                          â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   WEB    â”‚  â”‚  DEVICE  â”‚  â”‚   AI     â”‚  â”‚  VIDEO   â”‚         â”‚
â”‚  â”‚  å‰ç«¯UI  â”‚  â”‚  åç«¯ç½‘å…³ â”‚  â”‚ æ¨¡å‹è®­ç»ƒ  â”‚  â”‚ è§†é¢‘è½¬å‘  â”‚         â”‚
â”‚  â”‚  :8099   â”‚  â”‚  :48080  â”‚  â”‚  :5000   â”‚  â”‚  :6000   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚       â†“              â†“             â†“             â†“                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚              åŸºç¡€è®¾æ–½å±‚                              â”‚          â”‚
â”‚  â”‚  PostgreSQL | MinIO | ZLMediaKit | Node-RED        â”‚          â”‚
â”‚  â”‚    :5432    | :9000 |   :80,:1935|  :1880          â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚     è¾¹ç¼˜è®¡ç®—å±‚ï¼ˆæœ¬æ¬¡å¼€å‘é‡ç‚¹ï¼‰                         â”‚          â”‚
â”‚  â”‚  TaskManager(:7000) â†’ 50ä¸ªTASKå®ä¾‹(C++)            â”‚          â”‚
â”‚  â”‚  HTTP APIç®¡ç†å™¨        å®æ—¶AIæ¨ç†                    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ç«¯å£é…ç½®æ€»è§ˆï¼ˆâš ï¸ é‡è¦ï¼‰

| æ¨¡å— | ç«¯å£ | åè®® | ç”¨é€” | çŠ¶æ€ |
|------|------|------|------|------|
| **WEBï¼ˆå‰ç«¯ï¼‰** | `8099` | HTTP | Vue3å‰ç«¯ç•Œé¢ | âœ… è¿è¡Œä¸­ |
| **DEVICEï¼ˆç½‘å…³ï¼‰** | `48080` | HTTP | Spring Cloud Gateway | âœ… è¿è¡Œä¸­ |
| **AIï¼ˆè®­ç»ƒï¼‰** | `5000` | HTTP | æ¨¡å‹è®­ç»ƒ/å¯¼å‡º | âœ… è¿è¡Œä¸­ |
| **VIDEOï¼ˆè½¬å‘ï¼‰** | `6000` | HTTP | RTSPè½¬å‘ç®¡ç† | âœ… è¿è¡Œä¸­ |
| **TaskManager** | `7000` | HTTP | TASKä»»åŠ¡ç®¡ç† | âŒ å¾…å¼€å‘ |
| **ZLMediaKit** | `80` | HTTP | HTTP-FLVæ’­æ”¾ | âœ… è¿è¡Œä¸­ |
| **ZLMediaKit** | `1935` | RTMP | RTMPæ¨æµæ¥æ”¶ | âœ… è¿è¡Œä¸­ |
| **Node-RED** | `1880` | HTTP | è§„åˆ™å¼•æ“ | âœ… è¿è¡Œä¸­ |
| **PostgreSQL** | `5432` | TCP | æ•°æ®åº“ | âœ… è¿è¡Œä¸­ |
| **MinIO** | `9000` | HTTP | å¯¹è±¡å­˜å‚¨ | âœ… è¿è¡Œä¸­ |

### 1.3 APIè·¯ç”±æ˜ å°„

**å‰ç«¯ä»£ç†é…ç½®**ï¼ˆ`WEB/.env.development`ï¼‰:
```javascript
VITE_PORT = 8099
VITE_PROXY = [
  ["/api/v1/buckets", "http://localhost:9000/api/v1/buckets"],    // MinIO
  ["/dev-api/nodeRed", "http://127.0.0.1:1880"],                  // Node-RED
  ["/dev-api/task", "http://127.0.0.1:7000"],                     // TaskManagerï¼ˆå¾…æ·»åŠ ï¼‰
  ["/dev-api", "http://127.0.0.1:48080/admin-api"]                // DEVICEç½‘å…³
]
```

**åç«¯ç½‘å…³è·¯ç”±**ï¼ˆ`DEVICE/iot-gateway/src/main/resources/application.yaml`ï¼‰:
```yaml
spring.cloud.gateway.routes:
  - id: video-admin-api
    uri: lb://video-server
    predicates:
      - Path=/admin-api/video/**
    
  - id: model-admin-api
    uri: lb://model-server
    predicates:
      - Path=/admin-api/model/**
    
  - id: device-admin-api
    uri: lb://device-server
    predicates:
      - Path=/admin-api/device/**
  
  # âš ï¸ éœ€è¦æ–°å¢TaskManagerè·¯ç”±
  - id: task-admin-api
    uri: http://localhost:7000
    predicates:
      - Path=/admin-api/task/**
    filters:
      - StripPrefix=2
```

---

## ğŸ“ ç¬¬äºŒéƒ¨åˆ†ï¼šå„æ¨¡å—åŠŸèƒ½è¯¦è§£

### 2.1 WEBæ¨¡å—ï¼ˆVue3å‰ç«¯ï¼‰

**ç«¯å£**: `8099`  
**æŠ€æœ¯æ ˆ**: Vue3 + TypeScript + Ant Design Vue + Vite

#### æ ¸å¿ƒé¡µé¢

| é¡µé¢è·¯å¾„ | åŠŸèƒ½ | APIè°ƒç”¨ | çŠ¶æ€ |
|---------|------|---------|------|
| `/camera` | æ‘„åƒå¤´ç®¡ç† | `GET /video/camera/list`<br>`POST /video/camera/device/{id}/stream/start`<br>`POST /video/camera/device/{id}/stream/stop` | âœ… å®Œæˆ |
| `/dataset` | æ•°æ®æ ‡æ³¨ | `GET /model/dataset/list`<br>`POST /model/dataset/create` | âœ… å®Œæˆ |
| `/train` | æ¨¡å‹è®­ç»ƒ | `POST /model/train/start`<br>`GET /model/train/status` | âœ… å®Œæˆ |
| `/rulechains` | è§„åˆ™å¼•æ“ | Node-REDé›†æˆ | âœ… å®Œæˆ |
| `/ai-task` | **AIä»»åŠ¡ç®¡ç†** | `POST /task/start`<br>`GET /task/list` | âŒ **å¾…å¼€å‘** |
| `/video-wall` | **è§†é¢‘å¢™** | `GET /task/list`<br>WebSocketå‘Šè­¦ | âŒ **å¾…å¼€å‘** |

#### è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶

**æ–‡ä»¶**: `WEB/src/components/VideoPlayer/DialogPlayer.vue`  
**æ’­æ”¾å™¨**: Jessibucaï¼ˆæ”¯æŒHTTP-FLVï¼‰  
**åŠŸèƒ½**:
- HTTP-FLVè§†é¢‘æ’­æ”¾
- PTZäº‘å°æ§åˆ¶
- æ’­æ”¾åœ°å€åˆ‡æ¢

---

### 2.2 DEVICEæ¨¡å—ï¼ˆJava Springåç«¯ç½‘å…³ï¼‰

**ç«¯å£**: `48080`  
**æŠ€æœ¯æ ˆ**: Java 17 + Spring Boot + Spring Cloud Gateway

#### æ ¸å¿ƒAPI

```java
// è®¾å¤‡ç®¡ç†
GET    /admin-api/device/list              // è®¾å¤‡åˆ—è¡¨
POST   /admin-api/device/create            // åˆ›å»ºè®¾å¤‡
PUT    /admin-api/device/update/{id}       // æ›´æ–°è®¾å¤‡
DELETE /admin-api/device/{id}              // åˆ é™¤è®¾å¤‡

// âš ï¸ å‘Šè­¦å›è°ƒï¼ˆTASKå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼‰
POST   /admin-api/device/alarm             // è®¾å¤‡å‘Šè­¦å›è°ƒ
```

**å‘Šè­¦å›è°ƒè¯·æ±‚ç¤ºä¾‹**:
```json
POST http://localhost:48080/admin-api/device/alarm
Content-Type: application/json

{
  "device_id": "camera_001",
  "alarm_type": "ai_detection",
  "alarm_level": "warning",
  "alarm_content": "æ£€æµ‹åˆ°æœªä½©æˆ´å®‰å…¨å¸½",
  "detections": [
    {
      "class_id": 0,
      "class_name": "no_helmet",
      "confidence": 0.85,
      "bbox": {"x": 100, "y": 200, "w": 50, "h": 100}
    }
  ],
  "region_id": "entrance",
  "timestamp": "2025-10-24 10:30:00"
}
```

**Node-REDè§„åˆ™å¼•æ“**ï¼ˆç«¯å£1880ï¼‰:
- å‘Šè­¦è§„åˆ™é…ç½®
- ä¼ä¸šå¾®ä¿¡é€šçŸ¥
- é’‰é’‰æœºå™¨äºº
- é‚®ä»¶/çŸ­ä¿¡é€šçŸ¥
- æ•°æ®è½¬å‘ï¼ˆKafka/MQTTï¼‰

---

### 2.3 VIDEOæ¨¡å—ï¼ˆPython Flaskè§†é¢‘è½¬å‘ï¼‰

**ç«¯å£**: `6000`  
**æŠ€æœ¯æ ˆ**: Python 3.8+ + Flask + FFmpeg + ONVIF

#### æ ¸å¿ƒåŠŸèƒ½

```python
# RTSPè½¬å‘ç®¡ç†
POST   /admin-api/video/camera/device/{device_id}/stream/start   # å¯åŠ¨è½¬å‘
POST   /admin-api/video/camera/device/{device_id}/stream/stop    # åœæ­¢è½¬å‘
GET    /admin-api/video/camera/device/{device_id}/stream/status  # æŸ¥è¯¢çŠ¶æ€

# ONVIFè®¾å¤‡ç®¡ç†
GET    /admin-api/video/camera/discovery                         # è®¾å¤‡å‘ç°
POST   /admin-api/video/camera/device/{device_id}/ptz            # PTZæ§åˆ¶

# æˆªå›¾åŠŸèƒ½ï¼ˆç”¨äºæ•°æ®æ ‡æ³¨ï¼‰
POST   /admin-api/video/camera/device/{device_id}/rtsp/start     # å¯åŠ¨æˆªå›¾
```

**æ•°æ®æ¨¡å‹**ï¼ˆ`VIDEO/models.py`ï¼‰:
```python
class Device(db.Model):
    id = db.Column(db.String(100), primary_key=True)
    name = db.Column(db.String(100))
    source = db.Column(db.Text)           # RTSPåœ°å€
    rtmp_stream = db.Column(db.Text)      # RTMPæ¨æµåœ°å€
    http_stream = db.Column(db.Text)      # HTTP-FLVæ’­æ”¾åœ°å€
    ip, port, username, password          # è¿æ¥ä¿¡æ¯
    mac, manufacturer, model              # è®¾å¤‡ä¿¡æ¯
    support_move, support_zoom            # PTZèƒ½åŠ›
    enable_forward = db.Column(db.Boolean)  # æ˜¯å¦å¯ç”¨è½¬å‘
```

**âš ï¸ æ”¹é€ æ–¹æ¡ˆ**:
- ä¿ç•™ONVIFã€PTZã€æˆªå›¾åŠŸèƒ½
- æ–°å¢å­—æ®µ: `ai_task_id`, `ai_enabled`, `ai_model_path`
- å‰ç«¯å¯é€‰æ‹©: ä½¿ç”¨VIDEOè½¬å‘ï¼ˆæ— AIï¼‰æˆ–å¯åŠ¨TASKï¼ˆæœ‰AIï¼‰

---

### 2.4 AIæ¨¡å—ï¼ˆPython Flaskæ¨¡å‹è®­ç»ƒï¼‰

**ç«¯å£**: `5000`  
**æŠ€æœ¯æ ˆ**: Python 3.8+ + Flask + YOLOv8 + ONNX Runtime

#### æ ¸å¿ƒåŠŸèƒ½

```python
# æ¨¡å‹è®­ç»ƒ
POST   /admin-api/model/train/start       # å¯åŠ¨è®­ç»ƒ
POST   /admin-api/model/train/stop        # åœæ­¢è®­ç»ƒ
GET    /admin-api/model/train/status      # è®­ç»ƒçŠ¶æ€
GET    /admin-api/model/train/logs        # è®­ç»ƒæ—¥å¿—

# æ¨¡å‹å¯¼å‡º
POST   /admin-api/model/export/onnx       # å¯¼å‡ºONNXæ ¼å¼ âš ï¸ TASKä½¿ç”¨
POST   /admin-api/model/export/torchscript
GET    /admin-api/model/export/list

# æ¨ç†æµ‹è¯•
POST   /admin-api/model/inference/predict # å•å¼ å›¾ç‰‡æ£€æµ‹
GET    /admin-api/model/inference/list    # æ¨ç†ä»»åŠ¡åˆ—è¡¨
```

**ä¸TASKçš„å…³ç³»**:
```
AIæ¨¡å—ï¼ˆç§‘å­¦å®¶ï¼‰              TASKæ¨¡å—ï¼ˆå·¥äººï¼‰
    â†“                          â†“
1. è®­ç»ƒYOLOv8æ¨¡å‹         1. åŠ è½½onnxæ¨¡å‹
2. å¯¼å‡ºSafeHat.onnx  â†’   2. å®æ—¶è§†é¢‘æ¨ç†
3. æµ‹è¯•å•å¼ å›¾ç‰‡           3. å¤„ç†50è·¯è§†é¢‘æµ
4. å­˜å‚¨åˆ°MinIO           4. ç”Ÿäº§éƒ¨ç½²
```

---

### 2.5 TASKæ¨¡å—ï¼ˆC++è¾¹ç¼˜AIæ¨ç†ï¼‰â­ å¼€å‘é‡ç‚¹

**æŠ€æœ¯æ ˆ**: C++17 + ONNX Runtime + OpenCV + FFmpeg + Glog

#### å·²å®ŒæˆåŠŸèƒ½ âœ…

```cpp
âœ… RTSPè§†é¢‘è§£ç ï¼ˆFFmpegï¼‰
âœ… YOLOv11æ¨ç†å¼•æ“ï¼ˆONNX Runtime CPUï¼‰
âœ… å¼‚æ­¥æ¨ç†ï¼ˆ4çº¿ç¨‹æ± ï¼‰
âœ… å®æ—¶ç”»æ¡†æ˜¾ç¤ºï¼ˆOpenCVçª—å£ï¼‰
âœ… å‘Šè­¦HTTPå›è°ƒï¼ˆcpp-httplibï¼‰
âœ… ç½®ä¿¡åº¦è¿‡æ»¤
âœ… å‘Šè­¦å†·å´æœºåˆ¶ï¼ˆé˜²æ­¢é¢‘ç¹å‘Šè­¦ï¼‰
âœ… RTSPè‡ªåŠ¨é‡è¿
âœ… é…ç½®æ–‡ä»¶è§£æï¼ˆINIæ ¼å¼ï¼‰
âœ… RTMPæ¨æµï¼ˆå·²å®ç°ï¼ŒHTTP-FLVæ’­æ”¾1ç§’å»¶è¿Ÿï¼‰
âœ… åŒºåŸŸé…ç½®è§£æï¼ˆConfigParseræ”¯æŒ[regions]æ®µï¼Œè§£æJSONå¤šè¾¹å½¢ï¼‰
```

#### éœ€è¦å¼€å‘åŠŸèƒ½ âŒ

```cpp
âŒ åŒºåŸŸè¿‡æ»¤é€»è¾‘ï¼ˆ0.5å¤©ï¼‰
   â””â”€ cv::pointPolygonTest() åˆ¤æ–­æ£€æµ‹æ¡†ä¸­å¿ƒç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢åŒºåŸŸå†…
   â””â”€ åªæœ‰åœ¨åŒºåŸŸå†…çš„æ£€æµ‹æ‰è§¦å‘å‘Šè­¦

âŒ TaskManagerè¿›ç¨‹ç®¡ç†å™¨ï¼ˆ2-3å¤©ï¼‰â­â­â­â­â­ æœ€é‡è¦
   â””â”€ HTTP APIæœåŠ¡å™¨ï¼ˆcpp-httplibï¼Œç«¯å£7000ï¼‰
   â””â”€ ç®¡ç†50ä¸ªTASKå®ä¾‹ï¼ˆå¯åŠ¨/åœæ­¢/æŸ¥è¯¢/åˆ—è¡¨ï¼‰
   â””â”€ é…ç½®æ–‡ä»¶ç”Ÿæˆå™¨ï¼ˆJSONâ†’INIï¼‰
   â””â”€ å¿ƒè·³ç›‘æ§

âŒ å¤šæ¨¡å‹åŠ¨æ€åŠ è½½ï¼ˆ1å¤©ï¼‰
   â””â”€ è¿è¡Œæ—¶åˆ‡æ¢æ¨¡å‹ï¼Œæ— éœ€é‡å¯

âŒ ç±»åˆ«æ–‡ä»¶åŠ è½½ï¼ˆ0.5å¤©ï¼‰
   â””â”€ æ”¯æŒä¸­æ–‡æ ‡ç­¾ï¼ˆè¯»å–classes.txtï¼‰

âŒ èµ„æºé‡Šæ”¾å®Œå–„ï¼ˆ0.5å¤©ï¼‰
   â””â”€ é˜²æ­¢å†…å­˜æ³„æ¼ï¼Œç¡®ä¿RTSPæ–­çº¿é‡è¿æ—¶æ­£ç¡®é‡Šæ”¾
```

#### æ–‡ä»¶ç»“æ„

```
TASK/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Detech.cpp/h              # ä¸»ç¨‹åºï¼ˆè§†é¢‘å¤„ç†+AIæ¨ç†ï¼‰
â”‚   â”œâ”€â”€ Yolov11Engine.cpp/h       # YOLOæ¨ç†å¼•æ“
â”‚   â”œâ”€â”€ RTMPEncoder.cpp/h         # RTMPæ¨æµï¼ˆå·²å®Œæˆï¼‰
â”‚   â”œâ”€â”€ AlarmCallback.cpp/h       # å‘Šè­¦å›è°ƒ
â”‚   â”œâ”€â”€ ConfigParser.cpp/h        # é…ç½®è§£æ
â”‚   â”œâ”€â”€ Config.h                  # é…ç½®ç»“æ„ä½“
â”‚   â”œâ”€â”€ ThreadPoolExecutor.h      # çº¿ç¨‹æ± 
â”‚   â”œâ”€â”€ Utils.h                   # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ TaskManager.cpp/h         # âŒ å¾…å¼€å‘
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ test.ini                  # æµ‹è¯•é…ç½®
â”‚   â”œâ”€â”€ task1.ini ~ task50.ini    # âŒ 50è·¯é…ç½®ï¼ˆå¾…ç”Ÿæˆï¼‰
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ yolov11n.onnx            # YOLOæ¨¡å‹
â”‚   â””â”€â”€ SafeHat.onnx             # å®‰å…¨å¸½æ£€æµ‹æ¨¡å‹
â”œâ”€â”€ CMakeLists.txt               # ç¼–è¯‘é…ç½®
â””â”€â”€ build/Release/
    â”œâ”€â”€ TASK.exe                 # å¯æ‰§è¡Œæ–‡ä»¶
    â””â”€â”€ TaskManager.exe          # âŒ å¾…ç¼–è¯‘
```

---

## ğŸ¯ ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®Œæ•´ä¸šåŠ¡æµç¨‹

### 3.1 æ•°æ®æµç¤ºæ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ1ï¼šæ¨¡å‹å‡†å¤‡ï¼ˆAIæ¨¡å—ï¼‰                                       â”‚
â”‚ æ•°æ®æ ‡æ³¨ â†’ YOLOv8è®­ç»ƒ â†’ å¯¼å‡ºSafeHat.onnx â†’ å­˜å‚¨åˆ°MinIO       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ2ï¼šä»»åŠ¡é…ç½®ï¼ˆWEBå‰ç«¯ï¼‰                                      â”‚
â”‚ 1. é€‰æ‹©æ‘„åƒå¤´ï¼ˆRTSPåœ°å€ï¼‰                                      â”‚
â”‚ 2. é€‰æ‹©æ¨¡å‹ï¼ˆSafeHat.onnxï¼‰                                   â”‚
â”‚ 3. é…ç½®æ£€æµ‹åŒºåŸŸï¼ˆå¤šè¾¹å½¢ROIï¼‰                                   â”‚
â”‚ 4. é…ç½®å‘Šè­¦è§„åˆ™ï¼ˆé˜ˆå€¼ã€å†·å´æ—¶é—´ï¼‰                              â”‚
â”‚ 5. ç‚¹å‡»"å¯åŠ¨AIæ£€æµ‹"                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ3ï¼šä»»åŠ¡å¯åŠ¨ï¼ˆTaskManagerï¼‰                                 â”‚
â”‚ POST /dev-api/task/config/generate  â†’ ç”Ÿæˆconfig/task1.ini  â”‚
â”‚ POST /dev-api/task/start            â†’ å¯åŠ¨TASKå®ä¾‹          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ4ï¼šå®æ—¶æ¨ç†ï¼ˆTASKå®ä¾‹ï¼‰                                     â”‚
â”‚ RTSPæ‹‰æµ â†’ FFmpegè§£ç  â†’ YOLOæ¨ç† â†’ OpenCVç”»æ¡†              â”‚
â”‚     â†“           â†“           â†“           â†“                   â”‚
â”‚  25fps      H.264å¸§    æ£€æµ‹ç»“æœ    å¸¦æ¡†ç”»é¢                   â”‚
â”‚                                      â†“                       â”‚
â”‚                               RTMPæ¨æµç¼–ç                     â”‚
â”‚                                      â†“                       â”‚
â”‚                            ZLMediaKit(:1935)                â”‚
â”‚                                      â†“                       â”‚
â”‚                            HTTP-FLV(:80)                    â”‚
â”‚                                      â†“                       â”‚
â”‚                            å‰ç«¯æ’­æ”¾(1ç§’å»¶è¿Ÿ)                  â”‚
â”‚                                                             â”‚
â”‚ å¹¶è¡Œæµç¨‹ï¼šåŒºåŸŸè¿‡æ»¤ â†’ å‘Šè­¦åˆ¤æ–­ â†’ HTTP POSTå‘Šè­¦                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ5ï¼šå‘Šè­¦å¤„ç†ï¼ˆDEVICE + Node-REDï¼‰                           â”‚
â”‚ TASK â†’ POST /admin-api/device/alarm                         â”‚
â”‚ DEVICEæ¥æ”¶ â†’ Node-REDè§„åˆ™å¼•æ“                                â”‚
â”‚           â†“                                                 â”‚
â”‚ WebSocketæ¨é€å‰ç«¯ï¼ˆå®æ—¶ï¼‰                                      â”‚
â”‚ PostgreSQLå­˜å‚¨ï¼ˆå†å²ï¼‰                                         â”‚
â”‚ ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼ˆ@ç®¡ç†å‘˜ï¼‰                                         â”‚
â”‚ é’‰é’‰æœºå™¨äººï¼ˆç¾¤æ¶ˆæ¯ï¼‰                                           â”‚
â”‚ é‚®ä»¶/çŸ­ä¿¡ï¼ˆä¸¥é‡å‘Šè­¦ï¼‰                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 é…ç½®æ–‡ä»¶å®Œæ•´ç¤ºä¾‹

```ini
# TASK/config/task1.ini

[task]
task_id=1
task_name=entrance_monitor

[video]
source=rtsp://admin:Admin123@192.168.1.100:554/stream1
width=1920
height=1080
fps=25
enable=true

[model]
model_path=models/SafeHat.onnx
classes_path=models/SafeHat_cn.txt
confidence_threshold=0.5
nms_threshold=0.45
threads=1

[rtmp]
enable=true
rtmp_url=rtmp://localhost:1935/live/camera_1
fps=25
enable_draw=true

[alarm]
enable=true
hook_url=http://localhost:48080/admin-api/device/alarm
confidence_threshold=0.6
cooldown_time=10

[regions]
entrance=[[100,200],[300,200],[300,400],[100,400]]
parking=[[500,500],[800,500],[800,700],[500,700]]

[features]
enable_rtmp=true
enable_draw=true
enable_alarm=true
```

---

## ğŸš€ ç¬¬å››éƒ¨åˆ†ï¼šå¼€å‘è·¯çº¿å›¾ï¼ˆ8-12å¤©ï¼‰

### é˜¶æ®µ1ï¼šTASKæ¨¡å—è¡¥å…¨æ ¸å¿ƒåŠŸèƒ½ï¼ˆ1å¤©ï¼‰âš¡ æœ€å¿«è§æ•ˆ

#### Day 1ä¸Šåˆï¼šåŒºåŸŸè¿‡æ»¤é€»è¾‘ï¼ˆ0.5å¤©ï¼‰

**ä»»åŠ¡**: å®ç°ç‚¹åœ¨å¤šè¾¹å½¢å†…åˆ¤æ–­

**æ–‡ä»¶**: `TASK/src/Detech.cpp`

**ä»£ç å®ç°**:
```cpp
// 1. æ·»åŠ åŒºåŸŸè¿‡æ»¤å‡½æ•°
bool isInAlarmRegion(const Detection& det, const std::vector<cv::Point>& region) {
    // è®¡ç®—æ£€æµ‹æ¡†ä¸­å¿ƒç‚¹
    float centerX = det.x + det.w / 2.0f;
    float centerY = det.y + det.h / 2.0f;
    cv::Point2f center(centerX, centerY);
    
    // OpenCVç‚¹åœ¨å¤šè¾¹å½¢å†…åˆ¤æ–­
    double result = cv::pointPolygonTest(region, center, false);
    return result >= 0;  // >= 0 è¡¨ç¤ºåœ¨åŒºåŸŸå†…
}

// 2. åœ¨å‘Šè­¦é€»è¾‘ä¸­ä½¿ç”¨
std::vector<Detection> alarmDetections;
for (const auto& det : detections) {
    if (det.confidence < _config.alarmConfidenceThreshold) {
        continue;  // ç½®ä¿¡åº¦ä¸å¤Ÿ
    }
    
    // éå†æ‰€æœ‰é…ç½®çš„åŒºåŸŸ
    bool inRegion = false;
    for (const auto& region : _config.regions["default"]) {
        if (isInAlarmRegion(det, region)) {
            inRegion = true;
            break;
        }
    }
    
    if (inRegion) {
        alarmDetections.push_back(det);
    }
}

// 3. è§¦å‘å‘Šè­¦
if (!alarmDetections.empty()) {
    _alarmCallback->sendAlarm(taskId, alarmDetections, "region_main", timestamp);
}
```

**éªŒæ”¶æ ‡å‡†**:
```bash
# 1. é…ç½®å¤šä¸ªåŒºåŸŸ
[regions]
entrance=[[100,100],[500,100],[500,400],[100,400]]
parking=[[600,100],[900,100],[900,400],[600,400]]

# 2. æµ‹è¯•
- åœ¨entranceåŒºåŸŸå†…æ£€æµ‹åˆ°äºº â†’ è§¦å‘å‘Šè­¦ âœ…
- åœ¨parkingåŒºåŸŸå¤–æ£€æµ‹åˆ°äºº â†’ ä¸è§¦å‘å‘Šè­¦ âœ…
- å®Œå…¨åœ¨åŒºåŸŸå¤– â†’ ä¸è§¦å‘å‘Šè­¦ âœ…
```

#### Day 1ä¸‹åˆï¼šèµ„æºé‡Šæ”¾å®Œå–„ï¼ˆ0.5å¤©ï¼‰

**æ–‡ä»¶**: `TASK/src/Detech.cpp`

**ä»£ç å®ç°**:
```cpp
void Detech::releaseResources() {
    LOG(INFO) << "[CLEANUP] Releasing all resources...";
    
    // 1. é‡Šæ”¾RTMPç¼–ç å™¨
    if (_rtmpEncoder) {
        _rtmpEncoder->release();
        delete _rtmpEncoder;
        _rtmpEncoder = nullptr;
    }
    
    // 2. é‡Šæ”¾YOLOå¼•æ“
    if (_yoloEngine) {
        delete _yoloEngine;
        _yoloEngine = nullptr;
    }
    
    // 3. é‡Šæ”¾FFmpegèµ„æº
    if (_videoCtx) {
        avformat_close_input(&_videoCtx);
        _videoCtx = nullptr;
    }
    
    if (_codecCtx) {
        avcodec_free_context(&_codecCtx);
        _codecCtx = nullptr;
    }
    
    // 4. é‡Šæ”¾å‘Šè­¦å›è°ƒ
    if (_alarmCallback) {
        delete _alarmCallback;
        _alarmCallback = nullptr;
    }
    
    LOG(INFO) << "[CLEANUP] All resources released successfully";
}

// åœ¨ææ„å‡½æ•°ä¸­è°ƒç”¨
Detech::~Detech() {
    releaseResources();
}
```

---

### é˜¶æ®µ2ï¼šTaskManagerè¿›ç¨‹ç®¡ç†å™¨ï¼ˆ2-3å¤©ï¼‰â­â­â­â­â­ æ ¸å¿ƒ

#### Day 2-3ï¼šHTTP APIå®ç°

**æ–°å»ºæ–‡ä»¶**: `TASK/src/TaskManager.cpp`

**å®Œæ•´ä»£ç **:
```cpp
#include <httplib.h>
#include <nlohmann/json.hpp>
#include <map>
#include <memory>
#include <thread>
#include "Detech.h"
#include "ConfigParser.h"

using json = nlohmann::json;

class TaskManager {
private:
    std::map<int, std::unique_ptr<std::thread>> taskThreads;
    std::map<int, std::shared_ptr<Config>> taskConfigs;
    std::map<int, std::string> taskStatus;  // "running", "stopped", "error"
    httplib::Server server;
    std::mutex mtx;

public:
    TaskManager(int port = 7000) {
        LOG(INFO) << "[TaskManager] Initializing on port " << port;
        setupRoutes();
    }
    
    void setupRoutes() {
        // POST /task/start - å¯åŠ¨ä»»åŠ¡
        server.Post("/task/start", [this](const httplib::Request& req, httplib::Response& res) {
            try {
                auto json = nlohmann::json::parse(req.body);
                int taskId = json["task_id"];
                std::string configPath = json["config_path"];
                
                startTask(taskId, configPath);
                
                json response = {
                    {"code", 0},
                    {"msg", "Task started successfully"},
                    {"task_id", taskId}
                };
                res.set_content(response.dump(), "application/json");
                
            } catch (const std::exception& e) {
                json response = {
                    {"code", -1},
                    {"msg", std::string("Error: ") + e.what()}
                };
                res.set_content(response.dump(), "application/json");
            }
        });
        
        // POST /task/stop - åœæ­¢ä»»åŠ¡
        server.Post("/task/stop", [this](const httplib::Request& req, httplib::Response& res) {
            try {
                auto json = nlohmann::json::parse(req.body);
                int taskId = json["task_id"];
                
                stopTask(taskId);
                
                json response = {
                    {"code", 0},
                    {"msg", "Task stopped successfully"},
                    {"task_id", taskId}
                };
                res.set_content(response.dump(), "application/json");
                
            } catch (const std::exception& e) {
                json response = {
                    {"code", -1},
                    {"msg", std::string("Error: ") + e.what()}
                };
                res.set_content(response.dump(), "application/json");
            }
        });
        
        // GET /task/status - æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
        server.Get("/task/status", [this](const httplib::Request& req, httplib::Response& res) {
            try {
                int taskId = std::stoi(req.get_param_value("task_id"));
                
                std::lock_guard<std::mutex> lock(mtx);
                if (taskStatus.find(taskId) == taskStatus.end()) {
                    throw std::runtime_error("Task not found");
                }
                
                json response = {
                    {"code", 0},
                    {"data", {
                        {"task_id", taskId},
                        {"status", taskStatus[taskId]},
                        {"config_path", taskConfigs[taskId] ? "loaded" : "none"}
                    }}
                };
                res.set_content(response.dump(), "application/json");
                
            } catch (const std::exception& e) {
                json response = {
                    {"code", -1},
                    {"msg", std::string("Error: ") + e.what()}
                };
                res.set_content(response.dump(), "application/json");
            }
        });
        
        // GET /task/list - ä»»åŠ¡åˆ—è¡¨
        server.Get("/task/list", [this](const httplib::Request& req, httplib::Response& res) {
            std::lock_guard<std::mutex> lock(mtx);
            
            json taskList = json::array();
            for (const auto& [taskId, status] : taskStatus) {
                taskList.push_back({
                    {"task_id", taskId},
                    {"status", status}
                });
            }
            
            json response = {
                {"code", 0},
                {"data", taskList}
            };
            res.set_content(response.dump(), "application/json");
        });
        
        // POST /config/generate - ç”Ÿæˆé…ç½®æ–‡ä»¶
        server.Post("/config/generate", [this](const httplib::Request& req, httplib::Response& res) {
            try {
                auto json = nlohmann::json::parse(req.body);
                std::string configPath = generateConfig(json);
                
                json response = {
                    {"code", 0},
                    {"msg", "Config generated successfully"},
                    {"config_path", configPath}
                };
                res.set_content(response.dump(), "application/json");
                
            } catch (const std::exception& e) {
                json response = {
                    {"code", -1},
                    {"msg", std::string("Error: ") + e.what()}
                };
                res.set_content(response.dump(), "application/json");
            }
        });
    }
    
    void startTask(int taskId, const std::string& configPath) {
        std::lock_guard<std::mutex> lock(mtx);
        
        // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²åœ¨è¿è¡Œ
        if (taskThreads.find(taskId) != taskThreads.end()) {
            throw std::runtime_error("Task already running");
        }
        
        // è§£æé…ç½®
        auto config = std::make_shared<Config>();
        ConfigParser parser;
        if (!parser.parse(configPath, *config)) {
            throw std::runtime_error("Failed to parse config file");
        }
        
        // åˆ›å»ºçº¿ç¨‹è¿è¡ŒTASK
        auto thread = std::make_unique<std::thread>([this, taskId, config]() {
            try {
                taskStatus[taskId] = "running";
                
                Detech task(*config);
                task.init();
                task.run();  // é˜»å¡è¿è¡Œ
                
                taskStatus[taskId] = "stopped";
            } catch (const std::exception& e) {
                LOG(ERROR) << "[Task-" << taskId << "] Error: " << e.what();
                taskStatus[taskId] = "error";
            }
        });
        
        taskThreads[taskId] = std::move(thread);
        taskConfigs[taskId] = config;
        
        LOG(INFO) << "[TaskManager] Task " << taskId << " started";
    }
    
    void stopTask(int taskId) {
        std::lock_guard<std::mutex> lock(mtx);
        
        if (taskThreads.find(taskId) == taskThreads.end()) {
            throw std::runtime_error("Task not found");
        }
        
        // âš ï¸ è¿™é‡Œéœ€è¦å®ç°ä¼˜é›…åœæ­¢æœºåˆ¶
        // å¯ä»¥ä½¿ç”¨ std::atomic<bool> æ ‡å¿—ä½
        // æˆ–è€…åœ¨Detechä¸­æ·»åŠ stop()æ–¹æ³•
        
        if (taskThreads[taskId]->joinable()) {
            taskThreads[taskId]->join();
        }
        
        taskThreads.erase(taskId);
        taskConfigs.erase(taskId);
        taskStatus[taskId] = "stopped";
        
        LOG(INFO) << "[TaskManager] Task " << taskId << " stopped";
    }
    
    std::string generateConfig(const json& config) {
        int taskId = config["task_id"];
        std::string configPath = "config/task" + std::to_string(taskId) + ".ini";
        
        std::ofstream file(configPath);
        if (!file.is_open()) {
            throw std::runtime_error("Cannot create config file");
        }
        
        // [task]
        file << "[task]\n";
        file << "task_id=" << taskId << "\n";
        file << "task_name=" << config.value("task_name", "task_" + std::to_string(taskId)) << "\n\n";
        
        // [video]
        file << "[video]\n";
        file << "source=" << config["video"]["source"].get<std::string>() << "\n";
        file << "width=" << config["video"].value("width", 1920) << "\n";
        file << "height=" << config["video"].value("height", 1080) << "\n";
        file << "fps=" << config["video"].value("fps", 25) << "\n";
        file << "enable=true\n\n";
        
        // [model]
        file << "[model]\n";
        file << "model_path=" << config["model"]["model_path"].get<std::string>() << "\n";
        file << "confidence_threshold=" << config["model"].value("confidence_threshold", 0.5) << "\n";
        file << "nms_threshold=" << config["model"].value("nms_threshold", 0.45) << "\n";
        file << "threads=" << config["model"].value("threads", 1) << "\n\n";
        
        // [rtmp]
        file << "[rtmp]\n";
        file << "enable=true\n";
        file << "rtmp_url=" << config["rtmp"]["rtmp_url"].get<std::string>() << "\n";
        file << "fps=" << config["rtmp"].value("fps", 25) << "\n\n";
        
        // [alarm]
        file << "[alarm]\n";
        file << "enable=" << (config["alarm"].value("enable", true) ? "true" : "false") << "\n";
        file << "hook_url=" << config["alarm"]["hook_url"].get<std::string>() << "\n";
        file << "confidence_threshold=" << config["alarm"].value("confidence_threshold", 0.6) << "\n";
        file << "cooldown_time=" << config["alarm"].value("cooldown_time", 10) << "\n\n";
        
        // [regions]
        if (config.contains("regions")) {
            file << "[regions]\n";
            for (const auto& region : config["regions"]) {
                std::string regionId = region["region_id"];
                file << regionId << "=";
                
                // è½¬æ¢ä¸º [[x1,y1],[x2,y2],...] æ ¼å¼
                file << "[";
                for (size_t i = 0; i < region["polygon"].size(); ++i) {
                    file << "[" << region["polygon"][i][0] << "," << region["polygon"][i][1] << "]";
                    if (i < region["polygon"].size() - 1) file << ",";
                }
                file << "]\n";
            }
            file << "\n";
        }
        
        // [features]
        file << "[features]\n";
        file << "enable_rtmp=true\n";
        file << "enable_draw=true\n";
        file << "enable_alarm=true\n";
        
        file.close();
        
        LOG(INFO) << "[TaskManager] Config generated: " << configPath;
        return configPath;
    }
    
    void run() {
        LOG(INFO) << "[TaskManager] Server listening on port 7000";
        server.listen("0.0.0.0", 7000);
    }
};

int main(int argc, char* argv[]) {
    google::InitGoogleLogging(argv[0]);
    FLAGS_logtostderr = true;
    FLAGS_colorlogtostderr = true;
    
    TaskManager manager(7000);
    manager.run();
    
    return 0;
}
```

**CMakeLists.txté…ç½®**:
```cmake
# æ·»åŠ TaskManagerå¯æ‰§è¡Œæ–‡ä»¶
add_executable(TaskManager
    src/TaskManager.cpp
    src/Detech.cpp
    src/Yolov11Engine.cpp
    src/RTMPEncoder.cpp
    src/AlarmCallback.cpp
    src/ConfigParser.cpp
)

target_link_libraries(TaskManager
    cpp-httplib
    nlohmann_json::nlohmann_json
    glog::glog
    opencv_world
    onnxruntime
    ${FFMPEG_LIBRARIES}
)
```

**ç¼–è¯‘**:
```bash
cd TASK
cmake --build build --config Release
```

**æµ‹è¯•**:
```bash
# 1. å¯åŠ¨TaskManager
.\build\Release\TaskManager.exe

# 2. ç”Ÿæˆé…ç½®æ–‡ä»¶
curl -X POST http://localhost:7000/config/generate \
  -H "Content-Type: application/json" \
  -d @config_template.json

# 3. å¯åŠ¨ä»»åŠ¡
curl -X POST http://localhost:7000/task/start \
  -H "Content-Type: application/json" \
  -d '{"task_id": 1, "config_path": "config/task1.ini"}'

# 4. æŸ¥è¯¢çŠ¶æ€
curl http://localhost:7000/task/status?task_id=1

# 5. ä»»åŠ¡åˆ—è¡¨
curl http://localhost:7000/task/list

# 6. åœæ­¢ä»»åŠ¡
curl -X POST http://localhost:7000/task/stop \
  -H "Content-Type: application/json" \
  -d '{"task_id": 1}'
```

**é…ç½®æ¨¡æ¿**ï¼ˆ`config_template.json`ï¼‰:
```json
{
  "task_id": 1,
  "task_name": "entrance_monitor",
  "video": {
    "source": "rtsp://admin:Admin123@192.168.1.100:554/stream1",
    "width": 1920,
    "height": 1080,
    "fps": 25
  },
  "model": {
    "model_path": "models/SafeHat.onnx",
    "confidence_threshold": 0.5,
    "nms_threshold": 0.45,
    "threads": 1
  },
  "rtmp": {
    "rtmp_url": "rtmp://localhost:1935/live/camera_1",
    "fps": 25
  },
  "alarm": {
    "enable": true,
    "hook_url": "http://localhost:48080/admin-api/device/alarm",
    "confidence_threshold": 0.6,
    "cooldown_time": 10
  },
  "regions": [
    {
      "region_id": "entrance",
      "polygon": [[100,100], [500,100], [500,400], [100,400]]
    }
  ]
}
```

---

### â­ é˜¶æ®µ2.5ï¼šByteTrackç›®æ ‡è¿½è¸ªé›†æˆï¼ˆ3-4å¤©ï¼‰é‡è¦å¢å¼º

#### ä¸ºä»€ä¹ˆéœ€è¦ByteTrackï¼Ÿ

**å½“å‰é—®é¢˜**ï¼š
- âŒ æ¯ä¸€å¸§ç‹¬ç«‹æ£€æµ‹ï¼Œæ— æ³•çŸ¥é“"è¿™æ˜¯ç¬¬å‡ ä¸ªäºº"
- âŒ æ— æ³•è·¨å¸§è¿½è¸ªç›®æ ‡ï¼ˆä¸Šä¸€å¸§çš„äººAå’Œè¿™ä¸€å¸§çš„äººBæ˜¯ä¸æ˜¯åŒä¸€ä¸ªäººï¼‰
- âŒ æ— æ³•ç»Ÿè®¡è¿›å…¥/ç¦»å¼€äººæ•°
- âŒ æ— æ³•åˆ†æè½¨è¿¹
- âŒ æ— æ³•æ£€æµ‹åŒºåŸŸåœç•™æ—¶é•¿
- âŒ æ— æ³•æ£€æµ‹å¾˜å¾Šè¡Œä¸º

**åŠ å…¥ByteTrackå**ï¼š
- âœ… æ¯ä¸ªç›®æ ‡æœ‰å”¯ä¸€IDï¼ˆ1å·äººã€2å·äººã€3å·äºº...ï¼‰
- âœ… è·¨å¸§è¿½è¸ªï¼ˆçŸ¥é“è¿™ä¸ªäººä»å“ªæ¥ã€è¦å»å“ªï¼‰
- âœ… äººæ•°ç»Ÿè®¡ï¼ˆè¿›å…¥5äººã€ç¦»å¼€2äººã€å½“å‰3äººï¼‰
- âœ… è½¨è¿¹åˆ†æï¼ˆç”»å‡ºç§»åŠ¨è·¯å¾„ï¼‰
- âœ… åœç•™æ—¶é•¿å‘Šè­¦ï¼ˆ"3å·äººåœ¨ç¦åŒºåœç•™äº†5åˆ†é’Ÿ"ï¼‰
- âœ… å¾˜å¾Šæ£€æµ‹ï¼ˆ"5å·äººåœ¨å…¥å£å¾˜å¾Šäº†10åˆ†é’Ÿ"ï¼‰

#### Day 4ï¼šä¸‹è½½å¹¶é›†æˆByteTrack C++ä»£ç 

**æ­¥éª¤1ï¼šä»GitHubè·å–ByteTrackæºç **

ByteTrackå®˜æ–¹ä»“åº“ï¼šhttps://github.com/ifzhang/ByteTrack

```bash
# æ–¹æ³•1ï¼šå…‹éš†æ•´ä¸ªä»“åº“ï¼ˆæ¨èï¼‰
git clone https://github.com/ifzhang/ByteTrack.git
cd ByteTrack

# æ–¹æ³•2ï¼šåªä¸‹è½½C++éƒ¨åˆ†ï¼ˆå¦‚æœåªéœ€è¦C++ä»£ç ï¼‰
# è®¿é—® https://github.com/ifzhang/ByteTrack/tree/main/deploy/cpp
# æ‰‹åŠ¨ä¸‹è½½ä»¥ä¸‹æ–‡ä»¶åˆ° TASK/src/bytetrack/ ç›®å½•ï¼š
```

**æ­¥éª¤2ï¼šéœ€è¦çš„æ–‡ä»¶åˆ—è¡¨**

ä» `ByteTrack/deploy/cpp/include/` å¤åˆ¶ä»¥ä¸‹æ–‡ä»¶åˆ° `TASK/src/bytetrack/`ï¼š

```
TASK/src/bytetrack/
â”œâ”€â”€ BYTETracker.h
â”œâ”€â”€ BYTETracker.cpp
â”œâ”€â”€ STrack.h
â”œâ”€â”€ STrack.cpp
â”œâ”€â”€ KalmanFilter.h
â”œâ”€â”€ KalmanFilter.cpp
â”œâ”€â”€ lapjv.h
â”œâ”€â”€ lapjv.cpp
â””â”€â”€ dataType.h
```

**æ­¥éª¤3ï¼šä¿®æ”¹CMakeLists.txt**

```cmake
# TASK/CMakeLists.txt

# æ·»åŠ ByteTrackæºæ–‡ä»¶
set(BYTETRACK_SOURCES
    src/bytetrack/BYTETracker.cpp
    src/bytetrack/STrack.cpp
    src/bytetrack/KalmanFilter.cpp
    src/bytetrack/lapjv.cpp
)

# ä¿®æ”¹TASKå¯æ‰§è¡Œæ–‡ä»¶
add_executable(TASK
    src/main.cpp
    src/Detech.cpp
    src/Yolov11Engine.cpp
    src/RTMPEncoder.cpp
    src/AlarmCallback.cpp
    src/ConfigParser.cpp
    ${BYTETRACK_SOURCES}  # â­ æ–°å¢
)

# æ·»åŠ åŒ…å«ç›®å½•
target_include_directories(TASK PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/src
    ${CMAKE_CURRENT_SOURCE_DIR}/src/bytetrack  # â­ æ–°å¢
)
```

**æ­¥éª¤4ï¼šæ›´æ–°Configç»“æ„ä½“**

```cpp
// TASK/src/Config.h

typedef struct Config {
    // ... ç°æœ‰å­—æ®µ ...
    
    // â­ æ–°å¢ï¼šè¿½è¸ªé…ç½®
    bool enableTracking;                // æ˜¯å¦å¯ç”¨è¿½è¸ª
    int trackMaxLostFrames;             // æœ€å¤šä¸¢å¤±å¸§æ•°ï¼ˆé»˜è®¤30ï¼‰
    int trackBuffer;                    // trackç¼“å†²å¸§æ•°ï¼ˆé»˜è®¤30ï¼‰
    float trackMatchThreshold;          // åŒ¹é…é˜ˆå€¼ï¼ˆé»˜è®¤0.8ï¼‰
    int trackMinBoxArea;                // æœ€å°æ¡†é¢ç§¯ï¼ˆé»˜è®¤100ï¼‰
    
    // â­ æ–°å¢ï¼šé«˜çº§å‘Šè­¦é…ç½®
    bool enableRegionStayAlarm;         // åŒºåŸŸåœç•™å‘Šè­¦
    int regionStayThreshold;            // åœç•™æ—¶é•¿é˜ˆå€¼ï¼ˆç§’ï¼‰
    bool enableLoiteringAlarm;          // å¾˜å¾Šå‘Šè­¦
    int loiteringThreshold;             // å¾˜å¾Šæ—¶é•¿é˜ˆå€¼ï¼ˆç§’ï¼‰
    
    // ç°æœ‰å­—æ®µ...
    std::string rtspUrl;
    std::string rtmpUrl;
    // ...
} Config;
```

#### Day 5-6ï¼šå®ç°è¿½è¸ªé€»è¾‘

**æ–°å»ºæ–‡ä»¶**: `TASK/src/Detech.h` ï¼ˆæ·»åŠ è¿½è¸ªç›¸å…³æˆå‘˜ï¼‰

```cpp
// TASK/src/Detech.h

#include "bytetrack/BYTETracker.h"  // â­ æ–°å¢

class Detech {
private:
    // ... ç°æœ‰æˆå‘˜ ...
    
    // â­ æ–°å¢ï¼šByteTrackè¿½è¸ªå™¨
    BYTETracker* _tracker;
    
    // â­ æ–°å¢ï¼šè¿½è¸ªçŠ¶æ€ç®¡ç†
    std::map<int, std::chrono::steady_clock::time_point> _trackEnterTime;   // trackè¿›å…¥åŒºåŸŸæ—¶é—´
    std::map<int, std::vector<cv::Point>> _trackTrajectory;                 // trackè½¨è¿¹
    std::map<int, std::chrono::steady_clock::time_point> _trackFirstSeen;   // tracké¦–æ¬¡å‡ºç°æ—¶é—´
    
    // â­ æ–°å¢ï¼šè¿½è¸ªç›¸å…³å‡½æ•°
    std::vector<STrack> updateTracking(const std::vector<Detection>& detections);
    bool checkRegionStayAlarm(int trackId, const cv::Point& center);
    bool checkLoiteringAlarm(int trackId);
    void drawTrackingInfo(cv::Mat& frame, const std::vector<STrack>& tracks);
};
```

**ä¿®æ”¹æ–‡ä»¶**: `TASK/src/Detech.cpp` ï¼ˆå®ç°è¿½è¸ªé€»è¾‘ï¼‰

```cpp
// TASK/src/Detech.cpp

bool Detech::init() {
    // ... ç°æœ‰åˆå§‹åŒ–ä»£ç  ...
    
    // â­ æ–°å¢ï¼šåˆå§‹åŒ–ByteTrackè¿½è¸ªå™¨
    if (_config.enableTracking) {
        _tracker = new BYTETracker(
            25,  // fps
            _config.trackBuffer,
            _config.trackMatchThreshold,
            _config.trackMinBoxArea
        );
        LOG(INFO) << "[ByteTrack] Tracker initialized";
    }
    
    return true;
}

void Detech::run() {
    // ... è§†é¢‘è§£ç å¾ªç¯ ...
    
    while (true) {
        // 1. è¯»å–å¸§
        AVPacket* packet = av_packet_alloc();
        if (av_read_frame(_videoCtx, packet) < 0) {
            break;
        }
        
        // 2. è§£ç 
        cv::Mat frame = decodeFrame(packet);
        
        // 3. YOLOæ£€æµ‹
        std::vector<Detection> detections = _yoloEngine->detect(frame);
        
        // â­ 4. ByteTrackè¿½è¸ªï¼ˆæ–°å¢ï¼‰
        std::vector<STrack> tracks;
        if (_config.enableTracking) {
            tracks = updateTracking(detections);
        }
        
        // 5. åŒºåŸŸè¿‡æ»¤ + å‘Šè­¦
        std::vector<STrack> alarmTracks;
        for (const auto& track : tracks) {
            // æ£€æŸ¥æ˜¯å¦åœ¨åŒºåŸŸå†…
            cv::Point center(track.tlwh[0] + track.tlwh[2]/2, 
                           track.tlwh[1] + track.tlwh[3]/2);
            
            bool inRegion = false;
            for (const auto& region : _config.regions["default"]) {
                if (cv::pointPolygonTest(region, center, false) >= 0) {
                    inRegion = true;
                    
                    // â­ é«˜çº§å‘Šè­¦ï¼šåŒºåŸŸåœç•™æ—¶é•¿æ£€æµ‹
                    if (_config.enableRegionStayAlarm) {
                        if (checkRegionStayAlarm(track.track_id, center)) {
                            LOG(WARNING) << "[ALARM] Track " << track.track_id 
                                       << " stayed in region for too long!";
                            // è§¦å‘å‘Šè­¦
                        }
                    }
                    
                    break;
                }
            }
            
            if (inRegion && track.score >= _config.alarmConfidenceThreshold) {
                alarmTracks.push_back(track);
            }
        }
        
        // â­ 6. å¾˜å¾Šæ£€æµ‹
        if (_config.enableLoiteringAlarm) {
            for (const auto& track : tracks) {
                if (checkLoiteringAlarm(track.track_id)) {
                    LOG(WARNING) << "[ALARM] Track " << track.track_id 
                               << " is loitering!";
                    // è§¦å‘å‘Šè­¦
                }
            }
        }
        
        // 7. å‘é€å‘Šè­¦ï¼ˆå¸¦track_idï¼‰
        if (!alarmTracks.empty()) {
            auto alarmNow = std::chrono::steady_clock::now();
            auto elapsed = std::chrono::duration_cast<std::chrono::seconds>(
                alarmNow - _lastAlarmTime).count();
            
            if (elapsed >= _config.alarmCooldownTime) {
                _lastAlarmTime = alarmNow;
                
                // è½¬æ¢ä¸ºDetectionæ ¼å¼å‘é€
                std::vector<Detection> alarmDetections;
                for (const auto& track : alarmTracks) {
                    Detection det;
                    det.x = track.tlwh[0];
                    det.y = track.tlwh[1];
                    det.w = track.tlwh[2];
                    det.h = track.tlwh[3];
                    det.confidence = track.score;
                    det.classId = 0;  // å‡è®¾æ˜¯personç±»
                    det.track_id = track.track_id;  // â­ æ–°å¢track_id
                    alarmDetections.push_back(det);
                }
                
                // å¼‚æ­¥å‘é€å‘Šè­¦
                std::thread([this, alarmDetections]() {
                    _alarmCallback->sendAlarm(
                        _config.taskId,
                        alarmDetections,
                        "region_main",
                        getCurrentTimestamp()
                    );
                }).detach();
            }
        }
        
        // 8. ç»˜åˆ¶è¿½è¸ªä¿¡æ¯
        if (_config.enableDrawRtmp && _config.enableTracking) {
            drawTrackingInfo(frame, tracks);
        }
        
        // 9. RTMPæ¨æµ
        if (_config.enableRtmp) {
            _rtmpEncoder->encodeAndPush(frame);
        }
    }
}

// â­ æ–°å¢ï¼šæ›´æ–°è¿½è¸ª
std::vector<STrack> Detech::updateTracking(const std::vector<Detection>& detections) {
    // è½¬æ¢ä¸ºByteTrackéœ€è¦çš„æ ¼å¼
    std::vector<Object> objects;
    for (const auto& det : detections) {
        Object obj;
        obj.rect.x = det.x;
        obj.rect.y = det.y;
        obj.rect.width = det.w;
        obj.rect.height = det.h;
        obj.prob = det.confidence;
        obj.label = det.classId;
        objects.push_back(obj);
    }
    
    // è°ƒç”¨ByteTrackæ›´æ–°
    std::vector<STrack> tracks = _tracker->update(objects);
    
    // è®°å½•é¦–æ¬¡å‡ºç°æ—¶é—´
    for (const auto& track : tracks) {
        if (_trackFirstSeen.find(track.track_id) == _trackFirstSeen.end()) {
            _trackFirstSeen[track.track_id] = std::chrono::steady_clock::now();
            LOG(INFO) << "[Track] New track ID: " << track.track_id;
        }
        
        // è®°å½•è½¨è¿¹
        cv::Point center(track.tlwh[0] + track.tlwh[2]/2, 
                        track.tlwh[1] + track.tlwh[3]/2);
        _trackTrajectory[track.track_id].push_back(center);
        
        // é™åˆ¶è½¨è¿¹é•¿åº¦ï¼ˆä¿ç•™æœ€è¿‘100ä¸ªç‚¹ï¼‰
        if (_trackTrajectory[track.track_id].size() > 100) {
            _trackTrajectory[track.track_id].erase(
                _trackTrajectory[track.track_id].begin());
        }
    }
    
    return tracks;
}

// â­ æ–°å¢ï¼šæ£€æŸ¥åŒºåŸŸåœç•™æ—¶é•¿
bool Detech::checkRegionStayAlarm(int trackId, const cv::Point& center) {
    auto now = std::chrono::steady_clock::now();
    
    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥åŒºåŸŸ
    if (_trackEnterTime.find(trackId) == _trackEnterTime.end()) {
        _trackEnterTime[trackId] = now;
        return false;
    }
    
    // è®¡ç®—åœç•™æ—¶é•¿
    auto elapsed = std::chrono::duration_cast<std::chrono::seconds>(
        now - _trackEnterTime[trackId]).count();
    
    // è¶…è¿‡é˜ˆå€¼è§¦å‘å‘Šè­¦
    if (elapsed >= _config.regionStayThreshold) {
        _trackEnterTime.erase(trackId);  // é‡ç½®ï¼Œé¿å…é‡å¤å‘Šè­¦
        return true;
    }
    
    return false;
}

// â­ æ–°å¢ï¼šæ£€æŸ¥å¾˜å¾Šè¡Œä¸º
bool Detech::checkLoiteringAlarm(int trackId) {
    // éœ€è¦è‡³å°‘æœ‰10ä¸ªè½¨è¿¹ç‚¹
    if (_trackTrajectory[trackId].size() < 10) {
        return false;
    }
    
    // è®¡ç®—è½¨è¿¹çš„ä½ç§»
    const auto& trajectory = _trackTrajectory[trackId];
    cv::Point start = trajectory.front();
    cv::Point end = trajectory.back();
    float displacement = cv::norm(end - start);
    
    // å¦‚æœä½ç§»å¾ˆå°ï¼Œä½†å­˜åœ¨æ—¶é—´å¾ˆé•¿ï¼Œåˆ¤æ–­ä¸ºå¾˜å¾Š
    auto firstSeen = _trackFirstSeen[trackId];
    auto now = std::chrono::steady_clock::now();
    auto duration = std::chrono::duration_cast<std::chrono::seconds>(
        now - firstSeen).count();
    
    // å¾˜å¾Šåˆ¤æ–­ï¼šå­˜åœ¨è¶…è¿‡é˜ˆå€¼æ—¶é—´ï¼Œä½†ä½ç§»å¾ˆå°ï¼ˆ< 50åƒç´ ï¼‰
    if (duration >= _config.loiteringThreshold && displacement < 50) {
        return true;
    }
    
    return false;
}

// â­ æ–°å¢ï¼šç»˜åˆ¶è¿½è¸ªä¿¡æ¯
void Detech::drawTrackingInfo(cv::Mat& frame, const std::vector<STrack>& tracks) {
    for (const auto& track : tracks) {
        // ç»˜åˆ¶æ£€æµ‹æ¡†
        cv::Rect rect(track.tlwh[0], track.tlwh[1], track.tlwh[2], track.tlwh[3]);
        cv::rectangle(frame, rect, cv::Scalar(0, 255, 0), 2);
        
        // ç»˜åˆ¶track_id
        std::string label = "ID:" + std::to_string(track.track_id);
        int baseLine;
        cv::Size labelSize = cv::getTextSize(label, cv::FONT_HERSHEY_SIMPLEX, 
                                            0.5, 1, &baseLine);
        cv::rectangle(frame, 
                     cv::Point(rect.x, rect.y - labelSize.height - 5),
                     cv::Point(rect.x + labelSize.width, rect.y),
                     cv::Scalar(0, 255, 0), -1);
        cv::putText(frame, label, 
                   cv::Point(rect.x, rect.y - 5),
                   cv::FONT_HERSHEY_SIMPLEX, 0.5, 
                   cv::Scalar(0, 0, 0), 1);
        
        // ç»˜åˆ¶è½¨è¿¹ï¼ˆå¯é€‰ï¼‰
        if (_trackTrajectory.find(track.track_id) != _trackTrajectory.end()) {
            const auto& trajectory = _trackTrajectory[track.track_id];
            for (size_t i = 1; i < trajectory.size(); ++i) {
                cv::line(frame, trajectory[i-1], trajectory[i], 
                        cv::Scalar(255, 0, 255), 2);
            }
        }
    }
}

// â­ æ–°å¢ï¼šèµ„æºé‡Šæ”¾
void Detech::releaseResources() {
    // ... ç°æœ‰é‡Šæ”¾ä»£ç  ...
    
    // é‡Šæ”¾ByteTrackè¿½è¸ªå™¨
    if (_tracker) {
        delete _tracker;
        _tracker = nullptr;
    }
    
    LOG(INFO) << "[CLEANUP] All resources released successfully";
}
```

#### Day 7ï¼šé…ç½®æ–‡ä»¶å’Œæµ‹è¯•

**æ›´æ–°é…ç½®æ–‡ä»¶** (`TASK/config/test.ini`)ï¼š

```ini
[task]
task_id=1
task_name=entrance_monitor

[video]
source=rtsp://admin:Admin123@192.168.1.100:554/stream1
width=1920
height=1080
fps=25

[model]
model_path=models/SafeHat.onnx
confidence_threshold=0.5

[rtmp]
enable=true
rtmp_url=rtmp://localhost:1935/live/camera_1
fps=25

[alarm]
enable=true
hook_url=http://localhost:48080/admin-api/device/alarm
confidence_threshold=0.6
cooldown_time=10

[regions]
entrance=[[100,200],[300,200],[300,400],[100,400]]

# â­ æ–°å¢ï¼šè¿½è¸ªé…ç½®
[tracking]
enable=true
max_lost_frames=30        # æœ€å¤šä¸¢å¤±30å¸§ååˆ é™¤track
track_buffer=30           # trackç¼“å†²å¸§æ•°
match_threshold=0.8       # åŒ¹é…é˜ˆå€¼
min_box_area=100          # æœ€å°æ¡†é¢ç§¯ï¼ˆåƒç´ ï¼‰

# â­ æ–°å¢ï¼šé«˜çº§å‘Šè­¦é…ç½®
[advanced_alarm]
enable_region_stay=true
region_stay_threshold=60  # åœ¨åŒºåŸŸå†…åœç•™è¶…è¿‡60ç§’å‘Šè­¦

enable_loitering=true
loitering_threshold=120   # å¾˜å¾Šè¶…è¿‡120ç§’å‘Šè­¦

[features]
enable_rtmp=true
enable_draw=true
enable_alarm=true
enable_tracking=true      # â­ æ–°å¢
```

**æµ‹è¯•éªŒè¯**ï¼š

```bash
# 1. ç¼–è¯‘
cd TASK
cmake --build build --config Release

# 2. è¿è¡ŒTASKï¼ˆå¸¦è¿½è¸ªï¼‰
.\build\Release\TASK.exe config\test.ini

# 3. è§‚å¯Ÿæ—¥å¿—
[ByteTrack] Tracker initialized
[Track] New track ID: 1
[Track] New track ID: 2
[Track] New track ID: 3

# 4. æ’­æ”¾è§†é¢‘ï¼ˆåº”è¯¥èƒ½çœ‹åˆ°IDæ ‡ç­¾ï¼‰
ffplay http://localhost/live/camera_1.flv

# 5. éªŒè¯å‘Šè­¦ï¼ˆå¸¦track_idï¼‰
curl http://localhost:48080/admin-api/device/alarm
# åº”è¯¥èƒ½çœ‹åˆ°ï¼š
# {
#   "detections": [
#     {"track_id": 3, "class": "person", "confidence": 0.85}
#   ]
# }
```

**éªŒæ”¶æ ‡å‡†**ï¼š

- [ ] è§†é¢‘ä¸Šæ˜¾ç¤ºtrack_idï¼ˆ1ã€2ã€3...ï¼‰
- [ ] track_idè¿ç»­ç¨³å®šï¼ˆä¸é¢‘ç¹è·³å˜ï¼‰
- [ ] å‘Šè­¦æ•°æ®åŒ…å«track_id
- [ ] åŒºåŸŸåœç•™å‘Šè­¦æ­£å¸¸è§¦å‘
- [ ] å¾˜å¾Šæ£€æµ‹æ­£å¸¸è§¦å‘
- [ ] æ€§èƒ½æ— æ˜æ˜¾ä¸‹é™ï¼ˆFPSä»â‰¥20ï¼‰

---

### é˜¶æ®µ3ï¼šå‰ç«¯é›†æˆTaskManagerï¼ˆ2-3å¤©ï¼‰

#### Day 4-5ï¼šå‰ç«¯APIå¯¹æ¥

**æ–°å»ºæ–‡ä»¶**: `WEB/src/api/task/index.ts`

```typescript
import {defHttp} from '@/utils/http/axios';

// ====================== æ¥å£ç±»å‹å®šä¹‰ ======================

export interface TaskConfig {
  task_id: number;
  task_name?: string;
  video: {
    source: string;       // RTSPåœ°å€
    width: number;
    height: number;
    fps: number;
  };
  model: {
    model_path: string;
    confidence_threshold: number;
    nms_threshold?: number;
    threads?: number;
  };
  rtmp: {
    rtmp_url: string;
    fps: number;
  };
  alarm: {
    enable: boolean;
    hook_url: string;
    confidence_threshold: number;
    cooldown_time: number;
  };
  regions?: Array<{
    region_id: string;
    polygon: number[][];
  }>;
}

export interface TaskStatus {
  task_id: number;
  status: 'running' | 'stopped' | 'error';
  config_path?: string;
}

// ====================== APIå‡½æ•° ======================

// ç”Ÿæˆé…ç½®æ–‡ä»¶
export const generateConfig = (config: TaskConfig) => {
  return defHttp.post<{config_path: string}>({
    url: '/dev-api/task/config/generate',
    data: config
  });
};

// å¯åŠ¨ä»»åŠ¡
export const startTask = (taskId: number, configPath: string) => {
  return defHttp.post({
    url: '/dev-api/task/start',
    data: { task_id: taskId, config_path: configPath }
  });
};

// åœæ­¢ä»»åŠ¡
export const stopTask = (taskId: number) => {
  return defHttp.post({
    url: '/dev-api/task/stop',
    data: { task_id: taskId }
  });
};

// æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
export const getTaskStatus = (taskId: number) => {
  return defHttp.get<TaskStatus>({
    url: '/dev-api/task/status',
    params: { task_id: taskId }
  });
};

// è·å–æ‰€æœ‰ä»»åŠ¡åˆ—è¡¨
export const getTaskList = () => {
  return defHttp.get<TaskStatus[]>({
    url: '/dev-api/task/list'
  });
};
```

**é…ç½®å‰ç«¯ä»£ç†**ï¼ˆ`WEB/.env.development`ï¼‰:
```javascript
VITE_PORT = 8099
VITE_PROXY = [
  ["/api/v1/buckets", "http://localhost:9000/api/v1/buckets"],
  ["/dev-api/nodeRed", "http://127.0.0.1:1880"],
  ["/dev-api/task", "http://127.0.0.1:7000"],              // âš ï¸ æ–°å¢
  ["/dev-api", "http://127.0.0.1:48080/admin-api"]
]
```

#### Day 6ï¼šæ‰©å±•æ‘„åƒå¤´ç®¡ç†é¡µé¢

**æ–‡ä»¶**: `WEB/src/views/camera/index.vue`

**åœ¨ç°æœ‰é¡µé¢æ·»åŠ AIä»»åŠ¡æŒ‰é’®**:
```vue
<template>
  <div class="camera-container">
    <BasicTable @register="registerTable">
      <template #bodyCell="{ column, record }">
        <template v-if="column.dataIndex === 'action'">
          <TableAction :actions="getTableActions(record)" />
        </template>
      </template>
    </BasicTable>
  </div>
</template>

<script lang="ts" setup>
import { useMessage } from '@/hooks/web/useMessage';
import { startTask, stopTask, generateConfig } from '@/api/task';

const { createMessage } = useMessage();

// æ‰©å±•æ“ä½œæŒ‰é’®
const getTableActions = (record) => {
  return [
    {
      icon: 'octicon:play-16',
      tooltip: 'æ’­æ”¾è§†é¢‘',
      onClick: () => handlePlay(record)
    },
    {
      icon: 'ant-design:play-circle-outlined',
      tooltip: 'å¯åŠ¨RTSPè½¬å‘ï¼ˆæ— AIï¼‰',
      onClick: () => handleStartForwarding(record)
    },
    {
      icon: 'ant-design:robot-outlined',      // âš ï¸ æ–°å¢
      tooltip: 'å¯åŠ¨AIæ£€æµ‹',
      onClick: () => handleStartAI(record),
      color: 'success'
    },
    {
      icon: 'ant-design:stop-outlined',        // âš ï¸ æ–°å¢
      tooltip: 'åœæ­¢AIæ£€æµ‹',
      onClick: () => handleStopAI(record),
      color: 'error'
    },
    {
      icon: 'material-symbols:edit-outline-rounded',
      tooltip: 'ç¼–è¾‘',
      onClick: () => handleEdit(record)
    },
    {
      icon: 'material-symbols:delete-outline-rounded',
      tooltip: 'åˆ é™¤',
      popConfirm: {
        title: 'ç¡®å®šåˆ é™¤æ­¤è®¾å¤‡ï¼Ÿ',
        confirm: () => handleDelete(record.id)
      }
    }
  ];
};

// âš ï¸ æ–°å¢ï¼šå¯åŠ¨AIæ£€æµ‹ä»»åŠ¡
const handleStartAI = async (record) => {
  try {
    createMessage.loading({ content: 'æ­£åœ¨å¯åŠ¨AIæ£€æµ‹...', key: 'ai' });
    
    // 1. æ„å»ºé…ç½®
    const config = {
      task_id: parseInt(record.id),
      task_name: record.name,
      video: {
        source: record.source,  // RTSPåœ°å€
        width: 1920,
        height: 1080,
        fps: 25
      },
      model: {
        model_path: 'models/SafeHat.onnx',    // âš ï¸ å¯ä»¥è®©ç”¨æˆ·é€‰æ‹©
        confidence_threshold: 0.5
      },
      rtmp: {
        rtmp_url: `rtmp://localhost:1935/live/ai_camera_${record.id}`,
        fps: 25
      },
      alarm: {
        enable: true,
        hook_url: `http://localhost:48080/admin-api/device/alarm`,
        confidence_threshold: 0.6,
        cooldown_time: 10
      }
    };
    
    // 2. ç”Ÿæˆé…ç½®æ–‡ä»¶
    const configRes = await generateConfig(config);
    
    // 3. å¯åŠ¨TASK
    await startTask(parseInt(record.id), configRes.data.config_path);
    
    createMessage.success({ content: 'AIæ£€æµ‹å·²å¯åŠ¨', key: 'ai' });
    
    // 4. æ›´æ–°æ’­æ”¾åœ°å€ï¼ˆåˆ‡æ¢ä¸ºAIæµï¼‰
    record.http_stream = `http://localhost/live/ai_camera_${record.id}.flv`;
    reload();
    
  } catch (error) {
    console.error('å¯åŠ¨AIæ£€æµ‹å¤±è´¥', error);
    createMessage.error({ content: 'å¯åŠ¨AIæ£€æµ‹å¤±è´¥', key: 'ai' });
  }
};

// âš ï¸ æ–°å¢ï¼šåœæ­¢AIæ£€æµ‹ä»»åŠ¡
const handleStopAI = async (record) => {
  try {
    createMessage.loading({ content: 'æ­£åœ¨åœæ­¢AIæ£€æµ‹...', key: 'ai' });
    await stopTask(parseInt(record.id));
    createMessage.success({ content: 'AIæ£€æµ‹å·²åœæ­¢', key: 'ai' });
    reload();
  } catch (error) {
    console.error('åœæ­¢AIæ£€æµ‹å¤±è´¥', error);
    createMessage.error({ content: 'åœæ­¢AIæ£€æµ‹å¤±è´¥', key: 'ai' });
  }
};
</script>
```

---

### é˜¶æ®µ4ï¼šè§†é¢‘å¢™å±•ç¤ºï¼ˆ1-2å¤©ï¼‰

#### Day 7ï¼šæ–°å»ºè§†é¢‘å¢™é¡µé¢

**æ–°å»ºæ–‡ä»¶**: `WEB/src/views/ai-task/video-wall.vue`

```vue
<template>
  <div class="video-wall-container">
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="video-wall-header">
      <h2>AIæ£€æµ‹è§†é¢‘å¢™ï¼ˆ{{ runningTasks.length }}/50è·¯ï¼‰</h2>
      <a-radio-group v-model:value="gridLayout" button-style="solid">
        <a-radio-button value="2x2">2x2</a-radio-button>
        <a-radio-button value="3x3">3x3</a-radio-button>
        <a-radio-button value="4x4">4x4</a-radio-button>
        <a-radio-button value="5x5">5x5</a-radio-button>
      </a-radio-group>
      <a-button @click="refreshTasks" type="primary">
        <template #icon><SyncOutlined /></template>
        åˆ·æ–°
      </a-button>
    </div>
    
    <!-- è§†é¢‘ç½‘æ ¼ -->
    <div :class="`video-wall-grid grid-${gridLayout}`">
      <div 
        v-for="task in runningTasks" 
        :key="task.task_id"
        class="video-wall-item"
        :class="{ 'has-alarm': task.has_alarm }"
      >
        <!-- Jessibucaæ’­æ”¾å™¨ -->
        <Jessibuca 
          :playUrl="task.http_flv_url" 
          :hasAudio="false"
          class="video-player"
        />
        
        <!-- ä¿¡æ¯è¦†ç›–å±‚ -->
        <div class="video-info-overlay">
          <div class="video-title">{{ task.camera_name }}</div>
          <div class="video-stats">
            <span class="status" :class="task.status">{{ task.status }}</span>
          </div>
        </div>
        
        <!-- å‘Šè­¦æ ‡è¯† -->
        <div v-if="task.has_alarm" class="alarm-indicator">
          <WarningOutlined /> å‘Šè­¦ä¸­
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts" setup>
import { ref, onMounted, onUnmounted } from 'vue';
import { getTaskList } from '@/api/task';
import Jessibuca from '@/components/Player/module/jessibuca.vue';
import { WarningOutlined, SyncOutlined } from '@ant-design/icons-vue';

const gridLayout = ref('3x3');
const runningTasks = ref([]);
const updateTimer = ref(null);

// è·å–è¿è¡Œä¸­çš„ä»»åŠ¡
const fetchRunningTasks = async () => {
  try {
    const response = await getTaskList();
    runningTasks.value = response.data
      .filter(task => task.status === 'running')
      .map(task => ({
        ...task,
        http_flv_url: `http://localhost/live/ai_task_${task.task_id}.flv`,
        camera_name: `æ‘„åƒå¤´ ${task.task_id}`,
        has_alarm: false  // âš ï¸ åç»­é€šè¿‡WebSocketæ›´æ–°
      }));
  } catch (error) {
    console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥', error);
  }
};

const refreshTasks = () => {
  fetchRunningTasks();
};

onMounted(() => {
  fetchRunningTasks();
  // æ¯5ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
  updateTimer.value = setInterval(fetchRunningTasks, 5000);
});

onUnmounted(() => {
  if (updateTimer.value) {
    clearInterval(updateTimer.value);
  }
});
</script>

<style scoped lang="less">
.video-wall-container {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #000;
}

.video-wall-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: #1a1a1a;
  color: #fff;
  
  h2 {
    margin: 0;
    color: #fff;
  }
}

.video-wall-grid {
  flex: 1;
  display: grid;
  gap: 8px;
  padding: 8px;
  
  &.grid-2x2 { grid-template-columns: repeat(2, 1fr); }
  &.grid-3x3 { grid-template-columns: repeat(3, 1fr); }
  &.grid-4x4 { grid-template-columns: repeat(4, 1fr); }
  &.grid-5x5 { grid-template-columns: repeat(5, 1fr); }
}

.video-wall-item {
  position: relative;
  background: #222;
  border-radius: 4px;
  overflow: hidden;
  aspect-ratio: 16 / 9;
  
  &.has-alarm {
    box-shadow: 0 0 20px rgba(255, 77, 79, 0.8);
    border: 2px solid #ff4d4f;
  }
  
  &:hover .video-info-overlay {
    opacity: 1;
  }
}

.video-player {
  width: 100%;
  height: 100%;
}

.video-info-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
  padding: 8px;
  opacity: 0.7;
  transition: opacity 0.3s;
  
  .video-title {
    color: #fff;
    font-size: 14px;
    font-weight: bold;
  }
  
  .video-stats {
    margin-top: 4px;
    
    .status {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 3px;
      
      &.running {
        background: #52c41a;
        color: #fff;
      }
      
      &.stopped {
        background: #d9d9d9;
        color: #000;
      }
      
      &.error {
        background: #ff4d4f;
        color: #fff;
      }
    }
  }
}

.alarm-indicator {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #ff4d4f;
  color: #fff;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 49% { opacity: 1; }
  50%, 100% { opacity: 0.3; }
}
</style>
```

**æ·»åŠ è·¯ç”±**ï¼ˆ`WEB/src/router/routes/modules/ai-task.ts`ï¼‰:
```typescript
import type { RouteRecordRaw } from 'vue-router';

const routes: RouteRecordRaw[] = [
  {
    path: '/ai-task',
    name: 'AITask',
    redirect: '/ai-task/video-wall',
    meta: {
      title: 'AIæ£€æµ‹ä»»åŠ¡',
      icon: 'ant-design:robot-outlined',
    },
    children: [
      {
        path: 'video-wall',
        name: 'VideoWall',
        component: () => import('@/views/ai-task/video-wall.vue'),
        meta: {
          title: 'è§†é¢‘å¢™',
          icon: 'ant-design:appstore-outlined',
        },
      },
    ],
  },
];

export default routes;
```

---

## ğŸ¯ ç¬¬äº”éƒ¨åˆ†ï¼š50è·¯æ‘„åƒå¤´éƒ¨ç½²æ–¹æ¡ˆ

### 5.1 ç¡¬ä»¶è¦æ±‚

| ç»„ä»¶ | æ¨èé…ç½® | æœ€ä½é…ç½® | è¯´æ˜ |
|------|---------|---------|------|
| **CPU** | Intel i7-12700 (12æ ¸24çº¿ç¨‹) | Intel i5-11400 (6æ ¸12çº¿ç¨‹) | 50è·¯AIæ¨ç†éœ€è¦å¼ºCPU |
| **å†…å­˜** | 64GB DDR4 | 32GB DDR4 | æ¯è·¯TASKçº¦500MBï¼Œ50è·¯éœ€25GB+ |
| **å­˜å‚¨** | 1TB NVMe SSD | 500GB SATA SSD | æ¨¡å‹ã€é…ç½®ã€æ—¥å¿— |
| **ç½‘ç»œ** | åŒåƒå…†ç½‘å¡ | å•åƒå…†ç½‘å¡ | 50è·¯è§†é¢‘æµå¸¦å®½éœ€æ±‚å¤§ |
| **GPUï¼ˆå¯é€‰ï¼‰** | RTX 4070 (12GB) | RTX 3060 (12GB) | åŠ é€ŸAIæ¨ç†ï¼ˆå¯é€‰ï¼ŒCPUä¹Ÿèƒ½è·‘ï¼‰ |

### 5.2 è½¯ä»¶æ¶æ„

```
è¾¹ç¼˜æœåŠ¡å™¨ï¼ˆä¸€å°ç‰©ç†æœºï¼‰
â”œâ”€â”€ Windows 10/11 æˆ– Ubuntu 22.04
â”œâ”€â”€ ZLMediaKitï¼ˆæµåª’ä½“æœåŠ¡å™¨ï¼‰- 1ä¸ªå®ä¾‹
â”‚   â”œâ”€â”€ RTMPæœåŠ¡å™¨ (:1935)
â”‚   â””â”€â”€ HTTP-FLVæœåŠ¡å™¨ (:80)
â”œâ”€â”€ TaskManagerï¼ˆè¿›ç¨‹ç®¡ç†å™¨ï¼‰- 1ä¸ªå®ä¾‹ (:7000)
â”‚   â”œâ”€â”€ TASKå®ä¾‹ #1ï¼ˆcamera_1ï¼‰
â”‚   â”œâ”€â”€ TASKå®ä¾‹ #2ï¼ˆcamera_2ï¼‰
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ TASKå®ä¾‹ #50ï¼ˆcamera_50ï¼‰
â”œâ”€â”€ PostgreSQL (:5432)
â”œâ”€â”€ MinIO (:9000)
â””â”€â”€ Node-RED (:1880)
```

### 5.3 èµ„æºå ç”¨ä¼°ç®—

**å•è·¯TASKèµ„æºå ç”¨**:
```
CPUå ç”¨: ~8-10% (å•æ ¸)
å†…å­˜å ç”¨: ~500MB
æ¨ç†é€Ÿåº¦: 20-30 FPS
RTMPæ¨æµ: 1-2Mbps
```

**50è·¯å¹¶å‘é¢„ä¼°**:
```
CPUå ç”¨: ~60-80% (12æ ¸å¿ƒ)
å†…å­˜å ç”¨: ~25-30GB
ç½‘ç»œå¸¦å®½:
  - RTSPå…¥ç«™: 50 Ã— 4Mbps = 200Mbps
  - RTMPå‡ºç«™: 50 Ã— 2Mbps = 100Mbps
  - æ€»è®¡: ~300Mbpsï¼ˆéœ€åƒå…†ç½‘ç»œï¼‰
```

### 5.4 éƒ¨ç½²æ­¥éª¤

#### Step 1: å¯åŠ¨ZLMediaKit

```bash
# Windows
cd F:\EASYLOT\zlmediakit
.\MediaServer.exe -c config.ini

# Linux
cd /opt/zlmediakit
./MediaServer -c config.ini
```

**éªŒè¯**:
```bash
# è®¿é—®Webç®¡ç†ç•Œé¢
http://localhost/index/api/getMediaList?secret=your_secret
```

#### Step 2: å¯åŠ¨TaskManager

```bash
cd F:\EASYLOT\easyaiot-main\TASK\build\Release
.\TaskManager.exe
```

**éªŒè¯**:
```bash
curl http://localhost:7000/task/list
# åº”è¯¥è¿”å›: {"code": 0, "data": []}
```

#### Step 3: æ‰¹é‡åˆ›å»º50è·¯ä»»åŠ¡

**PowerShellè„šæœ¬**ï¼ˆ`create_50_tasks.ps1`ï¼‰:
```powershell
$baseUrl = "http://localhost:7000"

# æ‘„åƒå¤´IPèŒƒå›´: 192.168.1.100 ~ 192.168.1.149
for ($i = 1; $i -le 50; $i++) {
    $cameraIp = "192.168.1." + (100 + $i - 1)
    
    $config = @{
        task_id = $i
        task_name = "camera_$i"
        video = @{
            source = "rtsp://admin:Admin123@${cameraIp}:554/stream1"
            width = 1920
            height = 1080
            fps = 25
        }
        model = @{
            model_path = "models/SafeHat.onnx"
            confidence_threshold = 0.5
        }
        rtmp = @{
            rtmp_url = "rtmp://localhost:1935/live/camera_$i"
            fps = 25
        }
        alarm = @{
            enable = $true
            hook_url = "http://localhost:48080/admin-api/device/alarm"
            confidence_threshold = 0.6
            cooldown_time = 10
        }
    } | ConvertTo-Json -Depth 10
    
    # 1. ç”Ÿæˆé…ç½®æ–‡ä»¶
    $configRes = Invoke-RestMethod -Uri "$baseUrl/config/generate" -Method POST -Body $config -ContentType "application/json"
    
    # 2. å¯åŠ¨ä»»åŠ¡
    $startBody = @{
        task_id = $i
        config_path = $configRes.config_path
    } | ConvertTo-Json
    
    Invoke-RestMethod -Uri "$baseUrl/task/start" -Method POST -Body $startBody -ContentType "application/json"
    
    Write-Host "Task $i started successfully"
    Start-Sleep -Milliseconds 500
}

Write-Host "All 50 tasks started!"
```

**æ‰§è¡Œ**:
```powershell
.\create_50_tasks.ps1
```

#### Step 4: è®¿é—®å‰ç«¯è§†é¢‘å¢™

æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:8099/ai-task/video-wall`

é€‰æ‹©5x5å¸ƒå±€ â†’ åŒæ—¶çœ‹åˆ°25è·¯è§†é¢‘ï¼ˆå¯æ»šåŠ¨æŸ¥çœ‹å…¨éƒ¨50è·¯ï¼‰

---

## âœ… ç¬¬å…­éƒ¨åˆ†ï¼šéªŒæ”¶æ ‡å‡†

### 6.1 åŠŸèƒ½éªŒæ”¶

- [ ] **å•è·¯TASKæ­£å¸¸è¿è¡Œ**
  - RTSPæ‹‰æµæˆåŠŸ
  - YOLOæ¨ç†æ­£å¸¸
  - RTMPæ¨æµæˆåŠŸ
  - HTTP-FLVæ’­æ”¾æ­£å¸¸
  - å‘Šè­¦å›è°ƒæˆåŠŸ

- [ ] **åŒºåŸŸæ£€æµ‹åŠŸèƒ½**
  - é…ç½®å¤šè¾¹å½¢åŒºåŸŸ
  - åŒºåŸŸå†…æ£€æµ‹ â†’ è§¦å‘å‘Šè­¦ âœ…
  - åŒºåŸŸå¤–æ£€æµ‹ â†’ ä¸è§¦å‘å‘Šè­¦ âœ…

- [ ] **TaskManageråŠŸèƒ½**
  - æˆåŠŸç®¡ç†50ä¸ªTASKå®ä¾‹
  - APIå“åº”æ—¶é—´ < 100ms
  - å¯åŠ¨ä»»åŠ¡æˆåŠŸç‡ > 95%
  - ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢å‡†ç¡®

- [ ] **å‰ç«¯åŠŸèƒ½**
  - å¯åŠ¨/åœæ­¢AIä»»åŠ¡
  - å®æ—¶æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€
  - è§†é¢‘å¢™æ’­æ”¾å¤šè·¯è§†é¢‘
  - å‘Šè­¦å®æ—¶æ˜¾ç¤ºï¼ˆ< 1ç§’ï¼‰

- [ ] **å‘Šè­¦å¤„ç†**
  - TASK â†’ DEVICEå‘Šè­¦æ¥å£æ­£å¸¸
  - Node-REDè§„åˆ™å¼•æ“è§¦å‘
  - ä¼ä¸šå¾®ä¿¡/é’‰é’‰é€šçŸ¥æˆåŠŸ

### 6.2 æ€§èƒ½éªŒæ”¶

- [ ] **å•è·¯TASKæ€§èƒ½**
  - FPS â‰¥ 20
  - è§†é¢‘å»¶è¿Ÿ â‰¤ 2ç§’
  - CPUå ç”¨ â‰¤ 15% (å•æ ¸)
  - å†…å­˜å ç”¨ â‰¤ 600MB

- [ ] **50è·¯å¹¶å‘æ€§èƒ½**
  - æ‰€æœ‰ä»»åŠ¡åŒæ—¶è¿è¡Œ
  - ç³»ç»Ÿç¨³å®šï¼ˆæ— å´©æºƒï¼‰
  - æ€»CPUå ç”¨ < 85%
  - æ€»å†…å­˜å ç”¨ < 30GB

- [ ] **ç¨³å®šæ€§æµ‹è¯•**
  - 24å°æ—¶è¿ç»­è¿è¡Œ
  - å†…å­˜å¢é•¿ < 10%
  - æ— å†…å­˜æ³„æ¼
  - RTSPæ–­çº¿è‡ªåŠ¨é‡è¿

### 6.3 ç”¨æˆ·ä½“éªŒéªŒæ”¶

- [ ] å‰ç«¯æ“ä½œæµç•…ï¼ˆå¯åŠ¨ä»»åŠ¡ < 3ç§’ï¼‰
- [ ] è§†é¢‘å¢™å¸ƒå±€å¯è°ƒæ•´ï¼ˆ2x2 / 3x3 / 4x4 / 5x5ï¼‰
- [ ] å‘Šè­¦å®æ—¶æ˜¾ç¤ºï¼ˆå»¶è¿Ÿ < 1ç§’ï¼‰
- [ ] æ—¥å¿—å¯æŸ¥è¯¢ï¼ˆGlogè¾“å‡ºï¼‰
- [ ] é…ç½®ç®¡ç†å‹å¥½ï¼ˆWebç•Œé¢ï¼Œéæ‰‹åŠ¨ç¼–è¾‘INIï¼‰

---

## ğŸ“š ç¬¬ä¸ƒéƒ¨åˆ†ï¼šé…ç½®æ–‡ä»¶å‚è€ƒ

### 7.1 ZLMediaKité…ç½®ï¼ˆä½å»¶è¿Ÿï¼‰

**æ–‡ä»¶**: `F:\EASYLOT\zlmediakit\config.ini`

```ini
[general]
enableVhost=0
flowThreshold=1024

[http]
port=80
sslport=443

[rtmp]
port=1935
sslport=19350

[rtsp]
port=554
sslport=322

[rtp]
port=10000

[protocol]
modify_stamp=1
enable_audio=1

# âš ï¸ ä½å»¶è¿Ÿé…ç½®
[rtsp.stream]
gop_cache=0

[rtmp.stream]
gop_cache=0

[hls.stream]
gop_cache=0

[http-flv.stream]
gop_cache=0
```

### 7.2 TASKé…ç½®å®Œæ•´ç¤ºä¾‹

**æ–‡ä»¶**: `TASK/config/task1.ini`

```ini
[task]
task_id=1
task_name=entrance_monitor

[video]
source=rtsp://admin:Admin123@192.168.1.100:554/stream1
width=1920
height=1080
fps=25
enable=true

[model]
model_path=models/SafeHat.onnx
classes_path=models/SafeHat_cn.txt
confidence_threshold=0.5
nms_threshold=0.45
threads=1

[rtmp]
enable=true
rtmp_url=rtmp://localhost:1935/live/camera_1
fps=25
enable_draw=true

[alarm]
enable=true
hook_url=http://localhost:48080/admin-api/device/alarm
confidence_threshold=0.6
cooldown_time=10

[regions]
entrance=[[100,100],[500,100],[500,400],[100,400]]
parking=[[600,100],[900,100],[900,400],[600,400]]

[features]
enable_rtmp=true
enable_draw=true
enable_alarm=true
```

### 7.3 å‰ç«¯ç¯å¢ƒé…ç½®

**æ–‡ä»¶**: `WEB/.env`

```bash
# ç«¯å£å·
VITE_PORT = 8099

# ç½‘ç«™æ ‡é¢˜
VITE_GLOB_APP_TITLE = äº‘è¾¹ç«¯ä¸€ä½“åŒ–æ™ºèƒ½ç®—æ³•åº”ç”¨å¹³å°

# ç®€ç§°
VITE_GLOB_APP_SHORT_NAME = BasicLab_IoT_Admin

# ç§Ÿæˆ·å¼€å…³
VITE_GLOB_APP_TENANT_ENABLE = true

# éªŒè¯ç çš„å¼€å…³
VITE_GLOB_APP_CAPTCHA_ENABLE = true

# æ–‡æ¡£åœ°å€çš„å¼€å…³
VITE_APP_DOCALERT_ENABLE=true

# ç™¾åº¦ç»Ÿè®¡
VITE_APP_BAIDU_CODE = eb21166668bf766b9d059a6fd1c10777
```

**æ–‡ä»¶**: `WEB/.env.development`

```bash
# æœ¬åœ°å¼€å‘ç¯å¢ƒ
VITE_PUBLIC_PATH = /

# æœ¬åœ°å¼€å‘ä»£ç†
VITE_PROXY = [["/api/v1/buckets","http://localhost:9000/api/v1/buckets"],["/dev-api/nodeRed","http://127.0.0.1:1880"],["/dev-api/task","http://127.0.0.1:7000"],["/dev-api","http://127.0.0.1:48080/admin-api"]]

# æ˜¯å¦åˆ é™¤Console.log
VITE_DROP_CONSOLE = false

# åŸºç¡€é¡µé¢æ ‡é¢˜
VITE_GLOB_APP_TITLE = EasyAIoT

# åŸºç¡€é¡µé¢åœ°å€
VITE_GLOB_BASE_URL = "http://localhost:48080"

# æ¥å£åœ°å€
VITE_GLOB_API_URL = /dev-api

# æ–‡ä»¶ä¸Šä¼ æ¥å£
VITE_GLOB_UPLOAD_URL = http://localhost:48080/admin-api

# æ¥å£åœ°å€å‰ç¼€
VITE_GLOB_API_URL_PREFIX =
```

---

## ğŸ› ç¬¬å…«éƒ¨åˆ†ï¼šæ•…éšœæ’æŸ¥æŒ‡å—

### 8.1 å¸¸è§é—®é¢˜é€ŸæŸ¥

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| RTSPè¿æ¥å¤±è´¥ | æ‘„åƒå¤´åœ°å€é”™è¯¯/ç½‘ç»œä¸é€š | 1. pingæ‘„åƒå¤´IP<br>2. ç”¨VLCæµ‹è¯•RTSPåœ°å€<br>3. æ£€æŸ¥ç”¨æˆ·åå¯†ç  |
| RTMPæ¨æµå¤±è´¥ | ZLMediaKitæœªå¯åŠ¨/ç«¯å£å ç”¨ | 1. æ£€æŸ¥MediaServerè¿›ç¨‹<br>2. `netstat -ano \| findstr 1935` |
| HTTP-FLVæ’­æ”¾å¤±è´¥ | æµæœªæ¨é€/é˜²ç«å¢™é˜»æ­¢ | 1. è®¿é—® `http://localhost/index/api/getMediaList`<br>2. å…³é—­é˜²ç«å¢™æµ‹è¯• |
| å‘Šè­¦æœªè§¦å‘ | enable_alarm=false | æ£€æŸ¥ `[features]` å’Œ `[alarm]` ä¸¤å¤„é…ç½® |
| TaskManager APIå¤±è´¥ | ç«¯å£å†²çª/æœåŠ¡æœªå¯åŠ¨ | 1. æ£€æŸ¥ç«¯å£7000æ˜¯å¦è¢«å ç”¨<br>2. æŸ¥çœ‹TaskManageræ—¥å¿— |
| å†…å­˜æ³„æ¼ | FFmpegèµ„æºæœªé‡Šæ”¾ | è°ƒç”¨ `releaseResources()` |
| å‰ç«¯è·¨åŸŸé”™è¯¯ | ä»£ç†é…ç½®é”™è¯¯ | æ£€æŸ¥ `WEB/.env.development` ä¸­çš„ `VITE_PROXY` |
| ä¸­æ–‡ä¹±ç  | æ–‡ä»¶ç¼–ç éUTF-8 | ç¡®ä¿æ‰€æœ‰æ–‡ä»¶ä½¿ç”¨UTF-8ç¼–ç  |

### 8.2 æ—¥å¿—æ–‡ä»¶ä½ç½®

```
TASKæ¨¡å—æ—¥å¿—:
- æ§åˆ¶å°è¾“å‡ºï¼ˆGlogï¼‰
- å¯é…ç½®åˆ°æ–‡ä»¶: FLAGS_log_dir = "./logs"

TaskManageræ—¥å¿—:
- æ§åˆ¶å°è¾“å‡º
- åŒ…å«æ‰€æœ‰APIè¯·æ±‚å’Œä»»åŠ¡çŠ¶æ€å˜åŒ–

ZLMediaKitæ—¥å¿—:
- F:\EASYLOT\zlmediakit\log\

å‰ç«¯æ—¥å¿—:
- æµè§ˆå™¨Console
- Networké¢æ¿æŸ¥çœ‹APIè¯·æ±‚
```

### 8.3 æ€§èƒ½ç›‘æ§å‘½ä»¤

**Windows**:
```powershell
# æŸ¥çœ‹TaskManagerè¿›ç¨‹
Get-Process | Where-Object {$_.Name -like "*TaskManager*"} | Select-Object Id,ProcessName,CPU,WorkingSet

# æŸ¥çœ‹æ‰€æœ‰TASKè¿›ç¨‹
Get-Process | Where-Object {$_.Name -like "*TASK*"} | Select-Object Id,ProcessName,CPU,WorkingSet

# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -ano | findstr "7000"
netstat -ano | findstr "1935"
netstat -ano | findstr "80"

# ç›‘æ§ç½‘ç»œå¸¦å®½
Get-Counter '\Network Interface(*)\Bytes Total/sec' -SampleInterval 1 -MaxSamples 10
```

**Linux**:
```bash
# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep TaskManager
ps aux | grep TASK

# æŸ¥çœ‹ç«¯å£
netstat -tlnp | grep 7000
netstat -tlnp | grep 1935

# ç›‘æ§èµ„æº
htop
iotop
nload
```

---

## ğŸ“Š ç¬¬ä¹éƒ¨åˆ†ï¼šAPIæ¥å£å®Œæ•´æ–‡æ¡£

### 9.1 TaskManager API

**Base URL**: `http://localhost:7000`  
**é€šè¿‡å‰ç«¯ä»£ç†**: `/dev-api/task`

#### POST /task/start - å¯åŠ¨ä»»åŠ¡

**è¯·æ±‚**:
```json
{
  "task_id": 1,
  "config_path": "config/task1.ini"
}
```

**å“åº”**:
```json
{
  "code": 0,
  "msg": "Task started successfully",
  "task_id": 1
}
```

#### POST /task/stop - åœæ­¢ä»»åŠ¡

**è¯·æ±‚**:
```json
{
  "task_id": 1
}
```

**å“åº”**:
```json
{
  "code": 0,
  "msg": "Task stopped successfully",
  "task_id": 1
}
```

#### GET /task/status - æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

**è¯·æ±‚**:
```
GET /task/status?task_id=1
```

**å“åº”**:
```json
{
  "code": 0,
  "data": {
    "task_id": 1,
    "status": "running",
    "config_path": "loaded"
  }
}
```

#### GET /task/list - ä»»åŠ¡åˆ—è¡¨

**è¯·æ±‚**:
```
GET /task/list
```

**å“åº”**:
```json
{
  "code": 0,
  "data": [
    {
      "task_id": 1,
      "status": "running"
    },
    {
      "task_id": 2,
      "status": "stopped"
    }
  ]
}
```

#### POST /config/generate - ç”Ÿæˆé…ç½®æ–‡ä»¶

**è¯·æ±‚**:
```json
{
  "task_id": 1,
  "task_name": "entrance_monitor",
  "video": {
    "source": "rtsp://admin:Admin123@192.168.1.100:554/stream1",
    "width": 1920,
    "height": 1080,
    "fps": 25
  },
  "model": {
    "model_path": "models/SafeHat.onnx",
    "confidence_threshold": 0.5
  },
  "rtmp": {
    "rtmp_url": "rtmp://localhost:1935/live/camera_1",
    "fps": 25
  },
  "alarm": {
    "enable": true,
    "hook_url": "http://localhost:48080/admin-api/device/alarm",
    "confidence_threshold": 0.6,
    "cooldown_time": 10
  },
  "regions": [
    {
      "region_id": "entrance",
      "polygon": [[100,100], [500,100], [500,400], [100,400]]
    }
  ]
}
```

**å“åº”**:
```json
{
  "code": 0,
  "msg": "Config generated successfully",
  "config_path": "config/task1.ini"
}
```

### 9.2 DEVICEå‘Šè­¦API

**Base URL**: `http://localhost:48080`  
**é€šè¿‡å‰ç«¯ä»£ç†**: `/dev-api/device`

#### POST /admin-api/device/alarm - è®¾å¤‡å‘Šè­¦å›è°ƒ

**è¯·æ±‚**:
```json
{
  "device_id": "camera_001",
  "alarm_type": "ai_detection",
  "alarm_level": "warning",
  "alarm_content": "æ£€æµ‹åˆ°æœªä½©æˆ´å®‰å…¨å¸½",
  "detections": [
    {
      "class_id": 0,
      "class_name": "no_helmet",
      "confidence": 0.85,
      "bbox": {
        "x": 100,
        "y": 200,
        "w": 50,
        "h": 100
      }
    }
  ],
  "region_id": "entrance",
  "timestamp": "2025-10-24 10:30:00"
}
```

**å“åº”**:
```json
{
  "code": 0,
  "msg": "Alarm received successfully"
}
```

---

## ğŸ“ˆ ç¬¬åéƒ¨åˆ†ï¼šå¼€å‘æ—¶é—´ä¼°ç®—

### æ€»è®¡å·¥ä½œé‡ï¼š11-16å¤©ï¼ˆå«ByteTrackè¿½è¸ªï¼‰

| é˜¶æ®µ | ä»»åŠ¡ | å·¥ä½œé‡ | ä¼˜å…ˆçº§ |
|------|------|--------|--------|
| **é˜¶æ®µ1** | **TASKæ¨¡å—è¡¥å…¨** | **1å¤©** | **P0** |
| | åŒºåŸŸè¿‡æ»¤é€»è¾‘ | 0.5å¤© | P0 |
| | èµ„æºé‡Šæ”¾å®Œå–„ | 0.5å¤© | P1 |
| **é˜¶æ®µ2** | **TaskManagerå¼€å‘** | **2-3å¤©** | **P0** |
| | HTTP APIå®ç° | 2å¤© | P0 |
| | é…ç½®ç”Ÿæˆå™¨ | 0.5å¤© | P0 |
| | æµ‹è¯•éªŒè¯ | 0.5å¤© | P0 |
| â­ **é˜¶æ®µ2.5** | **â­ ByteTrackè¿½è¸ªé›†æˆ** | **â­ 3-4å¤©** | **â­ P0** |
| | ä¸‹è½½å¹¶é›†æˆByteTrack C++ä»£ç  | 0.5å¤© | P0 |
| | ä¿®æ”¹CMakeLists.txtã€æ›´æ–°Config | 0.5å¤© | P0 |
| | å®ç°è¿½è¸ªé€»è¾‘ï¼ˆupdateTrackingï¼‰ | 1å¤© | P0 |
| | å®ç°é«˜çº§å‘Šè­¦ï¼ˆåœç•™/å¾˜å¾Šæ£€æµ‹ï¼‰ | 1å¤© | P0 |
| | æµ‹è¯•éªŒè¯ï¼ˆtrack_idç¨³å®šæ€§ï¼‰ | 0.5-1å¤© | P0 |
| **é˜¶æ®µ3** | **å‰ç«¯é›†æˆ** | **2-3å¤©** | **P0** |
| | APIå¯¹æ¥ | 1å¤© | P0 |
| | æ‰©å±•æ‘„åƒå¤´é¡µé¢ | 1å¤© | P0 |
| | ç½‘å…³è·¯ç”±é…ç½® | 0.5å¤© | P0 |
| | æµ‹è¯•éªŒè¯ | 0.5å¤© | P0 |
| **é˜¶æ®µ4** | **è§†é¢‘å¢™** | **1-2å¤©** | **P1** |
| | è§†é¢‘å¢™é¡µé¢å¼€å‘ | 1å¤© | P1 |
| | WebSocketå‘Šè­¦é›†æˆ | 0.5å¤© | P1 |
| | æ€§èƒ½ä¼˜åŒ– | 0.5å¤© | P1 |
| **é˜¶æ®µ5** | **ç³»ç»Ÿæµ‹è¯•** | **2-3å¤©** | **P0** |
| | å•è·¯å®Œæ•´æµç¨‹ | 0.5å¤© | P0 |
| | 10è·¯å¹¶å‘æµ‹è¯• | 1å¤© | P0 |
| | 50è·¯å‹åŠ›æµ‹è¯• | 1å¤© | P0 |
| | æ–‡æ¡£å®Œå–„ | 0.5å¤© | P1 |

---

## ğŸ‰ ç¬¬åä¸€éƒ¨åˆ†ï¼šæ€»ç»“

### æ ¸å¿ƒè®¾è®¡æ€æƒ³

1. **èŒè´£åˆ†ç¦»**ï¼šAIæ¨¡å—è®­ç»ƒæ¨¡å‹ï¼ŒTASKæ¨¡å—ç”Ÿäº§æ¨ç†
2. **åŠŸèƒ½å¤ç”¨**ï¼šä½¿ç”¨ç°æœ‰çš„å‘Šè­¦æ¥å£ã€è§„åˆ™å¼•æ“ã€å‰ç«¯æ¡†æ¶
3. **æ¸è¿›å¼€å‘**ï¼šå…ˆå•è·¯â†’å†å¤šè·¯â†’æœ€åè§†é¢‘å¢™
4. **æ€§èƒ½ä¼˜å…ˆ**ï¼šC++å®ç°ï¼Œå¤šè¿›ç¨‹å¹¶å‘ï¼Œèµ„æºéš”ç¦»

### æŠ€æœ¯é€‰å‹æ­£ç¡®æ€§

- âœ… **C++**: é«˜æ€§èƒ½ï¼Œé€‚åˆå®æ—¶å¤„ç†
- âœ… **ONNX Runtime**: è·¨å¹³å°ï¼Œæ˜“é›†æˆ
- âœ… **FFmpeg**: æˆç†Ÿç¨³å®šï¼Œæ”¯æŒRTMP
- âœ… **cpp-httplib**: è½»é‡HTTPæœåŠ¡å™¨
- âœ… **ZLMediaKit**: é«˜æ€§èƒ½æµåª’ä½“
- âœ… **Vue3 + Ant Design Vue**: ç°ä»£å‰ç«¯æ¡†æ¶

### å®Œæˆåä½ å°†æ‹¥æœ‰

âœ… å‰ç«¯ä¸€é”®å¯åŠ¨50è·¯AIæ£€æµ‹ä»»åŠ¡  
âœ… å®æ—¶è§†é¢‘å¢™å±•ç¤ºï¼ˆ1ç§’å»¶è¿Ÿï¼‰  
âœ… åŒºåŸŸå‘Šè­¦+è§„åˆ™å¼•æ“é›†æˆ  
âœ… å®Œæ•´çš„å•†ç”¨çº§AIè§†é¢‘ç›‘æ§ç³»ç»Ÿ  
âœ… è¾¹ç¼˜ç¦»çº¿éƒ¨ç½²èƒ½åŠ›  
âœ… å¯æ‰©å±•çš„æ¨¡å—åŒ–æ¶æ„

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ç«‹å³å¼€å§‹ï¼ˆæ¨èé¡ºåºï¼‰**:
1. âœ… å®ŒæˆåŒºåŸŸè¿‡æ»¤é€»è¾‘ï¼ˆ0.5å¤©ï¼‰
2. âœ… å¼€å‘TaskManager HTTP APIï¼ˆ2-3å¤©ï¼‰
3. âœ… å‰ç«¯APIå¯¹æ¥ï¼ˆ2-3å¤©ï¼‰
4. âœ… è§†é¢‘å¢™é¡µé¢ï¼ˆ1-2å¤©ï¼‰
5. âœ… 50è·¯å‹åŠ›æµ‹è¯•ï¼ˆ1å¤©ï¼‰

**å‡†å¤‡å¥½å¼€å§‹äº†å—ï¼Ÿ** ğŸš€

---

**æ–‡æ¡£ç»“æŸ** | å¦‚æœ‰ç–‘é—®è¯·å‚è€ƒå„å­æ–‡æ¡£æˆ–æé—®

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 